@page "/admin/users"
@attribute [Authorize(Policy = "RequireSuperAdmin")]
@rendermode InteractiveServer
@attribute [StreamRendering]

@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using ElDesignApp.Components.MyModals
@using System.Text.Json
@using Microsoft.AspNetCore.Authorization
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject IDataRetrievalService DataService
@inject IJSRuntime JS
@inject Services.IMyTableService MyTable
@inject IRoleAuthorizationService RoleAuthService

<PageTitle>User Management</PageTitle>

<h3>User Management</h3>

@if (_isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> @ErrorMessage
    </div>
}
else
{
    <!-- Role Mapping Management Button -->
    <div class="d-flex justify-content-between mb-3">
        <h4>User & Role Management</h4>
        <div>
            <button class="btn btn-info me-2" @onclick="ShowRoleMappingModal">
                <i class="bi bi-gear"></i> Manage Role Mappings
            </button>
            <button class="btn btn-success" @onclick="ShowAddProjectModal">
                <i class="bi bi-plus-lg"></i> Add New Project
            </button>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>Email</th>
                <th>Username</th>
                <th class="text-center">Custom Roles</th>
                <th class="text-center">Mapped Hard Roles</th>
                <th class="text-center">Projects</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var item in usersWithRoles)
            {
                var user = item.User;
                var userCustomRoles = item.Roles; // These are custom roles now
                var currentUserId = item.User.Id;

                <tr>
                    <td><strong>@user.Email</strong></td>
                    <td>@user.UserName</td>
                    
                    <!-- Custom Roles Column -->
                    <td class="text-center py-3">
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            @foreach (var customRole in _activeCustomRoles)
                            {
                                var vm = item;
                                var isAssigned = userCustomRoles.Contains(customRole.CustomRoleName);
                                
                                <button type="button"
                                        class="@(isAssigned ? "btn btn-success" : "btn btn-outline-secondary") btn-sm"
                                        style="min-width: 110px;"
                                        @onclick="async () => await ToggleCustomRoleAsync(currentUserId, customRole.CustomRoleName)"
                                        disabled="@(vm.IsToggling && vm.TogglingRoleName == customRole.CustomRoleName)"
                                        title="@customRole.Description">
                                    @if (vm.IsToggling && vm.TogglingRoleName == customRole.CustomRoleName)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    }
                                    <strong>@customRole.CustomRoleName</strong>
                                    @if (!isAssigned)
                                    {
                                        <small class="ms-1">(off)</small>
                                    }
                                </button>
                            }
                        </div>
                    </td>
                    
                    <!-- Mapped Hard Roles Column (Read-only display) -->
                    <td class="text-center py-3">
                        <div class="d-flex flex-wrap gap-1 justify-content-center">
                            @{
                                var userHardRoles = GetUserHardRoles(userCustomRoles);
                            }
                            @if (userHardRoles.Any())
                            {
                                @foreach (var hardRole in userHardRoles)
                                {
                                    var badgeClass = hardRole switch
                                    {
                                        "SuperAdmin" => "bg-danger",
                                        "Admin" => "bg-warning text-dark",
                                        "User" => "bg-primary",
                                        "Report" => "bg-secondary",
                                        "Guest" => "bg-secondary",
                                        _ => "bg-info"
                                    };
                                    <span class="badge @badgeClass">@hardRole</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted small">No roles</span>
                            }
                        </div>
                    </td>
                    
                    <!-- Projects Column -->
                    <td class="text-center py-3">
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            @{
                                var allProjectTags = _projects.Select(p => p.Tag).Distinct().ToList();
                                var assignedProjectTags = _projects
                                    .Where(p => p.ProjUsers != null && 
                                                JsonSerializer.Deserialize<List<string>>(p.ProjUsers)
                                                    ?.Contains(user.UserName!) == true)
                                    .Select(p => p.Tag)
                                    .Distinct()
                                    .ToList();

                                var notAssignedProjectTags = allProjectTags.Except(assignedProjectTags).ToList();
                            }

                            <!-- Assigned Projects -->
                            @foreach (var tag in assignedProjectTags)
                            {
                                var hoverKey = GetHoverKey(currentUserId, tag);
    
                                <button type="button"
                                        class="btn btn-outline-info btn-sm position-relative"
                                        style="min-width: 110px;"
                                        @onmouseover="() => SetHover(currentUserId, tag, true)"
                                        @onmouseout="() => SetHover(currentUserId, tag, false)"
                                        @onclick="async () => await RemoveProjectAsync(currentUserId, tag)">
        
                                    <span class="@(IsHovered(currentUserId, tag) ? "text-danger fw-bold" : "")">
                                        @tag
                                    </span>
        
                                    @if (IsHovered(currentUserId, tag))
                                    {
                                        <small class="ms-1 text-danger fw-bold">Ã—</small>
                                    }
                                </button>
                            }

                            <!-- Add Project Button -->
                            @if (notAssignedProjectTags.Count > 0)
                            {
                                <button type="button"
                                        class="btn btn-success btn-sm"
                                        style="min-width: 110px;"
                                        @onclick="() => showProjectDropdown[currentUserId] = !showProjectDropdown.GetValueOrDefault(currentUserId)">
                                    <i class="bi bi-plus"></i> Add Project
                                </button>

                                @if (showProjectDropdown.GetValueOrDefault(currentUserId))
                                {
                                    <div class="mt-2">
                                        <select class="form-select form-select-sm"
                                                @onchange="async e => await AddProjectSelected(e, currentUserId)">
                                            <option value="" disabled selected>Select project...</option>
                                            @foreach (var tag in notAssignedProjectTags)
                                            {
                                                var p = _projects.Find(x => x.Tag == tag);
                                                <option value="@tag">@tag | @(p?.TagDescription ?? "")</option>
                                            }
                                        </select>
                                        <button class="btn btn-secondary btn-sm mt-1"
                                                @onclick="() => showProjectDropdown[currentUserId] = false">
                                            Cancel
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                    </td>
                    
                    <!-- Actions -->
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm" 
                                @onclick="() => ConfirmDeleteUser(user)">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    
    <!-- Add User Button -->
    <div class="mt-4 text-center">
        <button class="btn btn-primary btn-lg" @onclick="ShowAddUserModal">
            <i class="bi bi-person-plus"></i> Add New User
        </button>
    </div>
    
    <!-- Add User Modal -->
    @if (showAddUserModal)
    {
        <ElementPropertyModal T="ApplicationUser"
                              Title="Create New User"
                              Item="_newUser"
                              Fields="_userFields"
                              OnClose="HandleAddUserClose" />
    }
    
    <!-- Add Project Modal -->
    @if (_showProjectModal)
    {
        <ElementPropertyModal T="Project" 
                              Title="Add New Project" 
                              Item="@_newProject" 
                              Fields="_projectFields"
                              OnClose="@HandleProjectModalClose" />
    }
    
    <!-- Role Mapping Management Modal -->
    @if (_showRoleMappingModal)
    {
        <Rolemappingmodal OnClose="HandleRoleMappingModalClose" />
    }
}

@code {
    private bool _isLoading = true;
    private List<RoleMapping> _allRoleMappings = new();
    private List<RoleMapping> _activeCustomRoles = new();
    private List<Project> _projects = new();
    private List<UserRoleViewModel> usersWithRoles = new();
    private string? ErrorMessage;
    
    private readonly Dictionary<string, bool> showProjectDropdown = new();
    private readonly HashSet<string> hoveredProjects = new();
    
    private bool showAddUserModal = false;
    private ApplicationUser _newUser = new();
    private readonly string[] _userFields = ["UserName", "Email"];
    
    private bool _showProjectModal = false;
    private Project _newProject = new();
    private readonly string[] _projectFields = new[]
    {
        "Tag", "TagDescription", "ProjAlt", "ProjClient", "ProjPartners",
        "ProjLocation", "ProjUsers", "Display", "XEW", "GlobalE", "GlobalN"
    };
    
    private bool _showRoleMappingModal = false;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadRoleMappings();
            await LoadUsersAndRoles();
            await LoadProjects();
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error loading data: " + ex.Message;
            System.Diagnostics.Debug.WriteLine($"OnInitializedAsync Error: {ex}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadRoleMappings()
    {
        try
        {
            _allRoleMappings = await RoleAuthService.GetAllRoleMappings();
            _activeCustomRoles = _allRoleMappings.Where(m => m.IsActive).ToList();
            
            // Ensure all custom roles exist in Identity
            foreach (var mapping in _activeCustomRoles)
            {
                if (!await RoleManager.RoleExistsAsync(mapping.CustomRoleName))
                {
                    await RoleManager.CreateAsync(new IdentityRole(mapping.CustomRoleName));
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadRoleMappings Error: {ex.Message}");
            throw;
        }
    }

    private async Task LoadUsersAndRoles()
    {
        try
        {
            usersWithRoles.Clear();
            var users = await UserManager.Users.OrderBy(u => u.Email).ToListAsync();

            foreach (var user in users)
            {
                var roles = await UserManager.GetRolesAsync(user);
                usersWithRoles.Add(new UserRoleViewModel
                {
                    User = user,
                    Roles = roles.ToList(), // These are custom roles
                    IsToggling = false,
                    TogglingRoleName = null
                });
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadUsersAndRoles Error: {ex.Message}");
            throw;
        }
    }

    private async Task LoadProjects()
    {
        try
        {
            var result = await DataService.ReadFromCacheOrDb(new Project());
            _projects = result.Item1;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadProjects Error: {ex.Message}");
            throw;
        }
    }

    private List<string> GetUserHardRoles(List<string> userCustomRoles)
    {
        var hardRoles = new HashSet<string>();
        
        foreach (var customRole in userCustomRoles)
        {
            var mapping = _allRoleMappings.FirstOrDefault(m => 
                m.CustomRoleName.Equals(customRole, StringComparison.OrdinalIgnoreCase) && m.IsActive);
            
            if (mapping != null)
            {
                try
                {
                    var mappedRoles = JsonSerializer.Deserialize<List<string>>(mapping.MappedHardRoles);
                    if (mappedRoles != null)
                    {
                        foreach (var role in mappedRoles)
                        {
                            hardRoles.Add(role);
                        }
                    }
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"Error deserializing roles for {customRole}: {ex.Message}");
                }
            }
        }
        
        return hardRoles.OrderBy(r => r).ToList();
    }

    private async Task ToggleCustomRoleAsync(string userId, string customRoleName)
    {
        var userViewModel = usersWithRoles.FirstOrDefault(x => x.User.Id == userId);
        if (userViewModel == null) return;
        
        userViewModel.IsToggling = true;
        userViewModel.TogglingRoleName = customRoleName;
        StateHasChanged();

        try
        {
            var user = userViewModel.User;
            bool isInRole = userViewModel.Roles.Contains(customRoleName);

            IdentityResult result;
            if (isInRole)
            {
                result = await UserManager.RemoveFromRoleAsync(user, customRoleName);
                if (result.Succeeded)
                {
                    userViewModel.Roles.Remove(customRoleName);
                }
            }
            else
            {
                result = await UserManager.AddToRoleAsync(user, customRoleName);
                if (result.Succeeded)
                {
                    userViewModel.Roles.Add(customRoleName);
                }
            }

            if (!result.Succeeded)
            {
                var errors = string.Join("; ", result.Errors.Select(e => e.Description));
                await JS.InvokeVoidAsync("alert", $"Failed to toggle role: {errors}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error toggling role: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"ToggleCustomRoleAsync Error: {ex}");
        }
        finally
        {
            userViewModel.IsToggling = false;
            StateHasChanged();
        }
    }

    // Project Management Methods
    private string GetHoverKey(string userId, string projectTag) => $"{userId}|{projectTag}";
    
    private void SetHover(string userId, string projectTag, bool isHovered)
    {
        var key = GetHoverKey(userId, projectTag);
        if (isHovered)
            hoveredProjects.Add(key);
        else
            hoveredProjects.Remove(key);
        StateHasChanged();
    }
    
    private bool IsHovered(string userId, string projectTag) => 
        hoveredProjects.Contains(GetHoverKey(userId, projectTag));

    private async Task AddProjectSelected(ChangeEventArgs e, string userId)
    {
        var selectedTag = e.Value?.ToString();
        if (string.IsNullOrEmpty(selectedTag)) return;

        await AddProjectAsync(userId, selectedTag);
        showProjectDropdown[userId] = false;
        StateHasChanged();
    }

    private async Task AddProjectAsync(string userId, string projectTag)
    {
        if (string.IsNullOrEmpty(projectTag)) return;

        try
        {
            var project = _projects.FirstOrDefault(p => p.Tag == projectTag);
            if (project == null) return;

            var user = usersWithRoles.FirstOrDefault(u => u.User.Id == userId)?.User;
            if (user == null || string.IsNullOrEmpty(user.UserName)) return;

            var userList = string.IsNullOrEmpty(project.ProjUsers)
                ? new List<string>()
                : JsonSerializer.Deserialize<List<string>>(project.ProjUsers) ?? new List<string>();

            if (!userList.Contains(user.UserName))
            {
                userList.Add(user.UserName);
                project.ProjUsers = JsonSerializer.Serialize(userList);
                await MyTable.UpdateParameter(project, project.UID, ["ProjUsers"]);
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error adding project: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"AddProjectAsync Error: {ex}");
        }
    }

    private async Task RemoveProjectAsync(string userId, string selectedProjectName)
    {
        try
        {
            var selectedProject = _projects.Find(p => p.Tag == selectedProjectName);
            if (selectedProject == null) return;

            var userList = string.IsNullOrEmpty(selectedProject.ProjUsers)
                ? new List<string>()
                : JsonSerializer.Deserialize<List<string>>(selectedProject.ProjUsers) ?? new List<string>();

            var user = usersWithRoles.First(u => u.User.Id == userId).User;
            userList.RemoveAll(u => u == user.UserName);

            selectedProject.ProjUsers = JsonSerializer.Serialize(userList);
            await MyTable.UpdateParameter(selectedProject, selectedProject.UID, ["ProjUsers"]);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error removing project: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"RemoveProjectAsync Error: {ex}");
        }
    }

    // User Management
    private void ShowAddUserModal()
    {
        _newUser = new ApplicationUser();
        showAddUserModal = true;
    }

    private async Task HandleAddUserClose((string ItemJson, string Type, string OriginalTag, string CurrentTag, string Action) result)
    {
        showAddUserModal = false;
        if (result.Action != "Ok" || string.IsNullOrWhiteSpace(result.ItemJson))
        {
            StateHasChanged();
            return;
        }

        try
        {
            var options = new JsonSerializerOptions { IncludeFields = true };
            var user = JsonSerializer.Deserialize<ApplicationUser>(result.ItemJson, options);
            
            if (user?.UserName == null || user.Email == null)
            {
                await JS.InvokeVoidAsync("alert", "Username and Email are required");
                return;
            }

            var createResult = await UserManager.CreateAsync(user, "MyPwd@123"); // Consider making password configurable
            
            if (createResult.Succeeded)
            {
                await LoadUsersAndRoles();
                await JS.InvokeVoidAsync("alert", "User created successfully!");
            }
            else
            {
                ErrorMessage = string.Join("; ", createResult.Errors.Select(e => e.Description));
                await JS.InvokeVoidAsync("alert", $"Error creating user: {ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"HandleAddUserClose Error: {ex}");
        }

        StateHasChanged();
    }

    private async Task ConfirmDeleteUser(ApplicationUser user)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete user '{user.UserName}'?");
        
        if (confirmed)
        {
            try
            {
                await UserManager.DeleteAsync(user);
                await LoadUsersAndRoles();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error deleting user: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"ConfirmDeleteUser Error: {ex}");
            }
        }
    }

    // Project Management
    private void ShowAddProjectModal()
    {
        _newProject = new Project
        {
            Tag = $"PROJ-{DateTime.Now:yyyyMMddHHmmss}",
            TagDescription = "New project - please update description",
            UID = Guid.NewGuid(),
            Display = true
        };
        _showProjectModal = true;
    }

    private async Task HandleProjectModalClose((string ItemJson, string Type, string OriginalTag, string CurrentTag, string Action) result)
    {
        _showProjectModal = false;
        if (result.Action != "Ok" || string.IsNullOrWhiteSpace(result.ItemJson))
        {
            StateHasChanged();
            return;
        }

        try
        {
            var options = new JsonSerializerOptions 
            { 
                PropertyNameCaseInsensitive = true,
                IncludeFields = true 
            };
            
            var project = JsonSerializer.Deserialize<Project>(result.ItemJson, options);

            if (project == null || string.IsNullOrWhiteSpace(project.Tag))
            {
                await JS.InvokeVoidAsync("alert", "Project Code is required");
                return;
            }

            // Check if project already exists
            bool exists = _projects.Any(p => p.Tag.Equals(project.Tag, StringComparison.OrdinalIgnoreCase));
            
            if (exists)
            {
                await JS.InvokeVoidAsync("alert", $"Project '{project.Tag}' already exists!");
                return;
            }

            project.UID = Guid.NewGuid();
            project.Order = _projects.Count;
            
            int rows = await MyTable.InsertItemAsync(project);
            
            if (rows > 0)
            {
                await JS.InvokeVoidAsync("alert", "Project created successfully!");
                await LoadProjects();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to create project");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"HandleProjectModalClose Error: {ex}");
        }

        StateHasChanged();
    }

    // Role Mapping Management
    private void ShowRoleMappingModal()
    {
        _showRoleMappingModal = true;
    }

    private async Task HandleRoleMappingModalClose()
    {
        _showRoleMappingModal = false;
        await LoadRoleMappings(); // Reload mappings in case they changed
        StateHasChanged();
    }

    // Helper class
    public class UserRoleViewModel
    {
        public required ApplicationUser User { get; set; }
        public List<string> Roles { get; set; } = new(); // Custom roles
        public bool IsToggling { get; set; }
        public string? TogglingRoleName { get; set; }
    }
}
