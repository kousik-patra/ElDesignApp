@page "/admin/users"
@attribute [Authorize(Policy = "RequireAdmin")]

@rendermode InteractiveServer
@attribute [StreamRendering]

@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using ElDesignApp.Components.MyModals
@using System.Text.Json
@using Microsoft.AspNetCore.Authorization
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject IDataRetrievalService DataService
@inject IJSRuntime JS
@inject ITableService Table
@inject IRoleAuthorizationService RoleAuthService
@inject IProjectContextService ProjectContext
@inject AuthenticationStateProvider AuthState
@inject IDefaultRoleSeederService RoleSeeder
@inject IDataRetrievalService DataRetrievalService

<PageTitle>User Management</PageTitle>

<h3>User Management</h3>

@if (_isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> @ErrorMessage
    </div>
}
else
{
    <!-- Top Action Buttons -->
    <div class="d-flex justify-content-between mb-3">
        <h4>User & Project Management</h4>
        <div>
            <button class="btn btn-warning me-2" @onclick="SeedAllExistingProjects">
                <i class="bi bi-database-fill-up"></i> Seed Roles for All Projects
            </button>
            <button class="btn btn-success" @onclick="ShowAddProjectModal">
                <i class="bi bi-plus-lg"></i> Add New Project
            </button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label class="form-label fw-bold">Filter by Project:</label>
                </div>
                <div class="col-auto">
                    <select class="form-select" @bind="_selectedProjectFilter" @bind:after="StateHasChanged">
                        <option value="">All Projects</option>
                        @foreach (var project in _projects.OrderBy(p => p.Tag))
                        {
                            
                            <option value="@project.UID">@project.Tag - @project.TagDescription</option>
                        }
                    </select>
                </div>
                <div class="col-auto">
                    <label class="form-label fw-bold">Search User:</label>
                </div>
                <div class="col-auto">
                    <input type="text" 
                           class="form-control" 
                           placeholder="Username or email..." 
                           @bind="_userSearchFilter" 
                           @bind:after="StateHasChanged"/>
                </div>
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>Email</th>
                <th>Username</th>
                <th class="text-center">Projects & Roles</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var item in GetFilteredUsers())
            {
                var user = item.User;
                var currentUserId = item.User.Id;

               
                <tr>
                    <td><strong>@user.Email</strong></td>
                    <td>@user.UserName</td>
 
                    <!-- Projects & Roles Column -->
                    <td class="py-3">
                        @{
                            var userAssignments = _projectAssignments
                                .Where(pa => pa.UserId == currentUserId && pa.IsActive)
                                .ToList();
                        }
                        
                        @if (!userAssignments.Any())
                        {
                            <div class="text-center">
                                <span class="text-muted small">No projects assigned</span>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex flex-column gap-2">
                                @foreach (var assignment in userAssignments)
                                {
                                    var project = _projects.FirstOrDefault(p => p.UID == assignment.ProjectId);
                                    if (project != null)
                                    {
                                        <div class="border rounded p-2 bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="flex-grow-1">
                                                    <strong class="text-primary">@project.Tag</strong>
                                                    <small class="text-muted d-block">@project.TagDescription</small>
                                                    
                                                    <div class="mt-1">
                                                        @if (assignment.IsProjectAdmin)
                                                        {
                                                            <span class="badge bg-success me-1">
                                                                <i class="bi bi-shield-check"></i> Admin
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary me-1">
                                                                <i class="bi bi-person"></i> Member
                                                            </span>
                                                        }
                                                        
                                                        @* Show user's custom roles in this project *@
                                                        @{
                                                            var userRoles = _projectUserRoles
                                                                .Where(pur => pur.UserId == currentUserId && 
                                                                             pur.ProjectId == project.UID && 
                                                                             pur.IsActive)
                                                                .Select(pur => pur.CustomRoleName)
                                                                .ToList();
                                                        }
                                                        
                                                        @foreach (var role in userRoles)
                                                        {
                                                            <span class="badge bg-info">@role</span>
                                                        }
                                                    </div>
                                                </div>
                                                
                                                <div class="btn-group-vertical btn-group-sm ms-2">
                                                    <button class="btn btn-sm @(assignment.IsProjectAdmin ? "btn-warning" : "btn-outline-warning")" 
                                                            @onclick="async () => await ToggleProjectAdminAsync(currentUserId, project.UID)"
                                                            title="@(assignment.IsProjectAdmin ? "Remove Admin" : "Make Admin")">
                                                        <i class="bi @(assignment.IsProjectAdmin ? "bi-shield-fill-check" : "bi-shield")"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            @onclick="async () => await RemoveFromProjectAsync(currentUserId, project.UID)"
                                                            title="Remove from project">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </td>

                    <!-- Actions Column -->
                    <td>

                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary dropdown-toggle"
                                        type="button"
                                        @onclick="@(() => ToggleDropdown($"assign_{user.Id}"))">
                                    <i class="bi bi-building-add"></i> Assign Project
                                </button>
                            </div>
                        <!-- Assign to Project Dropdown -->
                        @if (_openDropdowns.GetValueOrDefault($"assign_{user.Id}", false))
                        {
                            <div class="dropdown-menu show position-absolute" style="z-index: 1050;">
                                @{
                                    var unassignedProjects = _projects
                                        .Where(p => !_projectAssignments.Any(pa =>
                                            pa.UserId == user.Id &&
                                            pa.ProjectId == p.UID &&
                                            pa.IsActive))
                                        .OrderBy(p => p.Tag)
                                        .ToList();
                                }

                                @if (!unassignedProjects.Any())
                                {
                                    <div class="dropdown-item text-muted">
                                        <i class="bi bi-info-circle"></i> User assigned to all projects
                                    </div>
                                }
                                else
                                {
                                    @foreach (var project in unassignedProjects)
                                    {
                                        <button class="dropdown-item"
                                                @onclick="async () => await AssignToProjectAsync(user.Id, project.UID)">
                                            <i class="bi bi-plus-circle"></i> @project.Tag - @project.TagDescription
                                        </button>
                                    }
                                }
                            </div>
                        }

                        <button class="btn btn-sm btn-danger ms-2"
                                @onclick="async () => await ConfirmDeleteUser(user)">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
}

<!-- Add Project Modal -->
@if (_showProjectModal && _newProject != null)
{
    <ElementPropertyModal 
        T="Project"
        Title="Add New Project"
        Item="@_newProject"
        OnClose="HandleProjectModalClose" />
}





@code {
    private List<UserRoleViewModel> _users = new();
    private List<Project> _projects = new();
    private List<ProjectUserAssignment> _projectAssignments = new();
    private List<ProjectUserRole> _projectUserRoles = new();
    private bool _isLoading = true;
    private string ErrorMessage = string.Empty;
    
    private string _selectedProjectFilter = string.Empty;
    private string _userSearchFilter = string.Empty;
    private Dictionary<string, bool> _openDropdowns = new();
    
    private bool _showProjectModal = false;
    private Project? _newProject;
    private string _currentUserId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthState.GetAuthenticationStateAsync();
            _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
            
            await LoadProjects();
            await LoadUsersAndRoles();
            await LoadProjectAssignments();
            await LoadProjectUserRoles();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to load data: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"OnInitializedAsync Error: {ex}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadProjects()
    {
        try
        {
            var result = await DataService.ReadFromCacheOrDb<Project>( );
            _projects = result.Item1.Where(p => p.Display).OrderBy(p => p.Tag).ToList();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadProjects Error: {ex}");
        }
    }

    private async Task LoadUsersAndRoles()
    {
        try
        {
            var allUsers = await UserManager.Users.ToListAsync();
            _users = allUsers.Select(u => new UserRoleViewModel
            {
                User = u,
                Roles = new List<string>()
            }).ToList();

            foreach (var userVm in _users)
            {
                userVm.Roles = (await UserManager.GetRolesAsync(userVm.User)).ToList();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadUsersAndRoles Error: {ex}");
        }
    }

    private async Task LoadProjectAssignments()
    {
        try
        {
            var result = await DataService.ReadFromCacheOrDb<ProjectUserAssignment>();
            _projectAssignments = result.Item1;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadProjectAssignments Error: {ex}");
        }
    }

    private async Task LoadProjectUserRoles()
    {
        try
        {
            var result = await DataService.ReadFromCacheOrDb<ProjectUserRole>();
            _projectUserRoles = result.Item1;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadProjectUserRoles Error: {ex}");
        }
    }

    private IEnumerable<UserRoleViewModel> GetFilteredUsers()
    {
        var filtered = _users.AsEnumerable();

        // Filter by project
        if (!string.IsNullOrEmpty(_selectedProjectFilter) && Guid.TryParse(_selectedProjectFilter, out var projectGuid))
        {
            var usersInProject = _projectAssignments
                .Where(pa => pa.ProjectId == projectGuid && pa.IsActive)
                .Select(pa => pa.UserId)
                .ToHashSet();

            filtered = filtered.Where(u => usersInProject.Contains(u.User.Id));
        }

        // Filter by search text
        if (!string.IsNullOrWhiteSpace(_userSearchFilter))
        {
            var searchLower = _userSearchFilter.ToLower();
            filtered = filtered.Where(u =>
                (u.User.UserName?.ToLower().Contains(searchLower) ?? false) ||
                (u.User.Email?.ToLower().Contains(searchLower) ?? false));
        }

        return filtered;
    }

    private async Task AssignToProjectAsync(string userId, Guid projectId)
    {
        try
        {
            var assignment = new ProjectUserAssignment
            {
                UID = Guid.NewGuid(),
                ProjectId = projectId,
                UserId = userId,
                IsProjectAdmin = false,
                IsActive = true,
                AssignedBy = _currentUserId,
                AssignedOn = DateTime.Now
            };

            await Table.InsertAsync(assignment);
            
            // RefreshParentCallback cache
            await DataService.RefreshCache();
            
            await LoadProjectAssignments();
            ToggleDropdown($"assign_{userId}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"AssignToProjectAsync Error: {ex}");
        }
    }

    private async Task RemoveFromProjectAsync(string userId, Guid projectId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", 
            "Remove user from this project? This will also remove their roles.");
        
        if (!confirmed) return;

        try
        {
            var assignment = _projectAssignments
                .FirstOrDefault(pa => pa.UserId == userId && pa.ProjectId == projectId && pa.IsActive);
            
            if (assignment == null) return;

            assignment.IsActive = false;
            assignment.RemovedBy = _currentUserId;
            assignment.RemovedOn = DateTime.Now;

            await Table.UpdateFieldsByUidAsync(assignment, assignment.UID,
                [nameof(assignment.IsActive), nameof(assignment.RemovedBy), nameof(assignment.RemovedOn)]);

            // RefreshParentCallback cache
            await DataService.RefreshCache();
            
            await LoadProjectAssignments();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"RemoveFromProjectAsync Error: {ex}");
        }
    }

    private async Task ToggleProjectAdminAsync(string userId, Guid projectId)
    {
        try
        {
            var assignment = _projectAssignments
                .FirstOrDefault(pa => pa.UserId == userId && pa.ProjectId == projectId && pa.IsActive);
            
            if (assignment == null) return;

            assignment.IsProjectAdmin = !assignment.IsProjectAdmin;

            await Table.UpdateFieldsByUidAsync(assignment, assignment.UID,
                [nameof(assignment.IsProjectAdmin)]);

            // RefreshParentCallback cache
            await DataService.RefreshCache();
            
            // Reload assignments
            await LoadProjectAssignments();
            
            // Force UI update
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"ToggleProjectAdminAsync Error: {ex}");
        }
    }

    private void ToggleDropdown(string key)
    {
        if (_openDropdowns.ContainsKey(key))
            _openDropdowns[key] = !_openDropdowns[key];
        else
            _openDropdowns[key] = true;
    }

    // Project Management
    private void ShowAddProjectModal()
    {
        _newProject = new Project
        {
            Tag = $"PROJ-{DateTime.Now:yyyyMMddHHmmss}",
            TagDescription = "New project - please update description",
            UID = Guid.NewGuid(),
            Display = true
        };
        _showProjectModal = true;
    }

    private void CloseProjectModal()
    {
        _showProjectModal = false;
        StateHasChanged();
    }

    private async Task HandleProjectModalClose((string ItemJson, string Type, string OriginalTag, string CurrentTag, string Action) result)
    {
        _showProjectModal = false;
        if (result.Action != "Ok" || string.IsNullOrWhiteSpace(result.ItemJson))
        {
            StateHasChanged();
            return;
        }

        try
        {
            var options = new JsonSerializerOptions 
            { 
                PropertyNameCaseInsensitive = true,
                IncludeFields = true 
            };
            
            var project = JsonSerializer.Deserialize<Project>(result.ItemJson, options);

            if (project == null || string.IsNullOrWhiteSpace(project.Tag))
            {
                await JS.InvokeVoidAsync("alert", "Project Code is required");
                return;
            }

            // Check if project already exists
            bool exists = _projects.Any(p => p.Tag.Equals(project.Tag, StringComparison.OrdinalIgnoreCase));
            
            if (exists)
            {
                await JS.InvokeVoidAsync("alert", $"Project '{project.Tag}' already exists!");
                return;
            }

            project.UID = Guid.NewGuid();
            project.Order = _projects.Count;
            
            int rows = await Table.InsertAsync(project);
            
            if (rows > 0)
            {
                // SEED DEFAULT ROLES USING THE SERVICE
                try
                {
                    await RoleSeeder.SeedDefaultRolesForProjectAsync(project.UID);
                    await JS.InvokeVoidAsync("alert", $"Project '{project.Tag}' created successfully with default roles!");
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"Role seeding error: {ex.Message}");
                    await JS.InvokeVoidAsync("alert", $"Project created but role seeding failed: {ex.Message}");
                }
                
                // RefreshParentCallback cache to show new data
                await DataService.RefreshCache();
                await LoadProjects();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to create project");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"HandleProjectModalClose Error: {ex}");
        }

        StateHasChanged();
    }

    // NEW: Seed all existing projects (one-time migration)
    private async Task SeedAllExistingProjects()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", 
            "This will create default roles for all projects that don't have them yet. Continue?");
        
        if (!confirmed) return;

        try
        {
            int projectsSeeded = 0;
            
            foreach (var project in _projects)
            {
                try
                {
                    await RoleSeeder.SeedDefaultRolesForProjectAsync(project.UID);
                    projectsSeeded++;
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"Error seeding project {project.Tag}: {ex.Message}");
                }
            }
            
            // RefreshParentCallback cache to show new data
            await DataService.RefreshCache();
            
            await JS.InvokeVoidAsync("alert", $"Successfully seeded default roles for {projectsSeeded} projects!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error seeding projects: {ex.Message}");
        }
    }

private async Task ConfirmDeleteUser(ApplicationUser user)
{
    var confirmed = await JS.InvokeAsync<bool>("confirm", 
        $"⚠️ WARNING: Delete user '{user.UserName}'?\n\n" +
        $"This will PERMANENTLY remove:\n" +
        $"• User account\n" +
        $"• All project assignments\n" +
        $"• All role mappings\n\n" +
        $"This action CANNOT be undone!");
    
    if (!confirmed) return;

    try
    {
        Console.WriteLine($"=== DELETING USER: {user.UserName} (ID: {user.Id}) ===");
        
        // Step 1: Get and delete ProjectUserRole records
        var roleAssignmentsTable = await Table.GetListAsync<ProjectUserRole>( null);
        var roleAssignments = roleAssignmentsTable
            .Where(r => r.UserId == user.Id || r.AssignedBy == user.Id)
            .ToList();
        
        Console.WriteLine($"Found {roleAssignments.Count} role assignments to delete");
        
        foreach ( var roleAssignment in roleAssignments)
        {
            var success = await Table.DeleteAsync(roleAssignment);
            if (success == 0) Console.WriteLine($"Delete RoleAssignments unsuccessful.");
        }
        
        // Step 2: Get and delete ProjectUserAssignment records
        var projectAssignmentsTable = await Table.GetListAsync<ProjectUserAssignment>( null);
        var userAssignments = projectAssignmentsTable
            .Where(pa => pa.UserId == user.Id || pa.AssignedBy == user.Id)
            .ToList();
        
        Console.WriteLine($"Found {userAssignments.Count} project assignments to delete");
        
        foreach (var assignment in userAssignments)
        {
            var success = await Table.DeleteAsync(assignment);
            if (success == 0) Console.WriteLine($"Delete UserAssignments unsuccessful.");
        }
        
        // Step 3: Delete the user from Identity
        Console.WriteLine($"Deleting user from AspNetUsers...");
        var result = await UserManager.DeleteAsync(user);
        
        if (!result.Succeeded)
        {
            var errors = string.Join(", ", result.Errors.Select(e => e.Description));
            throw new Exception($"Failed to delete user: {errors}");
        }
        
        Console.WriteLine($"User {user.UserName} deleted successfully");
        
        // Step 4: Clear caches
        await ClearCacheForTable("ProjectUserAssignment");
        await ClearCacheForTable("ProjectUserRole");
        
        // Step 5: Reload UI data
        await LoadUsersAndRoles();
        await LoadProjectAssignments();
        
        StateHasChanged();
        
        await JS.InvokeVoidAsync("alert", $"User '{user.UserName}' deleted successfully!");
        
        Console.WriteLine("=== DELETE COMPLETE ===");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"!!! ERROR DELETING USER !!!");
        Console.WriteLine($"Message: {ex.Message}");
        Console.WriteLine($"Stack trace: {ex.StackTrace}");
        await JS.InvokeVoidAsync("alert", $"Error deleting user: {ex.Message}");
    }
}

private async Task ClearCacheForTable(string tableName)
{
    try
    {
        // If you have a DataRetrievalService for cache invalidation
        if (DataRetrievalService != null)
        {
            await DataRetrievalService.InvalidateCacheAsync(tableName);
            Console.WriteLine($"Cache cleared for {tableName}");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error clearing cache for {tableName}: {ex.Message}");
    }
}
    
    
    // Helper class
    public class UserRoleViewModel
    {
        public required ApplicationUser User { get; set; }
        public List<string> Roles { get; set; } = new();
        public bool IsToggling { get; set; }
        public string? TogglingRoleName { get; set; }
    }
}
