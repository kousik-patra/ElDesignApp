@page "/admin/users"
@attribute [Authorize(Roles = "SuperAdmin")]
@rendermode InteractiveServer
@attribute [StreamRendering]

@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject IDataRetrievalService DataService
@inject IJSRuntime JS
@using ElDesignApp.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject Services.IMyTableService MyTable 


<PageTitle>User Management</PageTitle>

<h3>User Management</h3>

@if (_allRoles == null || usersWithRoles == null)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>Email</th>
                <th>Username</th>
                <th class="text-center">Roles</th>
                <th class="text-center">Projects</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var item in usersWithRoles)
            {
                var user = item.User;
                var userRoles = item.Roles;
                var currentUserId = item.User.Id;

                <tr>
                    <td><strong>@user.Email</strong></td>
                    <td>@user.UserName</td>
                    <td class="text-center py-3">
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            @foreach (var role in _allRoles!)
                            {
                                var currentRoleName = role.Name!;
                                var vm = item; // viewmodel for toggling state
                                <button type="button"
                                        class="@(userRoles.Contains(currentRoleName) ? "btn btn-success" : "btn btn-outline-secondary") btn-sm"
                                        style="min-width: 110px;"
                                        @onclick="async () => await ToggleRoleAsync(currentUserId, currentRoleName)"
                                        disabled="@(vm.IsToggling && vm.TogglingRoleName == currentRoleName)">
                                    @if (vm.IsToggling && vm.TogglingRoleName == currentRoleName)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    }
                                    <strong>@currentRoleName</strong>
                                    @if (!userRoles.Contains(currentRoleName))
                                    {
                                        <small class="ms-1">(off)</small>
                                    }
                                </button>
                            }
                        </div>
                    </td>
                    
                    <td class="text-center py-3">
                        <div class="d-flex flex-wrap gap-2 justify-content-center">

                            @{
                                var allProjectTags = _projects.Select(p => p.Tag).Distinct().ToList();
                                var assignedProjectTags = _projects
                                    .Where(p => p.ProjUsers != null && 
                                                JsonSerializer.Deserialize<List<string>>(p.ProjUsers)
                                                    .Contains(user.UserName!))
                                    .Select(p => p.Tag)
                                    .Distinct()
                                    .ToList();

                                var notAssignedProjectTags = allProjectTags.Except(assignedProjectTags).ToList();
                            }

                            <!-- Assigned Projects (Info Outline → Red on Hover) -->
                            @foreach (var tag in assignedProjectTags)
                            {
                                var project = _projects.Find(p => p.Tag == tag);
                                var hoverKey = GetHoverKey(currentUserId, tag);
    
                                <button type="button"
                                        class="btn btn-outline-info btn-sm position-relative"
                                        style="min-width: 110px;"
                                        @onmouseover="() => SetHover(currentUserId, tag, true)"
                                        @onmouseout="() => SetHover(currentUserId, tag, false)"
                                        @onclick="async () => await RemoveProjectAsyn(currentUserId, tag)">
        
                                    <span class="@(IsHovered(currentUserId, tag) ? "text-danger fw-bold" : "")">
                                        @tag
                                    </span>
        
                                    @if (IsHovered(currentUserId, tag))
                                    {
                                        <small class="ms-1 text-danger fw-bold">×</small>
                                    }
                                </button>
                            }

                            <!-- Add Project Button (Green) -->
                            @if (notAssignedProjectTags.Count > 0)
                            {
                                <button type="button"
                                        class="btn btn-success btn-sm"
                                        style="min-width: 110px;"
                                        @onclick="() => showProjectDropdown[currentUserId] = !showProjectDropdown.GetValueOrDefault(currentUserId)">
                                    Add Project
                                </button>

                                @if (showProjectDropdown.GetValueOrDefault(currentUserId))
                                {
                                    <div class="mt-2">
                                        <select class="form-select form-select-sm"
                                                @onchange="async e => await AddProjectSelected(e, currentUserId)">
                                            <option value="" disabled selected>Select project...</option>
                                            @foreach (var tag in notAssignedProjectTags)
                                            {
                                                var p = _projects.Find(x => x.Tag == tag);
                                                <option value="@tag">@tag | @(p?.TagDescription ?? "")</option>
                                            }
                                        </select>
                                        <button class="btn btn-secondary btn-sm mt-1"
                                                @onclick="() => showProjectDropdown[currentUserId] = false">
                                            Cancel
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                    </td>
                    
                    @* Remove User *@
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm" 
                                @onclick="() => ConfirmDeleteUser(user)">
                            Remove User
                        </button>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    
    <!-- ADD USER button (below the table) -->
    <div class="mt-4 text-center">
        <button class="btn btn-primary btn-lg" @onclick="ShowAddUserModal">
            Add New User
        </button>
    </div>
    <!-- Add-User Modal -->
    @if (showAddUserModal)
    {
        <ElementPropertyModal T="ApplicationUser"
                              Title="Create New User"
                              Item="_newUser"
                              Fields="_userFields"
                              OnClose="HandleAddUserClose" />
    }
    
    <!-- Add-Project Modal -->
    @if (_showModal)
    {
        <ElementPropertyModal T="Project" 
                              Title="Add New Project" 
                              Item="@_newProject" 
                              Fields="_fields"
                              OnClose="@HandleModalClose" />
    }
    <div class="col-auto">
        <button class="btn btn-primary" @onclick="ShowAddProjectModal">Add</button>
    </div>
}

@code {
    private List<IdentityRole>? _allRoles;
    private List<Project> _projects = [];
    private List<string> _projectNames = [];
    private List<UserRoleViewModel> usersWithRoles = new();
    private string? ErrorMessage;
    
    private readonly Dictionary<string, bool> showProjectDropdown = new(); // userId → dropdown visible?
    private readonly HashSet<string> hoveredProjects = new(); // "userId|projectTag"
    
    
    private bool showAddUserModal = false;
    private ApplicationUser _newUser = new();
    private readonly string[] _userFields = ["UserName", "Email"]; // only these are editable
    
    bool _showModal = false;
    Project _newProject = new Project();
    readonly string[] _fields = ["Tag", "TagDescription", "ProjAlt", "ProjClient", "ProjPartners", "ProjLocation", "ProjUsers", "XEW"];
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _allRoles = await RoleManager.Roles.OrderBy(r => r.Name).ToListAsync();

            var users = await UserManager.Users.OrderBy(u => u.Email).ToListAsync();

            foreach (var user in users)
            {
                IList<string> roles = await UserManager.GetRolesAsync(user);
                usersWithRoles.Add(new UserRoleViewModel
                {
                    User = user,
                    Roles = roles.ToList(),
                    IsToggling = false,
                    TogglingRoleName = null
                });
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error loading users and roles: " + ex.Message;
        }
        
        (_projects, string logInfo, string logWarning, string logError) = await DataService.ReadFromCacheOrDb(new Project());
        
        
        
        
    }

    
    private async Task ToggleRoleAsync(string userId, string role)
    {
        var userViewModel = usersWithRoles.First(x => x.User.Id == userId);
        
        // 1. Set the state to indicate toggling has started
        userViewModel.IsToggling = true;
        userViewModel.TogglingRoleName = role;

        // 2. Call StateHasChanged() to refresh the UI
        //    (Show the spinner and disable the button)
        StateHasChanged();

        try
        {
            var user = userViewModel.User;
            bool isInRole = userViewModel.Roles.Contains(role);

            IdentityResult result;
            if (isInRole)
            {
                result = await UserManager.RemoveFromRoleAsync(user, role);
                if (result.Succeeded)
                    userViewModel.Roles.Remove(role);
            }
            else
            {
                result = await UserManager.AddToRoleAsync(user, role);
                if (result.Succeeded)
                    userViewModel.Roles.Add(role);
            }

            if (!result.Succeeded)
            {
                var errors = string.Join("; ", result.Errors.Select(e => e.Description));
                await JS.InvokeVoidAsync("alert", $"Failed: {errors}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Error: " + ex.Message);
        }
        finally
        {
            // 3. Set the state back to not toggling
            userViewModel.IsToggling = false;
            
            // 4. Call StateHasChanged() again to refresh the UI
            //    (Hide the spinner, re-enable the button, and show the new button state/color)
            StateHasChanged();
        }
    }
    
    
 
    private string GetHoverKey(string userId, string projectTag) => $"{userId}|{projectTag}";

    private void SetHover(string userId, string projectTag, bool isHovering)
    {
        var key = GetHoverKey(userId, projectTag);
        if (isHovering) hoveredProjects.Add(key);
        else hoveredProjects.Remove(key);
    }

    private bool IsHovered(string userId, string projectTag) 
        => hoveredProjects.Contains(GetHoverKey(userId, projectTag));


    private void ShowAddUserModal()
    {
        _newUser = new ApplicationUser { UserName = "", Email = "" };
        showAddUserModal = true;
        StateHasChanged();
    }
    
    private async Task HandleAddUserClose((string json, string type, string tag, string tagValue, string action) result)
    {
        showAddUserModal = false;
        if (result.action != "Ok" || string.IsNullOrWhiteSpace(result.json)) return;

        var options = new JsonSerializerOptions { IncludeFields = true };
        var user = JsonSerializer.Deserialize<ApplicationUser>(result.json, options);
        if (user?.UserName == null || user.Email == null) return;

        var createResult = await UserManager.CreateAsync(user, "MyPwd@123");
        if (createResult.Succeeded)
        {
            await LoadUsersAndRoles(); // refresh list
        }
        else
        {
            ErrorMessage = string.Join("; ", createResult.Errors.Select(e => e.Description));
        }
        StateHasChanged();
    }
    
    private async Task ConfirmDeleteUser(ApplicationUser user)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Delete user {user.UserName}?");
        if (confirmed)
        {
            await UserManager.DeleteAsync(user);
            await LoadUsersAndRoles();
            StateHasChanged();
        }
    }

    private async Task LoadUsersAndRoles()
    {
        var users = await UserManager.Users.OrderBy(u => u.Email).ToListAsync();
        usersWithRoles.Clear();
        foreach (var u in users)
        {
            var roles = (await UserManager.GetRolesAsync(u)).ToList();
            usersWithRoles.Add(new UserRoleViewModel
            {
                User = u,
                Roles = roles,
                IsToggling = false
            });
        }
        _projects = (await DataService.ReadFromCacheOrDb(new Project())).Item1;
    }
    
    private async Task AddProjectSelected(ChangeEventArgs e, string userId)
    {
        var selectedTag = e.Value?.ToString();

        if (string.IsNullOrEmpty(selectedTag))
            return;

        await AddProjectAsyn(userId, selectedTag);

        // Close dropdown for this specific user only
        showProjectDropdown[userId] = false;
        StateHasChanged();
    }
    private async Task AddProjectAsyn(string userId, string projectTag)
    {
        if (string.IsNullOrEmpty(projectTag)) return;

        // Find the project
        var project = _projects.FirstOrDefault(p => p.Tag == projectTag);
        if (project == null) return;

        // Find the actual ApplicationUser object
        var user = usersWithRoles.FirstOrDefault(u => u.User.Id == userId)?.User;
        if (user == null || string.IsNullOrEmpty(user.UserName)) return;

        // Deserialize current ProjUsers list (it's stored as JSON string)
        var userList = string.IsNullOrEmpty(project.ProjUsers)
            ? new List<string>()
            : JsonSerializer.Deserialize<List<string>>(project.ProjUsers)!;

        // Add username if not already there
        if (!userList.Contains(user.UserName))
        {
            userList.Add(user.UserName);
            project.ProjUsers = JsonSerializer.Serialize(userList);

            // Save to DB
            await MyTable.UpdateParameter(project, project.UID, ["ProjUsers"]);

            // Optional: refresh projects from DB/cache so UI stays in sync
            // (_projects, _, _, _) = await DataService.ReadFromCacheOrDb(new Project());
        }

        StateHasChanged();
    }
    
    private async Task RemoveProjectAsyn(string userId, string selectedProjectName)
    {
        var selectedProject = _projects.Find(p => p.Tag == selectedProjectName);
        if (selectedProject == null) return;

        var userList = string.IsNullOrEmpty(selectedProject.ProjUsers)
            ? new List<string>()
            : JsonSerializer.Deserialize<List<string>>(selectedProject.ProjUsers)!;

        var user = usersWithRoles.First(u => u.User.Id == userId).User;

        userList.RemoveAll(u => u == user.UserName); // Remove properly

        selectedProject.ProjUsers = JsonSerializer.Serialize(userList);
        await MyTable.UpdateParameter(selectedProject, selectedProject.UID, ["ProjUsers"]);

        StateHasChanged();
    }
    
    private void ShowAddProjectModal()
    {
        var tag = $"Project {new Random().Next(10000, 99999)}";
        _newProject = new Project
        {
            UID = Guid.NewGuid(),
            Tag = tag,
            TagDescription = tag,
            ProjAlt = "base",
            ProjClient = "",
            ProjPartners = "[\"self\"]",
            ProjLocation = "",
            ProjUsers = "[\"test\"]",
            Order = 0,
            Display = true,
            XEW = true // X-Axis for East-West is true
        };
        _showModal = true;
        StateHasChanged();
    }

    private async Task HandleModalClose((string json, string type, string tag, string tagValue, string action) result)
    {
        if (result.action == "Ok" && !string.IsNullOrEmpty(result.json))
        {
            var jsonSerializerOption = new JsonSerializerOptions { IncludeFields = true };
            var savedProject = System.Text.Json.JsonSerializer.Deserialize<Project>(result.json, jsonSerializerOption);
            if (savedProject != null)
            {
                await MyTable.InsertItem(savedProject);
            }
        }
        _showModal = false;
        StateHasChanged();
    }
    
    
    // Helper class to track per-user state
    public class UserRoleViewModel
    {
        public required ApplicationUser User { get; set; }
        public List<string> Roles { get; set; } = [];
        public List<string> ProjectNames{ get; set; } = [];
        public bool IsToggling { get; set; }
        public string? TogglingRoleName { get; set; }  // This is the key!
    }
    

}