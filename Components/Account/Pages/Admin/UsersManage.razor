@page "/admin/users"
@attribute [Authorize(Policy = "RequireAdmin")]

@rendermode InteractiveServer
@attribute [StreamRendering]

@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using ElDesignApp.Components.MyModals
@using System.Text.Json
@using Microsoft.AspNetCore.Authorization
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject IDataRetrievalService DataService
@inject IJSRuntime JS
@inject Services.IMyTableService MyTable
@inject IRoleAuthorizationService RoleAuthService
@inject IProjectContextService ProjectContext
@inject AuthenticationStateProvider AuthState

<PageTitle>User Management</PageTitle>

<h3>User Management</h3>

@if (_isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> @ErrorMessage
    </div>
}
else
{
    <!-- Top Action Buttons -->
    <div class="d-flex justify-content-between mb-3">
        <h4>User & Project Management</h4>
        <div>
            @* <button class="btn btn-info me-2" @onclick="ShowRoleMappingModal">
                <i class="bi bi-gear"></i> Manage Role Mappings
            </button> *@
            <button class="btn btn-success" @onclick="ShowAddProjectModal">
                <i class="bi bi-plus-lg"></i> Add New Project
            </button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label class="form-label fw-bold">Filter by Project:</label>
                </div>
                <div class="col-auto">
                    <select class="form-select" @bind="_selectedProjectFilter" @bind:after="StateHasChanged">
                        <option value="">All Projects</option>
                        @foreach (var project in _projects.OrderBy(p => p.Tag))
                        {
                            
                            <option value="@project.UID">@project.Tag - @project.TagDescription</option>
                        }
                    </select>
                </div>
                <div class="col-auto">
                    <label class="form-label fw-bold">Search User:</label>
                </div>
                <div class="col-auto">
                    <input type="text" 
                           class="form-control" 
                           placeholder="Username or email..." 
                           @bind="_userSearchFilter" 
                           @bind:after="StateHasChanged"/>
                </div>
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>Email</th>
                <th>Username</th>
                <th class="text-center">Projects & Roles</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var item in GetFilteredUsers())
            {
                var user = item.User;
                var currentUserId = item.User.Id;

               
                <tr>
                    <td><strong>@user.Email</strong></td>
                    <td>@user.UserName</td>
 
                    <!-- Projects & Roles Column -->
                    <td class="py-3">
                        @{
                            var userAssignments = _projectAssignments
                                .Where(pa => pa.UserId == currentUserId && pa.IsActive)
                                .ToList();
                        }
                        
                        @if (!userAssignments.Any())
                        {
                            <div class="text-center">
                                <span class="text-muted small">No projects assigned</span>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex flex-column gap-2">
                                @foreach (var assignment in userAssignments)
                                {
                                    var project = _projects.FirstOrDefault(p => p.UID == assignment.ProjectId);
                                    if (project != null)
                                    {
                                        <div class="border rounded p-2 bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="flex-grow-1">
                                                    <strong class="text-primary">@project.Tag</strong>
                                                    <small class="text-muted d-block">@project.TagDescription</small>
                                                    
                                                    <div class="mt-1">
                                                        @if (assignment.IsProjectAdmin)
                                                        {
                                                            <span class="badge bg-success me-1">
                                                                <i class="bi bi-shield-check"></i> Admin
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary me-1">
                                                                <i class="bi bi-person"></i> Member
                                                            </span>
                                                        }
                                                        
                                                        @* Show user's custom roles in this project *@
                                                        @{
                                                            var userRoles = _projectUserRoles
                                                                .Where(pur => pur.UserId == currentUserId && 
                                                                             pur.ProjectId == project.UID && 
                                                                             pur.IsActive)
                                                                .Select(pur => pur.CustomRoleName)
                                                                .ToList();
                                                        }
                                                        
                                                        @foreach (var role in userRoles)
                                                        {
                                                            <span class="badge bg-info">@role</span>
                                                        }
                                                    </div>
                                                </div>
                                                
                                                <div class="btn-group-vertical btn-group-sm ms-2">
                                                    <button class="btn btn-sm @(assignment.IsProjectAdmin ? "btn-warning" : "btn-outline-warning")" 
                                                            @onclick="async () => await ToggleProjectAdminAsync(currentUserId, project.UID)"
                                                            title="@(assignment.IsProjectAdmin ? "Remove Admin" : "Make Admin")">
                                                        <i class="bi @(assignment.IsProjectAdmin ? "bi-shield-fill-check" : "bi-shield")"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            @onclick="async () => await RemoveFromProjectAsync(currentUserId, project.UID)"
                                                            title="Remove from project">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                        
                        <!-- Add to Project Button -->
                        <div class="mt-2">
                            @{
                                var unassignedProjects = _projects
                                    .Where(p => !userAssignments.Any(ua => ua.ProjectId == p.UID))
                                    .ToList();
                            }
                            
                            @if (unassignedProjects.Any())
                            {
                                var dropdownKey = $"project_{currentUserId}";
                                var isOpen = _openDropdowns.GetValueOrDefault(dropdownKey);
                                
                                <button class="btn btn-sm btn-outline-success" 
                                        @onclick="() => ToggleDropdown(dropdownKey)">
                                    <i class="bi bi-plus"></i> Assign to Project
                                </button>
                                
                                @if (isOpen)
                                {
                                    <div class="mt-2">
                                        <select class="form-select form-select-sm mb-2" 
                                                @onchange="async (e) => await AssignToProjectAsync(currentUserId, e.Value?.ToString())">
                                            <option value="">Select project...</option>
                                            @foreach (var proj in unassignedProjects.OrderBy(p => p.Tag))
                                            {
                                                <option value="@proj.UID">@proj.Tag - @proj.TagDescription</option>
                                            }
                                        </select>
                                        <button class="btn btn-sm btn-secondary" 
                                                @onclick="() => ToggleDropdown(dropdownKey)">
                                            Cancel
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                    </td>
                    
                    <!-- Actions Column -->
                    <td>
                        <div class="btn-group-vertical btn-group-sm">
                            <button class="btn btn-sm btn-outline-danger" 
                                    @onclick="async () => await ConfirmDeleteUser(user)">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
}

<!-- Modals -->
@if (_showProjectModal && _newProject != null)
{
    <ProjectModal 
        Item="@_newProject" 
        OnClose="HandleProjectModalClose"/>
}

@* @if (_showRoleMappingModal)
{
    <RoleMappingModal OnClose="HandleRoleMappingModalClose"/>
} *@

@code {
    private List<UserRoleViewModel> usersWithRoles = new();
    private List<Project> _projects = new();
    private List<ProjectUserAssignment> _projectAssignments = new();
    private List<ProjectUserRole> _projectUserRoles = new();
    private List<RoleMapping> _activeCustomRoles = new();
    
    private bool _isLoading = true;
    private string? ErrorMessage;
    private string? _currentUserId;
    
    // Filters
    private string _selectedProjectFilter = "";
    private string _userSearchFilter = "";
    
    // UI State
    private Dictionary<string, bool> _openDropdowns = new();
    
    // Modals
    private bool _showProjectModal = false;
    private bool _showRoleMappingModal = false;
    private Project? _newProject;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthState.GetAuthenticationStateAsync();
            _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            await LoadAllData();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading data: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"OnInitializedAsync Error: {ex}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadAllData()
    {
        await LoadProjects();
        await LoadProjectAssignments();
        await LoadProjectUserRoles();
        await LoadUsersAndRoles();
    }

    private async Task LoadProjects()
    {
        try
        {
            var result = await DataService.ReadFromCacheOrDb(new Project());
            _projects = result.Item1.Where(p => p.Display).OrderBy(p => p.Tag).ToList();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadProjects Error: {ex}");
            _projects = new();
        }
    }

    private async Task LoadProjectAssignments()
    {
        try
        {
            var result = await DataService.ReadFromCacheOrDb(new ProjectUserAssignment());
            _projectAssignments = result.Item1;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadProjectAssignments Error: {ex}");
            _projectAssignments = new();
        }
    }

    private async Task LoadProjectUserRoles()
    {
        try
        {
            var result = await DataService.ReadFromCacheOrDb(new ProjectUserRole());
            _projectUserRoles = result.Item1;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadProjectUserRoles Error: {ex}");
            _projectUserRoles = new();
        }
    }

    private async Task LoadUsersAndRoles()
    {
        try
        {
            var allUsers = await UserManager.Users.ToListAsync();
            usersWithRoles = new List<UserRoleViewModel>();

            foreach (var user in allUsers)
            {
                var roles = await UserManager.GetRolesAsync(user);
                usersWithRoles.Add(new UserRoleViewModel
                {
                    User = user,
                    Roles = roles.ToList()
                });
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"LoadUsersAndRoles Error: {ex}");
            usersWithRoles = new();
        }
    }

    private IEnumerable<UserRoleViewModel> GetFilteredUsers()
    {
        var filtered = usersWithRoles.AsEnumerable();

        // Filter by project
        if (!string.IsNullOrEmpty(_selectedProjectFilter) && Guid.TryParse(_selectedProjectFilter, out var projectId))
        {
            var usersInProject = _projectAssignments
                .Where(pa => pa.ProjectId == projectId && pa.IsActive)
                .Select(pa => pa.UserId)
                .ToHashSet();
            
            filtered = filtered.Where(u => usersInProject.Contains(u.User.Id));
        }

        // Filter by search text
        if (!string.IsNullOrEmpty(_userSearchFilter))
        {
            var search = _userSearchFilter.ToLower();
            filtered = filtered.Where(u => 
                (u.User.UserName?.ToLower().Contains(search) ?? false) ||
                (u.User.Email?.ToLower().Contains(search) ?? false));
        }

        return filtered.OrderBy(u => u.User.UserName);
    }

    private async Task AssignToProjectAsync(string userId, string? projectIdStr)
    {
        if (string.IsNullOrEmpty(projectIdStr) || !Guid.TryParse(projectIdStr, out var projectId))
        {
            _openDropdowns.Clear();
            return;
        }

        try
        {
            // Check if already assigned
            var existing = _projectAssignments
                .FirstOrDefault(pa => pa.UserId == userId && pa.ProjectId == projectId && pa.IsActive);
            
            if (existing != null)
            {
                await JS.InvokeVoidAsync("alert", "User is already assigned to this project");
                _openDropdowns.Clear();
                StateHasChanged();
                return;
            }

            var assignment = new ProjectUserAssignment
            {
                UID = Guid.NewGuid(),
                ProjectId = projectId,
                UserId = userId,
                IsProjectAdmin = false,
                IsActive = true,
                AssignedBy = _currentUserId ?? "system",
                AssignedOn = DateTime.Now
            };

            int rows = await MyTable.InsertItemAsync(assignment);
            
            if (rows > 0)
            {
                // Refresh cache to get latest data
                await DataService.RefreshCache();
                
                // Reload assignments
                await LoadProjectAssignments();
                
                // Close all dropdowns
                _openDropdowns.Clear();
                
                // Force UI update
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to assign user to project");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"AssignToProjectAsync Error: {ex}");
        }
    }

    private async Task RemoveFromProjectAsync(string userId, Guid projectId)
    {
        var project = _projects.FirstOrDefault(p => p.UID == projectId);
        var confirmed = await JS.InvokeAsync<bool>("confirm", 
            $"Remove this user from project '{project?.Tag}'? This will also remove their custom roles.");
        
        if (!confirmed) return;

        try
        {
            var assignment = _projectAssignments
                .FirstOrDefault(pa => pa.UserId == userId && pa.ProjectId == projectId && pa.IsActive);
            
            if (assignment == null) return;

            assignment.IsActive = false;
            assignment.RemovedBy = _currentUserId;
            assignment.RemovedOn = DateTime.Now;

            await MyTable.UpdateParameter(assignment, assignment.UID,
                [nameof(assignment.IsActive), nameof(assignment.RemovedBy), nameof(assignment.RemovedOn)]);

            // Also deactivate user's roles in this project
            var userRoles = _projectUserRoles
                .Where(pur => pur.UserId == userId && pur.ProjectId == projectId && pur.IsActive)
                .ToList();
            
            foreach (var role in userRoles)
            {
                role.IsActive = false;
                role.RemovedBy = _currentUserId;
                role.RemovedOn = DateTime.Now;
                await MyTable.UpdateParameter(role, role.UID,
                    [nameof(role.IsActive), nameof(role.RemovedBy), nameof(role.RemovedOn)]);
            }

            // Refresh cache
            await DataService.RefreshCache();
            
            // Reload data
            await LoadProjectAssignments();
            await LoadProjectUserRoles();
            
            // Force UI update
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"RemoveFromProjectAsync Error: {ex}");
        }
    }

    private async Task ToggleProjectAdminAsync(string userId, Guid projectId)
    {
        try
        {
            var assignment = _projectAssignments
                .FirstOrDefault(pa => pa.UserId == userId && pa.ProjectId == projectId && pa.IsActive);
            
            if (assignment == null) return;

            assignment.IsProjectAdmin = !assignment.IsProjectAdmin;

            await MyTable.UpdateParameter(assignment, assignment.UID,
                [nameof(assignment.IsProjectAdmin)]);

            // Refresh cache
            await DataService.RefreshCache();
            
            // Reload assignments
            await LoadProjectAssignments();
            
            // Force UI update
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"ToggleProjectAdminAsync Error: {ex}");
        }
    }

    private void ToggleDropdown(string key)
    {
        if (_openDropdowns.ContainsKey(key))
            _openDropdowns[key] = !_openDropdowns[key];
        else
            _openDropdowns[key] = true;
    }

    // Project Management
    private void ShowAddProjectModal()
    {
        _newProject = new Project
        {
            Tag = $"PROJ-{DateTime.Now:yyyyMMddHHmmss}",
            TagDescription = "New project - please update description",
            UID = Guid.NewGuid(),
            Display = true
        };
        _showProjectModal = true;
    }

    private async Task HandleProjectModalClose((string ItemJson, string Type, string OriginalTag, string CurrentTag, string Action) result)
    {
        _showProjectModal = false;
        if (result.Action != "Ok" || string.IsNullOrWhiteSpace(result.ItemJson))
        {
            StateHasChanged();
            return;
        }

        try
        {
            var options = new JsonSerializerOptions 
            { 
                PropertyNameCaseInsensitive = true,
                IncludeFields = true 
            };
            
            var project = JsonSerializer.Deserialize<Project>(result.ItemJson, options);

            if (project == null || string.IsNullOrWhiteSpace(project.Tag))
            {
                await JS.InvokeVoidAsync("alert", "Project Code is required");
                return;
            }

            // Check if project already exists
            bool exists = _projects.Any(p => p.Tag.Equals(project.Tag, StringComparison.OrdinalIgnoreCase));
            
            if (exists)
            {
                await JS.InvokeVoidAsync("alert", $"Project '{project.Tag}' already exists!");
                return;
            }

            project.UID = Guid.NewGuid();
            project.Order = _projects.Count;
            
            int rows = await MyTable.InsertItemAsync(project);
            
            if (rows > 0)
            {
                await JS.InvokeVoidAsync("alert", "Project created successfully!");
                await LoadProjects();
                
                // TODO: Seed standard roles for this project
                await SeedStandardRolesForProject(project.UID);
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to create project");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"HandleProjectModalClose Error: {ex}");
        }

        StateHasChanged();
    }

    private async Task SeedStandardRolesForProject(Guid projectId)
    {
        try
        {
            var standardRoles = new[]
            {
                new RoleMapping { UID = Guid.NewGuid(), ProjectId = projectId, CustomRoleName = "Admin", Description = "Project Administrator", MappedHardRoles = "[\"Admin\"]", IsEditable = false, IsActive = true, CreatedBy = "System", CreatedOn = DateTime.Now },
                new RoleMapping { UID = Guid.NewGuid(), ProjectId = projectId, CustomRoleName = "Manager", Description = "Project Manager", MappedHardRoles = "[\"Admin\",\"User\"]", IsEditable = true, IsActive = true, CreatedBy = "System", CreatedOn = DateTime.Now },
                new RoleMapping { UID = Guid.NewGuid(), ProjectId = projectId, CustomRoleName = "Engineer", Description = "Engineering staff", MappedHardRoles = "[\"User\"]", IsEditable = true, IsActive = true, CreatedBy = "System", CreatedOn = DateTime.Now },
                new RoleMapping { UID = Guid.NewGuid(), ProjectId = projectId, CustomRoleName = "Designer", Description = "Design team member", MappedHardRoles = "[\"User\"]", IsEditable = true, IsActive = true, CreatedBy = "System", CreatedOn = DateTime.Now },
                new RoleMapping { UID = Guid.NewGuid(), ProjectId = projectId, CustomRoleName = "Trainee", Description = "Trainee with limited access", MappedHardRoles = "[\"Guest\"]", IsEditable = true, IsActive = true, CreatedBy = "System", CreatedOn = DateTime.Now }
            };

            foreach (var role in standardRoles)
            {
                await MyTable.InsertItemAsync(role);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"SeedStandardRolesForProject Error: {ex}");
        }
    }

    private async Task ConfirmDeleteUser(ApplicationUser user)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete user '{user.UserName}'? This will remove all their project assignments.");
        
        if (confirmed)
        {
            try
            {
                // Deactivate all project assignments first
                var userAssignments = _projectAssignments
                    .Where(pa => pa.UserId == user.Id && pa.IsActive)
                    .ToList();
                
                foreach (var assignment in userAssignments)
                {
                    assignment.IsActive = false;
                    assignment.RemovedBy = _currentUserId;
                    assignment.RemovedOn = DateTime.Now;
                    await MyTable.UpdateParameter(assignment, assignment.UID,
                        [nameof(assignment.IsActive), nameof(assignment.RemovedBy), nameof(assignment.RemovedOn)]);
                }

                await UserManager.DeleteAsync(user);
                await LoadUsersAndRoles();
                await LoadProjectAssignments();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error deleting user: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"ConfirmDeleteUser Error: {ex}");
            }
        }
    }

    // Helper class
    public class UserRoleViewModel
    {
        public required ApplicationUser User { get; set; }
        public List<string> Roles { get; set; } = new();
        public bool IsToggling { get; set; }
        public string? TogglingRoleName { get; set; }
    }
}
