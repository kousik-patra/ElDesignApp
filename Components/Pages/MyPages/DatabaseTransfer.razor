@page "/database-transfer"
@attribute [Authorize(Policy = "RequireSuperAdmin")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Options
@using System.Diagnostics
@using System.Reflection
@using System.Text.Json

@rendermode InteractiveServer

@inject IOptions<ConnectionStrings> ConnectionStringsOptions
@inject NavigationManager MyNavigationManager
@inject IDataRetrievalService DataService
@inject ITableService Table
@inject IGlobalDataService GlobalData
@inject IJSRuntime JSRuntime

<PageTitle>Database Transfer</PageTitle>

<div class="database-transfer-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h3><i class="bi bi-database-gear"></i> Database Transfer</h3>
            <p class="text-muted mb-0">Backup and copy tables between database connections</p>
        </div>
    </div>

    <!-- Connection Selection Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-plug"></i> Connection Settings
        </div>
        <div class="card-body">
            <div class="row g-4">
                <!-- Source Connection -->
                <div class="col-md-5">
                    <div class="connection-box source">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-box-arrow-right text-success"></i> Source Database
                        </label>
                        <select class="form-select" @bind="SourceConnectionSelection">
                            <option value="">-- Select Source --</option>
                            @foreach (var conn in _connectionOptions)
                            {
                                <option value="@conn.Value">@conn.Name</option>
                            }
                        </select>
                        @if (!string.IsNullOrEmpty(SourceConnectionSelection))
                        {
                            <small class="text-success mt-1 d-block">
                                <i class="bi bi-check-circle"></i> Connected
                            </small>
                        }
                    </div>
                </div>

                <!-- Arrow / Transfer Icon -->
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <div class="transfer-arrow">
                        <i class="bi bi-arrow-right-circle-fill text-primary fs-1"></i>
                    </div>
                </div>

                <!-- Destination Connection -->
                <div class="col-md-5">
                    <div class="connection-box destination">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-box-arrow-in-right text-danger"></i> Destination Database
                        </label>
                        <select class="form-select" @bind="_selectedDestinationConnection">
                            <option value="">-- Select Destination --</option>
                            @foreach (var conn in _connectionOptions)
                            {
                                <option value="@conn.Value">@conn.Name</option>
                            }
                        </select>
                        @if (!string.IsNullOrEmpty(_selectedDestinationConnection))
                        {
                            <small class="text-danger mt-1 d-block">
                                <i class="bi bi-exclamation-triangle"></i> Data will be overwritten
                            </small>
                        }
                    </div>
                </div>
            </div>

            <!-- Same Connection Warning -->
            @if (!string.IsNullOrEmpty(SourceConnectionSelection) && 
                 !string.IsNullOrEmpty(_selectedDestinationConnection) && 
                 SourceConnectionSelection == _selectedDestinationConnection)
            {
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Warning:</strong> Source and destination are the same database!
                </div>
            }
        </div>
    </div>

    <!-- Table Selection Card -->
    @if (_tables.Any())
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table"></i> Select Tables to Copy</span>
                <span class="badge bg-primary">@SelectedTableCount / @_tables.Count selected</span>
            </div>
            <div class="card-body">
                <!-- Quick Actions -->
                <div class="mb-3 d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" @onclick="SelectAllTables">
                        <i class="bi bi-check-all"></i> Select All
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick="DeselectAllTables">
                        <i class="bi bi-x-lg"></i> Deselect All
                    </button>
                    <div class="ms-auto">
                        <input type="text" class="form-control form-control-sm" 
                               placeholder="Filter tables..." 
                               @bind="_tableFilter" 
                               @bind:event="oninput" />
                    </div>
                </div>

                <!-- Table Grid -->
                <div class="table-selection-grid">
                    @foreach (var table in FilteredTables)
                    {
                        <div class="form-check table-check-item @(SelectedTables[table] ? "selected" : "")">
                            <input type="checkbox"
                                   class="form-check-input"
                                   id="table-@table"
                                   checked="@SelectedTables[table]"
                                   @onchange="e => OnTableCheckboxChanged(table, (bool)(e.Value ?? false))" />
                            <label class="form-check-label" for="table-@table">
                                <i class="bi bi-table text-muted"></i> @table
                            </label>
                        </div>
                    }
                </div>

                @if (!FilteredTables.Any() && !string.IsNullOrEmpty(_tableFilter))
                {
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-search"></i> No tables match "@_tableFilter"
                    </div>
                }
            </div>
        </div>
    }

    <!-- Action Buttons -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-success btn-lg" 
                        @onclick="CopyTablesWithConfirmation"
                        disabled="@(!CanCopy || _isProcessing)">
                    @if (_isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span>Copying @_currentCopyTable...</span>
                    }
                    else
                    {
                        <i class="bi bi-clipboard-data"></i>
                        <span>Copy @SelectedTableCount Table(s)</span>
                    }
                </button>

                @if (_isProcessing)
                {
                    <div class="ms-3 flex-grow-1">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: @_copyProgress%">
                                @_copyProgress% (@_copiedCount / @SelectedTableCount)
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div class="messages-container">
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="bi bi-x-circle-fill"></i> @_errorMessage
                <button type="button" class="btn-close" @onclick="() => _errorMessage = null"></button>
            </div>
        }
        @if (!string.IsNullOrEmpty(_warningMessage))
        {
            <div class="alert alert-warning alert-dismissible fade show">
                <i class="bi bi-exclamation-triangle-fill"></i> @_warningMessage
                <button type="button" class="btn-close" @onclick="() => _warningMessage = null"></button>
            </div>
        }
        @if (!string.IsNullOrEmpty(_infoMessage))
        {
            <div class="alert alert-info alert-dismissible fade show">
                <i class="bi bi-info-circle-fill"></i> @_infoMessage
                <button type="button" class="btn-close" @onclick="() => _infoMessage = null"></button>
            </div>
        }
        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show">
                <i class="bi bi-check-circle-fill"></i> @_successMessage
                <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
            </div>
        }
    </div>

    <!-- Copy Log -->
    @if (_copyLog.Any())
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-journal-text"></i> Copy Log</span>
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => _copyLog.Clear()">
                    <i class="bi bi-trash"></i> Clear
                </button>
            </div>
            <div class="card-body p-0">
                <div class="copy-log">
                    @foreach (var log in _copyLog.AsEnumerable().Reverse())
                    {
                        <div class="log-entry @log.Type">
                            <span class="log-time">@log.Time.ToString("HH:mm:ss")</span>
                            <span class="log-icon">
                                @switch (log.Type)
                                {
                                    case "success":
                                        <i class="bi bi-check-circle text-success"></i>
                                        break;
                                    case "error":
                                        <i class="bi bi-x-circle text-danger"></i>
                                        break;
                                    default:
                                        <i class="bi bi-info-circle text-info"></i>
                                        break;
                                }
                            </span>
                            <span class="log-message">@log.Message</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <hr class="my-4" />

    <!-- DBMaster Table Section -->
    @if (_loadChild)
    {
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-database"></i> Database Master Configuration
            </div>
            <div class="card-body p-0">
                <Table List="_list"
                       ListOriginal="_listDb"
                       T="DBMaster"
                       AutoCheckParentCallback="AutoCheckParentCallbackOnTableChange"
                       UpdateParentCallback="UpdateParentCallbackTableChange"
                       DiscardParentCallback="DiscardParentCallbackTableChange"
                       RefreshParentCallback="TableRefreshParentCallback"
                       SuccessMessage="@_tableSuccessMessage"
                       InfoMessage="@_tableInfoMessage"
                       WarningMessage="@_tableWarningMessage"
                       ErrorMessage="@_tableErrorMessage">
                </Table>
            </div>
        </div>
    }
</div>

<!-- Styles -->
<style>
    .database-transfer-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }

    .page-header h3 {
        margin: 0;
        font-weight: 600;
    }

    .page-header .text-muted {
        color: rgba(255,255,255,0.8) !important;
    }

    .connection-box {
        padding: 1rem;
        border-radius: 8px;
        background: #f8f9fa;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .connection-box.source:has(select:not([value=""])) {
        border-color: #198754;
        background: #d1e7dd;
    }

    .connection-box.destination:has(select:not([value=""])) {
        border-color: #dc3545;
        background: #f8d7da;
    }

    .transfer-arrow {
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }

    .table-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.5rem;
        max-height: 400px;
        overflow-y: auto;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .table-check-item {
        padding: 0.5rem 0.75rem;
        background: white;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .table-check-item:hover {
        border-color: #0d6efd;
        background: #e7f1ff;
    }

    .table-check-item.selected {
        border-color: #0d6efd;
        background: #cfe2ff;
    }

    .table-check-item label {
        cursor: pointer;
        margin-bottom: 0;
    }

    .copy-log {
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.85rem;
    }

    .log-entry {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #eee;
    }

    .log-entry:last-child {
        border-bottom: none;
    }

    .log-entry.success {
        background: #d1e7dd;
    }

    .log-entry.error {
        background: #f8d7da;
    }

    .log-time {
        color: #6c757d;
        font-size: 0.8rem;
        min-width: 70px;
    }

    .log-icon {
        min-width: 20px;
    }

    .log-message {
        flex: 1;
    }

    .card {
        border: none;
        border-radius: 12px;
    }

    .card-header {
        border-radius: 12px 12px 0 0 !important;
        font-weight: 600;
    }

    .messages-container .alert {
        border-radius: 8px;
        border: none;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    .progress {
        border-radius: 8px;
        overflow: hidden;
    }

    .progress-bar {
        font-weight: 600;
    }
</style>

@code {
    #region Fields

    // Connection options
    private List<(string Name, string Value)> _connectionOptions = new();

    // Source connection with change detection
    private string _selectedSourceConnectionField = string.Empty;
    private string SourceConnectionSelection
    {
        get => _selectedSourceConnectionField;
        set
        {
            if (_selectedSourceConnectionField != value)
            {
                _selectedSourceConnectionField = value;
                InvokeAsync(async () => await OnSourceConnectionChanged(value));
            }
        }
    }

    private string _selectedDestinationConnection = string.Empty;

    // Tables
    private List<string> _tables = new();
    private Dictionary<string, bool> SelectedTables = new();
    private string _tableFilter = string.Empty;

    // UI State
    private bool _loadChild;
    private bool _isProcessing;
    private int _copyProgress;
    private int _copiedCount;
    private string _currentCopyTable = string.Empty;

    // Messages
    private string? _successMessage;
    private string? _infoMessage;
    private string? _warningMessage;
    private string? _errorMessage;
    private string _tableSuccessMessage = string.Empty;
    private string _tableInfoMessage = string.Empty;
    private string _tableWarningMessage = string.Empty;
    private string _tableErrorMessage = string.Empty;

    // Copy Log
    private List<LogEntry> _copyLog = new();

    // DBMaster
    private List<DBMaster>? _listDb = new();
    private List<DBMaster>? _list = new();
    private readonly JsonSerializerOptions _jsonOptions = new() { IncludeFields = true };

    // Computed
    private int SelectedTableCount => SelectedTables.Count(kvp => kvp.Value);
    private bool CanCopy => !string.IsNullOrEmpty(SourceConnectionSelection) &&
                            !string.IsNullOrEmpty(_selectedDestinationConnection) &&
                            SourceConnectionSelection != _selectedDestinationConnection &&
                            SelectedTableCount > 0;

    private IEnumerable<string> FilteredTables => string.IsNullOrEmpty(_tableFilter)
        ? _tables
        : _tables.Where(t => t.Contains(_tableFilter, StringComparison.OrdinalIgnoreCase));

    #endregion

    #region Lifecycle

    protected override void OnInitialized()
    {
        // Initialize connection options
        var options = ConnectionStringsOptions.Value;
        _connectionOptions = new List<(string, string)>
        {
            ("Default Connection", options.DefaultConnection ?? ""),
            ("MacMini", options.MacMini ?? ""),
            ("MacBook", options.MacBook ?? ""),
            ("Oracle VM (1VCU)", options.OracleVM1VCU ?? ""),
            ("TestFeb24Context", options.TestFeb24Context ?? ""),
            ("MacMini Docker", options.MacMiniDocker ?? "")
        }.Where(x => !string.IsNullOrEmpty(x.Item2)).ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        Debug.WriteLine($"{DateTime.Now:HH:mm:ss.fff} : {GetType().Name}.OnInitializedAsync");

        try
        {
            (_listDb, _, _, _) = await DataService.RefreshCacheAndReadFromDb<DBMaster>();
            UpdateLocalVariables(_listDb);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load DBMaster: {ex.Message}";
        }

        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDBMasterData();
            _loadChild = true;
            StateHasChanged();
        }
    }

    #endregion

    #region Connection & Table Loading

    private async Task OnSourceConnectionChanged(string connectionString)
    {
        ResetMessages();
        _tables.Clear();
        SelectedTables.Clear();

        if (string.IsNullOrEmpty(connectionString))
        {
            StateHasChanged();
            return;
        }

        _infoMessage = "Loading tables...";
        StateHasChanged();

        try
        {
            _tables = await Table.GetTableNamesAsync(connectionString);
            SelectedTables = _tables.ToDictionary(t => t, _ => false);
            _infoMessage = $"Loaded {_tables.Count} tables from source database.";
            AddLog($"Connected to source. Found {_tables.Count} tables.", "info");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load tables: {ex.Message}";
            AddLog($"Connection failed: {ex.Message}", "error");
        }

        StateHasChanged();
    }

    private void OnTableCheckboxChanged(string tableName, bool isChecked)
    {
        SelectedTables[tableName] = isChecked;
        StateHasChanged();
    }

    private void SelectAllTables()
    {
        foreach (var key in SelectedTables.Keys.ToList())
            SelectedTables[key] = true;
        StateHasChanged();
    }

    private void DeselectAllTables()
    {
        foreach (var key in SelectedTables.Keys.ToList())
            SelectedTables[key] = false;
        StateHasChanged();
    }

    #endregion

    #region Copy Operations

    private async Task CopyTablesWithConfirmation()
    {
        var tablesToCopy = SelectedTables.Where(kvp => kvp.Value).Select(kvp => kvp.Key).ToList();

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            $"Are you sure you want to copy {tablesToCopy.Count} table(s)?\n\n" +
            $"⚠️ This will OVERWRITE existing data in the destination database!\n\n" +
            $"Tables: {string.Join(", ", tablesToCopy.Take(5))}" +
            (tablesToCopy.Count > 5 ? $" and {tablesToCopy.Count - 5} more..." : ""));

        if (!confirmed) return;

        await CopyTables(tablesToCopy);
    }

    private async Task CopyTables(List<string> tablesToCopy)
    {
        ResetMessages();
        _isProcessing = true;
        _copyProgress = 0;
        _copiedCount = 0;
        _copyLog.Clear();

        AddLog($"Starting copy of {tablesToCopy.Count} tables...", "info");
        StateHasChanged();

        var errors = new List<string>();

        try
        {
            for (int i = 0; i < tablesToCopy.Count; i++)
            {
                var table = tablesToCopy[i];
                _currentCopyTable = table;
                _copyProgress = (int)((i / (double)tablesToCopy.Count) * 100);
                StateHasChanged();

                try
                {
                    await Table.CopyTablesAsync(
                        SourceConnectionSelection,
                        _selectedDestinationConnection,
                        new[] { table });

                    _copiedCount++;
                    AddLog($"✓ Copied table: {table}", "success");
                }
                catch (Exception ex)
                {
                    errors.Add($"{table}: {ex.Message}");
                    AddLog($"✗ Failed to copy {table}: {ex.Message}", "error");
                }

                StateHasChanged();
                await Task.Delay(100); // Small delay to show progress
            }

            _copyProgress = 100;

            if (errors.Any())
            {
                _warningMessage = $"Completed with {errors.Count} error(s). {_copiedCount}/{tablesToCopy.Count} tables copied.";
            }
            else
            {
                _successMessage = $"Successfully copied {_copiedCount} table(s) to destination database.";
            }

            AddLog($"Copy operation completed. {_copiedCount}/{tablesToCopy.Count} successful.", 
                   errors.Any() ? "warning" : "success");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Copy operation failed: {ex.Message}";
            AddLog($"Operation failed: {ex.Message}", "error");
        }
        finally
        {
            _isProcessing = false;
            _currentCopyTable = string.Empty;
            StateHasChanged();
        }
    }

    #endregion

    #region DBMaster Table Methods

    private async Task LoadDBMasterData(bool isRefresh = false)
    {
        try
        {
            var result = isRefresh
                ? await DataService.RefreshCacheAndReadFromDb<DBMaster>()
                : await DataService.ReadFromCacheOrDb<DBMaster>();

            GlobalData.DBMasters = result.Item1;
            UpdateLocalVariables(result.Item1);
        }
        catch (Exception ex)
        {
            _tableErrorMessage = $"Failed to load data: {ex.Message}";
        }
    }

    private void UpdateLocalVariables<T>(List<T>? list)
    {
        var json = JsonSerializer.Serialize(list, _jsonOptions);
        _listDb = JsonSerializer.Deserialize<List<DBMaster>>(json, _jsonOptions);
        _list = JsonSerializer.Deserialize<List<DBMaster>>(json, _jsonOptions);
    }

    private async Task TableRefresh()
    {
        Debug.WriteLine($"{DateTime.Now:HH:mm:ss.fff} : TableRefresh called");
        await LoadDBMasterData(true);
        ResetTableMessages();
        _tableSuccessMessage = "Table refreshed from database.";
        StateHasChanged();
    }

    private void AutoCheckOnTableChange<T>((T, Guid, System.Reflection.PropertyInfo, T, List<T>, List<T>, string, string, string, string) args)
    {
        // Validation handled by child component
    }

    private async Task UpdateTableChange<T>((T item, List<T>? list, List<T> originalList, string success, string info, string warning, string error) parameters)
    {
        Debug.WriteLine($"{DateTime.Now:HH:mm:ss.fff} : UpdateTableChange called");

        _tableSuccessMessage = parameters.success;
        _tableInfoMessage = parameters.info;
        _tableWarningMessage = parameters.warning;
        _tableErrorMessage = parameters.error;

        var updatedList = parameters.list;
        UpdateLocalVariables(updatedList);

        GlobalData.DBMasters = JsonSerializer.Deserialize<List<DBMaster>>(
            JsonSerializer.Serialize(updatedList, _jsonOptions), _jsonOptions);

        try
        {
            var projectId = GlobalData.SelectedProject?.Tag ?? "System";
            await Table.BulkCopyAsync(updatedList?.Cast<DBMaster>().ToList() ?? new List<DBMaster>());

            ResetTableMessages();
            _tableSuccessMessage = "Changes saved to database successfully.";
        }
        catch (Exception ex)
        {
            _tableErrorMessage = $"Failed to save: {ex.Message}";
        }

        StateHasChanged();
    }

    private void DiscardTableChange()
    {
        Debug.WriteLine($"{DateTime.Now:HH:mm:ss.fff} : DiscardTableChange called");

        UpdateLocalVariables(_listDb);
        GlobalData.DBMasters = JsonSerializer.Deserialize<List<DBMaster>>(
            JsonSerializer.Serialize(_listDb, _jsonOptions), _jsonOptions);

        ResetTableMessages();
        _tableWarningMessage = "Changes discarded. Reverted to original data.";
        StateHasChanged();
    }

    #endregion

    #region Helpers

    private void ResetMessages()
    {
        _successMessage = null;
        _infoMessage = null;
        _warningMessage = null;
        _errorMessage = null;
    }

    private void ResetTableMessages()
    {
        _tableSuccessMessage = string.Empty;
        _tableInfoMessage = string.Empty;
        _tableWarningMessage = string.Empty;
        _tableErrorMessage = string.Empty;
    }

    private void AddLog(string message, string type = "info")
    {
        _copyLog.Add(new LogEntry(DateTime.Now, message, type));
    }

    private record LogEntry(DateTime Time, string Message, string Type);

    #endregion
}
