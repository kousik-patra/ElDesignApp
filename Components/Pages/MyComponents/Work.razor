@using System.Diagnostics
@using System.Reflection
@using System.Text
@using System.Text.Json
@using ElDesignApp.Models
@using ElDesignApp.Components.MyModals

@rendermode InteractiveServer

@inject NavigationManager MyNavigationManager
@using ElDesignApp.Services
@inject Services.IDataRetrievalService DataService
@inject Services.IMyTableService MyTable 
@inject Services.IGlobalDataService GlobalData
@inject Services.IMyFunctionService MyFunction
@inject Services.ILayoutFunctionService LayoutFunction


@if (!GlobalData.dbConnected)
{
    <div class="align-content-center alert-danger">
        <h4>Database is not connected</h4>
    </div>
}

<div class="container mt-4">
    <div class="row g-3 align-items-center">
        @if (_projects != null && _projects.Any())
        {
            <div class="col-auto">
                <label for="projectDropdown" class="form-label me-2">Select Project</label>
            </div>
            <div class="col-auto">
                <select id="projectDropdown"
                        class="form-select"
                        @bind="_selectedProjectTag"
                        @bind:after="Refresh">
                    @foreach (var project in _projects)
                    {
                        <option value="@project.Tag">@project.Tag | @project.TagDescription</option>
                    }
                </select>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" @onclick="ShowAddProjectModal">Add</button>
            </div>
        }
    </div>
    <br />
    <br />
    Selected Project: @GlobalData.SelectedProject?.Tag (@GlobalData.SelectedProject?.TagDescription)
</div>

@if (_showModal)
{
    <ElementPropertyModal T="Project" 
                   Title="Add New Project" 
                   Item="@_newProject" 
                   Fields="_fields"
                   OnClose="@HandleModalClose" />
}

@code {
    List<Project?>? _projects = [];
    string _selectedProjectTag = "JI-2048";
    bool _showModal = false;
    Project _newProject = new Project();
    readonly string[] _fields = ["Tag", "TagDescription", "ProjAlt", "ProjClient", "ProjPartners", "ProjLocation", "ProjUsers", "XEW"];
    
    protected override async Task OnInitializedAsync()
    {
        Debug.WriteLine($"{DateTime.Now:hh.mm.ss.ffffff} : {MyNavigationManager.Uri}  - {MethodBase.GetCurrentMethod()?.Name}");
        (_projects, string logInfo, string logWarning, string logError) = await DataService.ReadFromCacheOrDb(new Project());
        
        if (_projects.Count > 0)
        {
            GlobalData.dbConnected = true;
            var projects = _projects.Where(project => project.Tag == _selectedProjectTag).ToList();
            GlobalData.SelectedProject = projects.Count > 0 ? projects[0] : _projects[0];
        }

    }
    
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        Debug.WriteLine($"{DateTime.Now:hh.mm.ss.ffffff} : {MyNavigationManager.Uri} -  " +
                                           $"{System.Reflection.MethodBase.GetCurrentMethod()?.Name} - First Render:{firstRender}");

        if (firstRender)
        {
            //
        }
    }
    
    private void OnProjectSelected(ChangeEventArgs e)
    {
        _selectedProjectTag = e.Value?.ToString() ?? "";
        GlobalData.SelectedProject = _projects?.Find(proj=>proj?.Tag == _selectedProjectTag);
        StateHasChanged();
    }
    
    private void ShowAddProjectModal()
    {
        var tag = $"Project {new Random().Next(10000, 99999)}";
        _newProject = new Project
        {
            UID = Guid.NewGuid(),
            Tag = tag,
            TagDescription = tag,
            ProjAlt = "base",
            ProjClient = "",
            ProjPartners = "[\"self\"]",
            ProjLocation = "",
            ProjUsers = "[\"test\"]",
            Order = 0,
            Display = true,
            XEW = true // X-Axis for East-West is true
        };
        _showModal = true;
        StateHasChanged();
    }
    
    
    private async Task HandleModalClose((string json, string type, string tag, string tagValue, string action) result)
    {
        if (result.action == "Ok" && !string.IsNullOrEmpty(result.json))
        {
            var jsonSerializerOption = new JsonSerializerOptions { IncludeFields = true };
            var savedProject = System.Text.Json.JsonSerializer.Deserialize<Project>(result.json, jsonSerializerOption);
            if (savedProject != null)
            {
                // Assume DataService has a method to save the project
                await MyTable.InsertItem(savedProject);
                _selectedProjectTag = savedProject.Tag;
                _projects!.Add(savedProject);
                GlobalData.SelectedProject!.Tag = savedProject.Tag;
            }
        }
        _showModal = false;
        StateHasChanged();
    }

   
    private async Task Refresh()
    {
        
        // refreshing cache
        if (GlobalData.SelectedProject != null && _selectedProjectTag !="")
        {
            GlobalData.SelectedProject = _projects?.Find(proj=>proj?.Tag == _selectedProjectTag);
            Debug.WriteLine($"Selected Project: {GlobalData.SelectedProject?.Tag}");
        }


        (string logInfo, string logWarning, string logError)
            = await DataService.RefreshCache();

        var displayText = MyFunction.LogMessage(logInfo, logWarning, logError);
        Debug.WriteLine(displayText);
        await InvokeAsync(StateHasChanged);
    }
    
    
    
    
    
}