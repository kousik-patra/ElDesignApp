@rendermode InteractiveServer
@attribute [StreamRendering]

@using System.Diagnostics
@using System.Reflection
@using ElDesignApp.Data
@using ElDesignApp.Models
@using ElDesignApp.Services
@using ElDesignApp.Services.DataBase
@using Microsoft.JSInterop

@inject IJSRuntime JsRuntime
@inject NavigationManager MyNavigationManager
@inject IDataRetrievalService DataService
@inject ITableService Table
@inject IGlobalDataService GlobalData
@inject IPlotPlanService PlotPlanService
@inject PinPlacementService PinService

@* ============ Messages Section ============ *@
@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @_errorMessage
        <button type="button" class="btn-close" @onclick="() => _errorMessage = null"></button>
    </div>
}
@if (!string.IsNullOrEmpty(_successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @_successMessage
        <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
    </div>
}

@* ============ Plot Plans Section with Loading State ============ *@

@* ============ Loading State ============ *@
@if (_isLoadingPlans)
{
    <div class="loading-container">
        <div class="loading-header">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="loading-text">Loading plot plans...</span>
        </div>
        
        @* Skeleton Table *@
        <div class="table-responsive">
            <table class="table table-striped table-sm skeleton-table">
                <thead>
                    <tr>
                        <th style="width: 80px"><span class="skeleton-box" style="width: 50px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                        <th><span class="skeleton-box" style="width: 80px"></span></th>
                        <th><span class="skeleton-box" style="width: 60px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < 3; i++)
                    {
                        <tr>
                            <td>
                                <span class="skeleton-box skeleton-btn"></span>
                            </td>
                            <td><span class="skeleton-box" style="width: 60px"></span></td>
                            <td><span class="skeleton-box" style="width: 70px"></span></td>
                            <td>
                                <span class="skeleton-box skeleton-img"></span>
                            </td>
                            <td><span class="skeleton-box" style="width: 50px"></span></td>
                            <td><span class="skeleton-box" style="width: 50px"></span></td>
                            <td><span class="skeleton-box" style="width: 50px"></span></td>
                            <td><span class="skeleton-box" style="width: 50px"></span></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <div class="loading-progress">
            <div class="progress" style="height: 4px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 100%"></div>
            </div>
        </div>
    </div>
}
else
{
    @* ============ Existing Plot Plans Table ============ *@
    @if (_plotPlans.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead>
                <tr>
                    <th>Actions</th>
                    @foreach (var t in displayFields)
                    {
                        <th>@t</th>
                    }
                </tr>
                </thead>
                <tbody>
                @foreach (var plotPlan in _plotPlans)
                {
                    <tr class="@(plotPlan.KeyPlan ? "table-warning" : "")">
                        <td>
                            <button class="btn btn-danger btn-sm"
                                    @onclick="() => ConfirmAndDeletePlotPlan(plotPlan.Tag)"
                                    disabled="@_isDeleting"
                                    title="Delete @plotPlan.Tag">
                                @if (_isDeleting && _deletingTag == plotPlan.Tag)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                else
                                {
                                    <span>üóëÔ∏è</span>
                                }
                            </button>
                            @if (plotPlan.KeyPlan)
                            {
                                <span class="badge bg-warning text-dark ms-1" title="Key Plan">‚≠ê</span>
                            }
                        </td>
                        @for (int j = 0; j < displayFields.Count; j++)
                        {
                            var field = displayFields[j];
                            <td>
                                @if (field == "ImgThumbString" && !string.IsNullOrEmpty(plotPlan.ImgThumbString))
                                {
                                    <img src="@plotPlan.ImgThumbString" alt="Thumbnail"
                                         style="max-width: 100px; height: auto;"/>
                                }
                                else
                                {
                                    @GetPropertyValue(plotPlan, field)
                                }
                            </td>
                        }
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
    else
    {
        @* Empty State *@
        <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <p class="empty-text">No plot plans yet</p>
            <p class="empty-subtext">Add your first plot plan to get started</p>
        </div>
    }

    @* ============ Add Plan Section - Only shows after loading complete ============ *@
    @* ============ Ultra-Compact Toolbar Style with Validation ============ *@
    @if (!_isLoadingPlans)
    {
        <EditForm Model="@newImage" OnValidSubmit="@HandleSubmit" class="plot-toolbar-form">
            <DataAnnotationsValidator/>
            <CustomValidation @ref="customValidation"/>

            <div class="plot-toolbar">
                @* Left: Step Badge *@
                <div class="toolbar-section">
                    @if (showScaleSubmit || showCentreSubmit || showSaveSubmit)
                    {
                        <span class="step-badge step-@CurrentStep">
                            Step @CurrentStep/3: @(CurrentStep == 1 ? "Scale" : CurrentStep == 2 ? "Centre" : "Save")
                        </span>
                    }
                </div>

                @* Middle: Dynamic Content *@
                <div class="toolbar-section toolbar-main">

                    @* Initial: File Upload *@
                    @* File Upload - Use CSS to hide instead of removing from DOM *@
                    <div class="@GetFileUploadVisibility()">
                        <span class="toolbar-label">üìÅ Add Plan:</span>
                        <InputFile class="form-control form-control-sm toolbar-file"
                                   OnChange="@LoadPlotPlan" accept=".png,.jpg,.jpeg,.pdf"/>
                    </div>

                    @* Processing indicator shown separately *@
                    @if (showProcessing)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span class="ms-2">Processing...</span>
                    }





                    @* Preview *@
                    @if (showThumbImage)
                    {
                        <img src="@newImage.ImgThumbString" class="toolbar-thumb" alt=""/>
                        <button type="button" class="btn btn-sm btn-success" @onclick="DrawPlotPlan">‚úì Use</button>
                        <button type="button" class="btn btn-sm btn-light" @onclick="CancelUpload">‚úï</button>
                    }

                    @* Step 1: Scale *@
                    @if (showScaleSubmit)
                    {
                        _refPinTagList = ["X-Left", "X-Right", "Y-Bottom", "Y-Top"];
                        _ = UpdateRefPointTexts();
                        @* Tag List Display *@
                        <div class="tag-list">
                            <h5>Tags to Place (@_refPinTagList.Count)</h5>
            
                            @if (_refPinTagList.Count == 0)
                            {
                                <p class="empty-message">No tags defined. Add tags above to begin.</p>
                            }
                            else
                            {
                                <div class="tag-chips">
                                    @foreach (var (tag, index) in _refPinTagList.Select((t, i) => (t, i)))
                                    {
                                        <div class="tag-chip @(index < _currentIndex ? "placed" : "") @(index == _currentIndex && _refPinActive ? "current" : "")">
                                            <span class="tag-number">@(index + 1)</span>
                                            <span class="tag-name">@tag</span>
                                            @if (index < _currentIndex)
                                            {
                                                <span class="tag-status">‚úì</span>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        
                        @if (_plotPlans.Count==0)
                        {
                            @* For Key Plot Plan, no neeed for rotation since the user eneters the image/pdf 
                            in the same orientation that is expected to be rendered. User shall be asked to confirm if 
                            the X-Axis id for East-West orientation or North-South orientation thru check box *@
                            <div class="form-check table-check-item">
                                <span class="toolbar-label">X-Axis: Est-West</span>
                                <InputCheckbox class="form-check-input" 
                                               @bind-Value="@newImage.XEW" 
                                               @bind-Value:after="SetXEWForKeyPlan"/>
                            </div>
                        }else
                        {
                            @* For Subsequent Plots, rotation required to match the Key Plan orientation *@
                            @* Rotation can either be multiples of 90 deg or any other angle *@
                            @* Currently only multiples of 90 deg is implemented *@
                            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="RotatePlotPlan"
                                    title="Rotate 90¬∞">‚Ü©
                            </button>
                        }

                        <span class="toolbar-label">X:</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="@newImage.X1" placeholder="L" title="X-Left (m)"/>
                        <span class="text-muted">-</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="@newImage.X2" placeholder="R" title="X-Right (m)"/>

                        <span class="toolbar-label ms-2">Y:</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="@newImage.Y1" placeholder="B" title="Y-Bottom (m)"/>
                        <span class="text-muted">-</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="@newImage.Y2" placeholder="T" title="Y-Top (m)"/>

                        <span class="badge bg-info ms-2"
                              title="Reference points clicked">@(GlobalData.RefPoints?.Count ?? 0)/4 pts</span>
                    }
                    
                    @* ===== Pin Placement Control Section ===== *@
                    <div class="section">
                        <h4>Step 2: Place Pins on Map</h4>
                        
                        <div class="control-buttons">
                            @if (!_refPinActive)
                            {
                                <button @onclick="StartPinPlacement" 
                                        class="btn btn-success btn-lg"
                                        disabled="@(_refPinTagList.Count == 0)">
                                    üìç Start Pin Placement
                                </button>
                            }
                            else
                            {
                                <button @onclick="StopPinPlacement" class="btn btn-danger btn-lg">
                                    ‚èπ Stop Pin Placement
                                </button>
                            }
                            
                            <button @onclick="ResetPlacement" class="btn btn-secondary" disabled="@(!_hasPlacedPins)">
                                üîÑ Reset All
                            </button>
                        </div>
                        
                        @if (_refPinActive)
                        {
                            <div class="placement-instructions">
                                <div class="instruction-step">
                                    <span class="step-number">1</span>
                                    <span>Hold <kbd>SHIFT</kbd> key</span>
                                </div>
                                <div class="instruction-step">
                                    <span class="step-number">2</span>
                                    <span>Click on the map to place: <strong>@PinService.CurrentTag</strong></span>
                                </div>
                                <div class="instruction-step">
                                    <span class="step-number">3</span>
                                    <span>Release SHIFT to navigate, hold again to place next pin</span>
                                </div>
                            </div>
                            
                            <div class="progress-section">
                                <div class="progress-text">
                                    Progress: @_currentIndex / @_refPinTagList.Count pins placed
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: @GetProgressPercent()%"></div>
                                </div>
                            </div>
                        }
                    </div>
                    
                    @* ===== Placed Pins Summary ===== *@
                    @if (_placedPins.Count > 0)
                    {
                        <div class="section">
                            <h4>Placed Reference Points</h4>
                            
                            <table class="pins-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tag</th>
                                        <th>X</th>
                                        <th>Y</th>
                                        <th>E (Easting)</th>
                                        <th>N (Northing)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var (pin, index) in _placedPins.Select((p, i) => (p, i)))
                                    {
                                        <tr>
                                            <td>@(index + 1)</td>
                                            <td><strong>@pin.Tag</strong></td>
                                            <td>@pin.X.ToString("F2")</td>
                                            <td>@pin.Y.ToString("F2")</td>
                                            <td>@(pin.E?.ToString("F2") ?? "-")</td>
                                            <td>@(pin.N?.ToString("F2") ?? "-")</td>
                                            <td>
                                                <button class="btn btn-sm btn-danger" @onclick="() => RemovePlacedPin(pin.Tag)">
                                                    Remove
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    

                    @* Step 2: Centre - Key Plan *@
                    @if (showCentreSubmit && _plotPlans.Count == 0)
                    {
                        _refPinTagList = ["Centre (0,0)"];
                        _ = UpdateRefPointTexts();
                        <span class="toolbar-label">Local:</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="@newImage.LocalE" placeholder="E" title="Local Reference E"/>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="@newImage.LocalN" placeholder="N" title="Local Reference N"/>

                        <span class="toolbar-label ms-2">Global:</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="@newImage.GlobalE" placeholder="E" title="Global Reference E"/>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="@newImage.GlobalN" placeholder="N" title="Global Reference N"/>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="@newImage.AngleTrueNorth" placeholder="Deg" title="True North Angle (Clockwise)"/>

                        <span class="toolbar-label ms-2">Z:</span>
                        <InputNumber class="form-control form-control-sm" style="width:50px"
                                     @bind-Value="@newImage.Z" title="Elevation"/>
                    }

                    @* Step 2: Centre - Subsequent Plan *@
                    @if (showCentreSubmit && _plotPlans.Count > 0)
                    {
                        _refPinTagList = ["Ref-New", "Ref-Key"];
                        _ = UpdateRefPointTexts();
                        <span class="text-muted small">
                            <i class="bi bi-info-circle"></i> Ctrl+Click: New plan ‚Üí Key plan ref
                        </span>
                        <span class="badge bg-info ms-2"
                              title="Reference points clicked">@(GlobalData.RefPoints?.Count ?? 0)/2 pts</span>
                    }

                    @* Step 3: Save *@
                    @if (showSaveSubmit)
                    {
                        @if (_plotPlans.Count == 0)
                        {
                            <span class="badge bg-warning text-dark" title="This will be the primary reference plan">‚≠ê Key Plan</span>
                        }

                        <span class="toolbar-label">Name:</span>
                        <InputText class="form-control form-control-sm" style="width:140px"
                                   @bind-Value="@newImage.Tag" placeholder="Required"/>
                        <ValidationMessage For="@(() => newImage.Tag)" class="validation-inline"/>

                        <span class="toolbar-label">Desc:</span>
                        <InputText class="form-control form-control-sm" style="width:180px"
                                   @bind-Value="@newImage.TagDescription" placeholder="Optional"/>

                        <span class="toolbar-label">Remark:</span>
                        <InputText class="form-control form-control-sm" style="width:100px"
                                   @bind-Value="@newImage.Remark"/>
                    }
                </div>

                @* Right: Action Buttons *@
                <div class="toolbar-section toolbar-actions">
                    @if (showScaleSubmit)
                    {
                        <button type="button" class="btn btn-sm btn-primary" @onclick="TryScalePlotPlan">
                            Apply ‚Üí
                        </button>
                    }
                    @if (showCentreSubmit)
                    {
                        <button type="button" class="btn btn-sm btn-primary" @onclick="TryCentrePlotPlan">
                            Apply ‚Üí
                        </button>
                    }
                    @if (showSaveSubmit)
                    {
                        <button type="submit" class="btn btn-sm btn-success" disabled="@_isSaving">
                            @if (_isSaving)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                            }
                            else
                            {
                                <span>üíæ Save</span>
                            }
                        </button>
                    }
                    @if (showScaleSubmit || showCentreSubmit || showSaveSubmit)
                    {
                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="ConfirmAndDiscard"
                                disabled="@_isSaving" title="Discard and start over">‚úï</button>
                    }
                </div>
            </div>

            @* Validation Summary - shown below toolbar when errors exist *@
            <ValidationSummary class="validation-summary"/>

        </EditForm>
    }
}

@code {
    #region Parameters & Fields

    [Parameter]
    public Plot? PlotComponent { get; set; }
    
    // ===== State =====
    private bool _refPinActive = false;
    private int _currentIndex = 0;
    private string _newTag = "";
    private List<PlacedPin> _placedPins = new();
    private bool _hasPlacedPins => _placedPins.Count > 0;
    
    

    // Data
    private PlotPlan newImage = new();
    private List<PlotPlan> _plotPlans = new();
    private readonly List<ClickedPoint> ClickedPoints = new();

    // UI State
    private readonly bool hideFileOpen = false;
    private bool showThumbImage = false;
    private bool showProcessing = false;
    private bool showCentreSubmit = false;
    private bool showScaleSubmit = false;
    private bool showSaveSubmit = false;
    private bool _isLoading = false;
    private bool _isSaving = false;
    private bool _isDeleting = false;
    private string? _deletingTag;
    private string? filenme;
    private bool _isPdfFile = false;
    private int _pdfPageCount = 1;
    private int _selectedPdfPage = 0;
    
    // ============ Loading State Variables ============
    private bool _isLoadingPlans = true;

    // Rendering control
    private bool shouldRenderUIChanges = true;
    protected override bool ShouldRender() => shouldRenderUIChanges;

    private List<string> _refPinTagList = [];

    // Messages
    private string? _errorMessage;
    private string? _successMessage;

    // Validation
    private CustomValidation? customValidation;

    // Display fields
    private readonly List<string> displayFields = new()
    {
        "Tag", "TagDescription", "ImgThumbString", "X1", "X2", "Y1", "Y2", "Z", "Opacity",
        "Width", "Height", "ScaleX", "ScaleY", "CentreX", "CentreY",
        "GlobalE", "GlobalN", "KeyPlan"
    };

    private int CurrentStep => showScaleSubmit ? 1 : showCentreSubmit ? 2 : showSaveSubmit ? 3 : 0;

    #endregion

    #region Lifecycle
    
    protected override void OnInitialized()
    {
        // Subscribe to pin service events
        PinService.OnStateChanged += OnPinServiceChanged;
        PinService.OnPinPlaced += OnPinPlaced;
        PinService.OnAllPinsPlaced += OnAllPinsPlaced;
    }


    protected override async Task OnInitializedAsync()
    {
        _isLoadingPlans = true;
        
        try
        {
            // Load plot plans from database/service
            _plotPlans = await PlotPlanService.GetAllAsync() ?? new List<PlotPlan>();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load plot plans: {ex.Message}";
        }
        finally
        {
            // Images will load progressively in the browser (better UX)
            _isLoadingPlans = false;
        }
        
        await base.OnInitializedAsync();
    }
    public void Dispose()
    {
        PinService.OnStateChanged -= OnPinServiceChanged;
        PinService.OnPinPlaced -= OnPinPlaced;
        PinService.OnAllPinsPlaced -= OnAllPinsPlaced;
    }
    

    #endregion

   #region Delete Operations

    /// <summary>
    /// Confirm and delete a plot plan with appropriate warnings
    /// </summary>
    private async Task ConfirmAndDeletePlotPlan(string tag)
    {
        var plan = _plotPlans.FirstOrDefault(p => p.Tag == tag);
        if (plan == null) return;

        // Initial confirmation
        string message = plan.KeyPlan
            ? "‚ö†Ô∏è This is the KEY PLAN (reference for all other plans).\n\nDeleting it will reposition all other plans. Continue?"
            : $"Delete plot plan '{tag}'?";

        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", message);
        if (!confirmed) return;

        _isDeleting = true;
        _deletingTag = tag;
        ClearMessages();
        StateHasChanged();

        try
        {
            bool wasKeyPlan = plan.KeyPlan;
            float deltaE = 0, deltaN = 0;

            // Handle key plan deletion
            if (wasKeyPlan)
            {
                if (_plotPlans.Count > 1)
                {
                    // Additional confirmation for key plan deletion
                    bool confirmedKeyPlan = await ConfirmKeyPlanDeletion();
                    if (!confirmedKeyPlan)
                    {
                        return; // User cancelled
                    }

                    // Find and promote the next plan
                    var newKeyPlan = _plotPlans.FirstOrDefault(p => p.Tag != tag);
                    if (newKeyPlan != null)
                    {
                        // Calculate deltas for JS repositioning (before service call updates values)
                        deltaE = plan.GlobalE - newKeyPlan.GlobalE;
                        deltaN = plan.GlobalN - newKeyPlan.GlobalN;

                        // Promote new key plan via service
                        await PlotPlanService.PromoteToKeyPlanAsync(newKeyPlan, plan);

                        // Update Three.js scene - reposition all planes
                        await SafeJsInvoke("repositionAllPlanes", deltaE, deltaN);
                    }
                }
                else
                {
                    // Deleting the only/last plan
                    bool confirmedLastPlan = await ConfirmLastPlanDeletion();
                    if (!confirmedLastPlan)
                    {
                        return; // User cancelled
                    }
                }
            }

            // Remove from 3D scene
            await SafeJsInvoke("removePlane", plan.Tag);

            // Delete from database via service
            await PlotPlanService.DeletePlotPlanAsync(plan);

            // Refresh local list
            _plotPlans = await PlotPlanService.GetAllAsync();

            _successMessage = $"Plot plan '{tag}' deleted successfully.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to delete plot plan: {ex.Message}";
            Debug.WriteLine($"DeletePlotPlan error: {ex}");
        }
        finally
        {
            _isDeleting = false;
            _deletingTag = null;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Confirm deletion of the key plan (will trigger repositioning)
    /// </summary>
    private async Task<bool> ConfirmKeyPlanDeletion()
    {
        return await JsRuntime.InvokeAsync<bool>("confirm",
            "‚ö†Ô∏è IMPORTANT: You are deleting the KEY PLAN.\n\n" +
            "This will:\n" +
            "‚Ä¢ Promote another plan to be the new key plan\n" +
            "‚Ä¢ Update the project's global reference coordinates\n" +
            "‚Ä¢ Reposition all other plans relative to the new key plan\n\n" +
            "This action cannot be undone. Continue?");
    }

    /// <summary>
    /// Confirm deletion of the last/only plan
    /// </summary>
    private async Task<bool> ConfirmLastPlanDeletion()
    {
        return await JsRuntime.InvokeAsync<bool>("confirm",
            "‚ö†Ô∏è WARNING: This is the ONLY plot plan for this project.\n\n" +
            "Deleting it will remove all spatial reference for this project.\n\n" +
            "Are you sure you want to delete it?");
    }

    #endregion

    #region Upload & Processing

    private async Task LoadPlotPlan(InputFileChangeEventArgs e)
    {
        showProcessing = true;
        showThumbImage = false;
        ResetSteps();
        ClearMessages();
        filenme = e.File.Name;
        StateHasChanged();

        try
        {
            _isPdfFile = e.File.ContentType.ToLower() == "application/pdf";

            if (_isPdfFile)
            {
                //TODO : PDF render currently not working 
                newImage = await PlotPlanService.LoadPdfAsync(e, _selectedPdfPage, 150);
            }
            else
            {
                newImage = await PlotPlanService.LoadImageAsync(e);
            }
            
            newImage.ProjectId = GlobalData.SelectedProject?.Tag ?? "";
            newImage.OptionId = "base";
            newImage.Opacity = 1;
            newImage.UpdatedOn = DateTime.Now;
            newImage.Remark = "";
            newImage.XEW = true;

            showThumbImage = true;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to process image: {ex.Message}";
            Debug.WriteLine($"LoadPlotPlan error: {ex}");
        }
        finally
        {
            showProcessing = false;
            StateHasChanged();
        }
    }

    private void CancelUpload()
    {
        showThumbImage = false;
        ResetSteps();
        newImage = new PlotPlan();
        filenme = null;
    }

    #endregion

    #region Draw & Configure

    private async Task DrawPlotPlan()
    {
        newImage.Tag = $"plotplan_{DateTime.Now:yyyyMMdd_HHmmss}";
        newImage.X1 = 0;
        newImage.X2 = 0;
        newImage.Y1 = 0;
        newImage.Y2 = 0;
        newImage.Width = 0;
        newImage.Height = 0;
        newImage.ScaleX = 1;
        newImage.ScaleY = 1;
        newImage.CentreX = 0;
        newImage.CentreY = 0;
        newImage.Rotation = 0;

        // Set Z level above existing plans
        if (_plotPlans.Count > 0)
        {
            var keyPlan = _plotPlans.Find(plot => plot.KeyPlan);
            newImage.Z = (keyPlan?.Z ?? 0) + 0.01f;
        }

        await DrawPlan(newImage);

        showThumbImage = false;
        showScaleSubmit = true;
        await ShowHidePlotinPlotDotRazor();
    }

    private async Task ShowHidePlotinPlotDotRazor()
    {
        if (PlotComponent != null)
        {
            await PlotComponent.HidePlotPlan();
        }
    }

    private async Task DrawPlan(PlotPlan plotPlan)
    {
        var planeName = "plotplan";
        var planeTag = plotPlan.Tag;

        if (!await SafeJsInvoke("drawPlane", planeName, planeTag, newImage.ImgString,
                plotPlan.ScaleX, plotPlan.ScaleY, plotPlan.CentreX, plotPlan.CentreY,
                newImage.Z, newImage.Opacity))
        {
            _errorMessage = "Failed to draw plot plan in 3D view.";
        }
        else
        {
            Debug.WriteLine($"Plot plan '{planeName}' drawn.");
        }
    }

    private async Task RotatePlotPlan()
    {
        var previousRotationAngleDeg = Math.Round(newImage.Rotation * 90 / Math.PI,0);
        newImage.Rotation += (float)Math.PI / 2;
        var newRotationAngleDeg = Math.Round(newImage.Rotation * 90 / Math.PI,0);
        Debug.WriteLine($"Rotating plot plan from {previousRotationAngleDeg} to {newRotationAngleDeg} degrees");
        await SafeJsInvoke("rotatePlane", (float)Math.PI / 2);
    }




    private async Task UpdateRefPointTexts()
    {
        if (_refPinTagList.Count == 0) return;
        
        //_refPinTagList = ["X-Left", "X-Right", "Y-Bottom", "Y-Top", "Centre (0,0)","Ref-New Plan", "Ref-Key Plan"];
        if (!await SafeJsInvoke("updateRefPointTexts", _refPinTagList))
        {
            _errorMessage = $"Unable to update _refPinTagList = '{_refPinTagList}'.";
        }
        else
        {
            Debug.WriteLine($"Successfully updated _refPinTagList = '{_refPinTagList}'.");
        }
    }

    #endregion

    #region Scale & Centre


    private void SetXEWForKeyPlan()
    {
        // if there was no Key Plan yet, temporary assign the X Axis East-West / North-South orientation as per this loaded plot plan
        if (_plotPlans.Count == 0)
        {
            GlobalData.SelectedProject.XEW = newImage.XEW;
            Debug.WriteLine($"XEW changed to: {newImage.XEW}");
        }
    }

    private async Task TryScalePlotPlan()
    {
        customValidation?.ClearErrors();
        var errors = new Dictionary<string, List<string>>();

        // Check reference points
        if (GlobalData.RefPoints == null || GlobalData.RefPoints.Count != 4)
        {
            errors.Add("RefPoints", new List<string> { "Please click 4 reference points on the image (2 for X-axis, 2 for Y-axis)." });
        }

        // Validate coordinate values
        if (Math.Abs(newImage.X2 - newImage.X1) < 0.01f)
        {
            errors.Add(nameof(newImage.X1), new List<string> { "X1 and X2 must have a meaningful difference (at least 0.01m)." });
        }

        if (Math.Abs(newImage.Y2 - newImage.Y1) < 0.01f)
        {
            errors.Add(nameof(newImage.Y1), new List<string> { "Y1 and Y2 must have a meaningful difference (at least 0.01m)." });
        }

        // if (newImage.X1 >= newImage.X2 || newImage.Y1 >= newImage.Y2)
        // {
        //     errors.Add(nameof(newImage.X1), new List<string> { "X1 must be less than X2, and Y1 must be less than Y2." });
        // }

        if (errors.Any())
        {
            customValidation?.DisplayErrors(errors);
        }
        else
        {
            await ScalePlotPlan();
            showScaleSubmit = false;
            showCentreSubmit = true;
        }
    }

    private async Task ScalePlotPlan()
    {
        if (GlobalData.RefPoints == null || GlobalData.RefPoints.Count != 4) return;

        var LX = GlobalData.RefPoints[1].X - GlobalData.RefPoints[0].X;
        var LY = GlobalData.RefPoints[3].Y - GlobalData.RefPoints[2].Y;

        if (Math.Abs(LX) < 1 || Math.Abs(LY) < 1 ||
            Math.Abs(newImage.X1 - newImage.X2) < 1 ||
            Math.Abs(newImage.Y1 - newImage.Y2) < 1) return;

        var scaleX = (newImage.X2 - newImage.X1) / LX;
        var scaleY = (newImage.Y2 - newImage.Y1) / LY;
        
        // For Key Plot Plan, temporarily assign the polarity of the scale
        // for calculating the Local EN correctly
        if (_plotPlans.Count == 0)
        {
            GlobalData.SelectedProject.PositiveScaleX = scaleX > 0;
            GlobalData.SelectedProject.PositiveScaleY = scaleY > 0;
        }

        // Image scale has to be positive, otherwise the image would get rendered reversed
        scaleX = Math.Abs(scaleX);
        scaleY = Math.Abs(scaleY);

        newImage.ScaleX = scaleX;
        newImage.ScaleY = scaleY;

        if (GlobalData.sceneDataCurrent != null)
        {
            newImage.RendererWidth = GlobalData.sceneDataCurrent.RendererWidth;
            newImage.RendererHeight = GlobalData.sceneDataCurrent.RendererHeight;
        }

        Debug.WriteLine("Scaling the plot plan");
        await SafeJsInvoke("scalePlane", scaleX, scaleY);

        showScaleSubmit = false;
        showCentreSubmit = true;
        showSaveSubmit = false;

        GlobalData.RefPoints?.Clear();
        
    }

    private async Task TryCentrePlotPlan()
    {
        customValidation?.ClearErrors();
        var errors = new Dictionary<string, List<string>>();
        
        
                
        // for the Key Plot Plan
        if (_plotPlans.Count == 0)
        {
            // Check reference points
            if (GlobalData.RefPoints == null || GlobalData.RefPoints.Count != 1)
            {
                errors.Add("RefPoints", new List<string> { "Please click the reference points on the image as the Centre (0,0) of the Key Plot Plan)." });
            }
            // For Key Plot Plan, Local EN (newImage.LocalE, newImage.LocalN) are must.
            // There can be a separate Global coordinate Reference (newImage.GlobalE, newImage.GlobalN), else the Global EN is considered as same as Local EN
            // Elevation, by default newImage.Z = 0
            

            if (newImage.LocalE == 0 && newImage.LocalN == 0)
            {
                errors.Add(nameof(newImage.GlobalE), new List<string> { "Both E and N of local coordinates are required. Global EN coordinates are optional." });
            }

            if (errors.Any())
            {
                customValidation?.DisplayErrors(errors);
            }
            else
            {
                await CentrePlotPlan();
                showCentreSubmit = false;
                showSaveSubmit = true;
            }
        }
        else
        {
            // For subsequent plot plans
            // Check reference points
            if (GlobalData.RefPoints == null || GlobalData.RefPoints.Count != 2)
            {
                errors.Add("RefPoints", new List<string> { "Please click 2 reference points on the image (1 for Ref-New, 2 for Ref-Key Plan)." });
            }

            if (errors.Any())
            {
                customValidation?.DisplayErrors(errors);
            }
            else
            {
                await CentrePlotPlan();
                showCentreSubmit = false;
                showSaveSubmit = true;
            }
            
        }
    }

    private async Task CentrePlotPlan()
    {
        Debug.WriteLine("Centering the plot plan");
        if (GlobalData.RefPoints?.Count == 0) return;
        
        var centreX = 0f;
        var centreY = 0f;

        if (_plotPlans.Count > 0 && GlobalData.RefPoints is { Count: 2 })
        {
            // For subsequent plot plans
            centreX = GlobalData.RefPoints[0].X-GlobalData.RefPoints[1].X;
            centreY = GlobalData.RefPoints[0].Y -GlobalData.RefPoints[1].Y;
            
            newImage.KeyPlan = false;
        }
        else if (_plotPlans.Count == 0 && GlobalData.RefPoints is { Count: 1 })
        {
            // For Key Plot Plan
            centreX = GlobalData.RefPoints[0].X;
            centreY = GlobalData.RefPoints[0].Y;
            
            newImage.KeyPlan = true;
        }

        newImage.CentreX = centreX;
        newImage.CentreY = centreY;

        await SafeJsInvoke("centrePlane", centreX, centreY, newImage.Z);

        showCentreSubmit = false;
        showSaveSubmit = true;
        ClickedPoints.Clear();
        GlobalData.RefPoints?.Clear();
        
                   
        // if there was no Key Plan yet, temporary assign the Local and Global EN values as per this loaded plot plan
        if (_plotPlans.Count == 0)
        {
            GlobalData.SelectedProject.LocalE = newImage.LocalE;
            GlobalData.SelectedProject.LocalN = newImage.LocalN;
            GlobalData.SelectedProject.LocalE = newImage.GlobalE;
            GlobalData.SelectedProject.GlobalN = newImage.GlobalN;
            GlobalData.SelectedProject.XEW = newImage.XEW;
            GlobalData.SelectedProject.AngleTrueNorth = newImage.AngleTrueNorth;
        }

        
    }

    #endregion

    #region Save

    private async Task HandleSubmit()
    {
        customValidation?.ClearErrors();
        var errors = new Dictionary<string, List<string>>();

        if (string.IsNullOrWhiteSpace(newImage.Tag))
        {
            errors.Add(nameof(newImage.Tag), new List<string> { "Name is required." });
        }
        else if (_plotPlans.Any(p => p.Tag?.Equals(newImage.Tag, StringComparison.OrdinalIgnoreCase) == true))
        {
            errors.Add(nameof(newImage.Tag), new List<string> { "A plot plan with this name already exists." });
        }

        if (errors.Any())
        {
            customValidation?.DisplayErrors(errors);
        }
        else
        {
            await SavePlotPlan();
        }
    }

    private async Task SavePlotPlan()
    {
        Debug.WriteLine($"Saving plot plan. KeyPlan: {newImage.KeyPlan}");
        _isSaving = true;
        ClearMessages();
        StateHasChanged();
        
        try
        {
            await PlotPlanService.SavePlotPlanAsync(newImage);
            _successMessage = $"Plot plan '{newImage.Tag}' saved successfully.";
            _plotPlans = await PlotPlanService.GetAllAsync();
            newImage = new PlotPlan();
            ResetSteps();
            ClickedPoints.Clear();
            GlobalData.RefPoints?.Clear();
            customValidation?.ClearErrors();
            filenme = null;
            
            // Save Project with default coordinate system for the Key Plot Plan
            // Additional coordinate systems will be saved separately
            if (newImage.KeyPlan)
            {
                var defaultCoordinateSystem = new CoordinateSystem()
                {
                    Name = "", //Default
                    Description = "Default for KeyPlan",
                    Unit = "m",
                    ReferenceSceneX = 0,
                    ReferenceSceneY = 0,
                    ReferenceX = newImage.CentreX, // Key Plot Plan Easting
                    ReferenceY = newImage.CentreY, // Key Plot Plan Northing
                    RotationDegrees = 0, // Key Plot Plan True North offset
                    ScaleX = newImage.X2>newImage.X1?1:-1,
                    ScaleY = newImage.Y2>newImage.Y1?1:-1
                };
                GlobalData.SelectedProject?.CoordinateSystems.Clear();
                GlobalData.SelectedProject?.CoordinateSystems.Add(defaultCoordinateSystem);
                GlobalData.SelectedProject?.CoordinateSystemJson = 
                    JsonSerializer.Serialize(GlobalData.SelectedProject.CoordinateSystems);
                await SaveProject();
            }
            
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to save plot plan: {ex.Message}";
            Debug.WriteLine($"Error saving plot plan: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
            ClickedPoints.Clear();
            StateHasChanged();
            
        }
    }

    private async Task SaveProject()
    {
        // Save Project with added coordinate system
        // This includes default and/or any additional coordinate systems added separately
        try
        {
            var saveProject = await Table.UpdateAsync(GlobalData.SelectedProject);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error in saving project with coordinate details: {ex.Message}";
            Debug.WriteLine(_errorMessage); Console.WriteLine(_errorMessage);
        }
    }
    
    /// <summary>
    /// Confirm and discard the current plot plan import, resetting back to file selection
    /// </summary>
    private async Task ConfirmAndDiscard()
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm",
            "‚ö†Ô∏è Discard this plot plan?\n\n" +
            "All changes will be lost and you'll need to import the image again.\n\n" +
            "Continue?");

        if (confirmed)
        {
            await DiscardAndReset();
        }
    }

    /// <summary>
    /// Discard the current import and reset to initial state
    /// </summary>
    private async Task DiscardAndReset()
    {
        // Remove the plane from 3D scene if it was drawn
        if (!string.IsNullOrEmpty(newImage.Tag))
        {
            await SafeJsInvoke("removePlane", newImage.Tag);
        }

        // Reset all state
        newImage = new PlotPlan();
        filenme = null;
        ResetSteps();
        ClickedPoints.Clear();
        GlobalData.RefPoints?.Clear();
        customValidation?.ClearErrors();
        ClearMessages();

        // Show the Plot component again if it was hidden
        if (PlotComponent != null)
        {
            await PlotComponent.HidePlotPlan();
        }

        _successMessage = "Plot plan discarded. You can import a new image.";
        StateHasChanged();
    }

    #endregion

    #region Helper Methods

    private async Task RefreshAndReadPlotPlanFromDB()
    {
        (GlobalData.PlotPlans, _, _, _) = await DataService.RefreshCacheAndReadFromDb<PlotPlan>();
        _plotPlans = GlobalData.PlotPlans ?? new List<PlotPlan>();
    }

    private async Task<bool> SafeJsInvoke(string identifier, params object[] args)
    {
        try
        {
            await JsRuntime.InvokeVoidAsync(identifier, args);
            return true;
        }
        catch (JSException ex)
        {
            _errorMessage = $"3D rendering error: {ex.Message}";
            Debug.WriteLine($"JS Interop failed for {identifier}: {ex}");
            return false;
        }
    }

    private string GetPropertyValue(PlotPlan plotPlan, string propertyName)
    {
        var property = typeof(PlotPlan).GetProperty(propertyName);
        if (property == null) return string.Empty;

        var value = property.GetValue(plotPlan);

        // Format numbers nicely
        if (value is float f) return f.ToString("F2");
        if (value is double d) return d.ToString("F2");
        if (value is bool b) return b ? "Yes" : "No";

        return value?.ToString() ?? string.Empty;
    }

    private string GetProgressBarClass(int step)
    {
        if (CurrentStep > step) return "bg-success";
        if (CurrentStep == step) return "bg-primary";
        return "bg-secondary";
    }

    private void ResetSteps()
    {
        showScaleSubmit = false;
        showCentreSubmit = false;
        showSaveSubmit = false;
    }

    private void ClearMessages()
    {
        _errorMessage = null;
        _successMessage = null;
    }

    #endregion
    
    
    // ============ Helper Methods ============
    
    private int GetProgressPercent()
    {
        if (_refPinTagList.Count == 0) return 0;
        return (int)(_currentIndex * 100.0 / _refPinTagList.Count);
    }
    
    /// <summary>
    /// Returns CSS class to show/hide file upload (using CSS, not conditional rendering)
    /// </summary>
    private string GetFileUploadVisibility()
    {
        if (showProcessing || showThumbImage || showScaleSubmit || showCentreSubmit || showSaveSubmit)
        {
            return "d-none";
        }
        return "d-flex align-items-center gap-2";
    }
    
    
    // ===== Event Handlers =====
    
    private void OnPinServiceChanged()
    {
        _currentIndex = PinService.CurrentTagIndex;
        _refPinActive = PinService.IsActive;
        InvokeAsync(StateHasChanged);
    }

    private void OnPinPlaced(string tag, double x, double y, double z)
    {
        _placedPins.Add(new PlacedPin
        {
            Tag = tag,
            X = x,
            Y = y,
            Z = z,
            // Calculate E/N if you have the function available
            // E = ..., N = ...
        });
        _currentIndex = PinService.CurrentTagIndex;
        InvokeAsync(StateHasChanged);
    }

    private void OnAllPinsPlaced()
    {
        _refPinActive = false;
        InvokeAsync(StateHasChanged);
    }

    // ===== Tag Management =====
    
    private void AddTag()
    {
        if (string.IsNullOrWhiteSpace(_newTag)) return;
        
        var tag = _newTag.Trim().ToUpper();
        if (!_refPinTagList.Contains(tag))
        {
            _refPinTagList.Add(tag);
        }
        _newTag = "";
    }





    // ===== Pin Placement Control =====
    
    private void StartPinPlacement()
    {
        if (_refPinTagList.Count == 0) return;
        
        // Start placement with our tag list
        PinService.StartPlacement(_refPinTagList);
        _refPinActive = true;
        _currentIndex = 0;
    }

    private void StopPinPlacement()
    {
        PinService.StopPlacement();
        _refPinActive = false;
    }

    private void ResetPlacement()
    {
        PinService.Reset();
        _placedPins.Clear();
        _currentIndex = 0;
        // TODO: Call JS to clear pins from scene
    }

    private void RemovePlacedPin(string tag)
    {
        _placedPins.RemoveAll(p => p.Tag == tag);
        // TODO: Call JS to remove pin from scene
    }
    
    
    
    
    // ===== Models =====
    
    private class PlacedPin
    {
        public string Tag { get; set; } = "";
        public double X { get; set; }
        public double Y { get; set; }
        public double Z { get; set; }
        public double? E { get; set; }
        public double? N { get; set; }
    }
    
}
