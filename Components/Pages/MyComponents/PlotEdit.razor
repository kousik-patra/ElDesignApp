@* ============================================================================
   PlotEdit.razor - Plot Plan Editor Component (Revised)
   ============================================================================
   Purpose:
   1. List existing plot plans in a table and render them in the 3D scene
   2. Provide UI for users to add new plot plans through a 5-step workflow
   3. Manage coordinate systems for the project
   
   Step Workflow:
   A - Upload: Select and preview PDF/JPG/PNG file
   B - Orientation: Align plot with scene (X-axis direction for Key Plan, rotation for others)
   C - Scale: Pin 4 reference points and enter X1,X2,Y1,Y2 values
   D - Position: Pin origin point(s) and set elevation
   E - Save: Enter metadata and save to database
   ============================================================================ *@

@rendermode InteractiveServer
@attribute [StreamRendering]
@implements IDisposable

@using System.Diagnostics
@using System.Numerics
@using System.Text.Json
@using ElDesignApp.Data
@using ElDesignApp.Models
@using ElDesignApp.Services
@using ElDesignApp.Services.DataBase
@using Microsoft.JSInterop

@inject IJSRuntime JsRuntime
@inject NavigationManager MyNavigationManager
@inject IDataRetrievalService DataService
@inject ITableService Table
@inject IGlobalDataService GlobalData
@inject IPlotPlanService PlotPlanService
@inject PinPlacementService PinService

@* ============================================================================
   SECTION: Messages (Error/Success Alerts)
   ============================================================================ *@
@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @_errorMessage
        <button type="button" class="btn-close" @onclick="() => _errorMessage = null"></button>
    </div>
}
@if (!string.IsNullOrEmpty(_successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @_successMessage
        <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
    </div>
}

@* ============================================================================
   SECTION: Plot Plans Section with Loading State
   ============================================================================ *@
@if (_isLoadingPlans)
{
    <div class="loading-container">
        <div class="loading-header">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="loading-text">Loading plot plans...</span>
        </div>
        
        @* Skeleton Table *@
        <div class="table-responsive">
            <table class="table table-striped table-sm skeleton-table">
                <thead>
                    <tr>
                        <th style="width: 80px"><span class="skeleton-box" style="width: 50px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                        <th><span class="skeleton-box" style="width: 80px"></span></th>
                        <th><span class="skeleton-box" style="width: 60px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                        <th><span class="skeleton-box" style="width: 40px"></span></th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < 3; i++)
                    {
                        <tr>
                            <td>
                                <span class="skeleton-box skeleton-btn"></span>
                            </td>
                            <td><span class="skeleton-box" style="width: 60px"></span></td>
                            <td><span class="skeleton-box" style="width: 70px"></span></td>
                            <td>
                                <span class="skeleton-box skeleton-img"></span>
                            </td>
                            <td><span class="skeleton-box" style="width: 50px"></span></td>
                            <td><span class="skeleton-box" style="width: 50px"></span></td>
                            <td><span class="skeleton-box" style="width: 50px"></span></td>
                            <td><span class="skeleton-box" style="width: 50px"></span></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <div class="loading-progress">
            <div class="progress" style="height: 4px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 100%"></div>
            </div>
        </div>
    </div>
}
else
{
    @* ============================================================================
       SECTION: Existing Plot Plans Table
       ============================================================================ *@
    @if (_plotPlans.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead>
                <tr>
                    <th>Actions</th>
                    @foreach (var t in displayFields)
                    {
                        <th>@t</th>
                    }
                </tr>
                </thead>
                <tbody>
                @foreach (var plotPlan in _plotPlans)
                {
                    <tr class="@(plotPlan.KeyPlan ? "table-warning" : "")">
                        <td>
                            <button class="btn btn-danger btn-sm"
                                    @onclick="() => ConfirmAndDeletePlotPlan(plotPlan.Tag)"
                                    disabled="@_isDeleting"
                                    title="Delete @plotPlan.Tag">
                                @if (_isDeleting && _deletingTag == plotPlan.Tag)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                else
                                {
                                    <span>üóëÔ∏è</span>
                                }
                            </button>
                            @if (plotPlan.KeyPlan)
                            {
                                <span class="badge bg-warning text-dark ms-1" title="Key Plan">‚≠ê</span>
                            }
                        </td>
                        @for (int j = 0; j < displayFields.Count; j++)
                        {
                            var field = displayFields[j];
                            <td>
                                @if (field == "ImgThumbString" && !string.IsNullOrEmpty(plotPlan.ImgThumbString))
                                {
                                    <img src="@plotPlan.ImgThumbString" alt="Thumbnail"
                                         style="max-width: 100px; height: auto;"/>
                                }
                                else
                                {
                                    @GetPropertyValue(plotPlan, field)
                                }
                            </td>
                        }
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
    else
    {
        @* Empty State *@
        <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <p class="empty-text">No plot plans yet</p>
            <p class="empty-subtext">Add your first plot plan to get started. It will become the Key Plan.</p>
        </div>
    }

    @* ============================================================================
       SECTION: Add New Plot Plan - 5-Step Workflow
       ============================================================================ *@
        <EditForm Model="@_newPlan" OnValidSubmit="@HandleSaveSubmit" class="plot-toolbar-form">
            <DataAnnotationsValidator/>
            <CustomValidation @ref="_customValidation"/>

            @* Step Progress Indicator *@
            @if (_currentStep != ImportStep.None)
            {
                <div class="step-progress mb-2">
                    <div class="d-flex align-items-center gap-2">
                        @foreach (var step in Enum.GetValues<ImportStep>().Where(s => s != ImportStep.None))
                        {
                            var stepNum = (int)step;
                            var isActive = step == _currentStep;
                            var isComplete = stepNum < (int)_currentStep;
                            <div class="step-indicator @(isActive ? "active" : "") @(isComplete ? "complete" : "")">
                                <span class="step-letter">@step.ToString()[0]</span>
                                <span class="step-name d-none d-md-inline">@GetStepName(step)</span>
                            </div>
                            @if (step != ImportStep.Save)
                            {
                                <div class="step-connector @(isComplete ? "complete" : "")"></div>
                            }
                        }
                    </div>
                </div>
            }

            <div class="plot-toolbar">
                @* ================================================================
               STEP A: Upload File
               ================================================================ *@
                @if (_currentStep == ImportStep.None)
                {
                    <div class="toolbar-section">
                        <span class="toolbar-label">üìÅ Add Plot Plan:</span>
                        <InputFile class="form-control form-control-sm toolbar-file"
                                   OnChange="@HandleFileUpload"
                                   accept=".png,.jpg,.jpeg,.pdf"/>
                    </div>
                }

                @* Processing Indicator *@
                @if (_isProcessingFile)
                {
                    <div class="toolbar-section">
                        <span class="spinner-border spinner-border-sm"></span>
                        <span class="ms-2">Processing file...</span>
                    </div>
                }

                @* Preview After Upload *@
                @if (_showPreview && _currentStep == ImportStep.None)
                {
                    <div class="toolbar-section">
                        <img src="@_newPlan.ImgThumbString" class="toolbar-thumb" alt="Preview"/>
                        <span class="text-muted small">@_uploadedFileName</span>
                        <button type="button" class="btn btn-sm btn-success" @onclick="AcceptUploadAndProceed">
                            ‚úì Accept
                        </button>
                        <button type="button" class="btn btn-sm btn-light" @onclick="CancelUpload">
                            ‚úï Cancel
                        </button>
                    </div>
                }

                @* ================================================================
               STEP B: Orientation / Alignment
               ================================================================ *@
                @if (_currentStep == ImportStep.Orientation)
                {
                    <div class="toolbar-section">
                        <span class="step-badge step-b">Step B: Orientation</span>
                    </div>

                    <div class="toolbar-section toolbar-main">
                        @if (IsKeyPlan)
                        {
                            @* Key Plan: X-Axis Direction Selection *@
                            <span class="toolbar-label">X-Axis Direction:</span>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="xAxisDir" id="xAxisEW"
                                       checked="@_newPlan.XEW" @onchange="() => SetXAxisDirection(true)">
                                <label class="btn btn-outline-primary" for="xAxisEW">
                                    East-West ‚Üî
                                </label>
                                <input type="radio" class="btn-check" name="xAxisDir" id="xAxisNS"
                                       checked="@(!_newPlan.XEW)" @onchange="() => SetXAxisDirection(false)">
                                <label class="btn btn-outline-primary" for="xAxisNS">
                                    North-South ‚Üï
                                </label>
                            </div>
                            <span class="text-muted small ms-2">
                                @(_newPlan.XEW ? "+X = East, +Y = North" : "+X = North, +Y = East")
                            </span>
                        }
                        else
                        {
                            @* Subsequent Plans: Rotation Controls *@
                            <span class="toolbar-label">Rotate:</span>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    @onclick="RotatePlotPlan90" title="Rotate 90¬∞ clockwise">
                                ‚Üª 90¬∞
                            </button>
                            <span class="toolbar-label ms-2">or</span>
                            <InputNumber class="form-control form-control-sm toolbar-input"
                                         @bind-Value="_customRotationAngle"
                                         placeholder="Angle"
                                         title="Custom angle (-180¬∞ to +180¬∞)"/>
                            <span class="text-muted small">¬∞</span>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    @onclick="ApplyCustomRotation" title="Apply custom rotation">
                                Apply
                            </button>
                            <span class="badge bg-secondary ms-2">
                                Current: @($"{_newPlan.Rotation * 180 / Math.PI:F1}")¬∞
                            </span>
                        }
                    </div>

                    <div class="toolbar-section toolbar-actions">
                        <button type="button" class="btn btn-sm btn-primary" @onclick="CompleteOrientationStep">
                            Next: Scale ‚Üí
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="ConfirmAndDiscard">
                            ‚úï
                        </button>
                    </div>
                }

                @* ================================================================
               STEP C: Scale (4 Pins)
               ================================================================ *@
                @if (_currentStep == ImportStep.Scale)
                {
                    <div class="toolbar-section">
                        <span class="step-badge step-c">Step C: Scale</span>
                    </div>

                    <div class="toolbar-section toolbar-main">
                        @* Pin Placement Status *@
                        <div class="pin-status">
                            @foreach (var pinTag in _scalePinTags)
                            {
                                var pin = _placedPins.FirstOrDefault(p => p.Tag == pinTag);
                                var isPlaced = pin != null;
                                var isCurrent = _pinService_CurrentTag == pinTag;
                                <span class="pin-chip @(isPlaced ? "placed" : "") @(isCurrent ? "current" : "")"
                                      title="@(isPlaced ? $"X:{pin!.X:F2}, Y:{pin.Y:F2}" : "Not placed")">
                                    @pinTag @(isPlaced ? "‚úì" : "")
                                </span>
                            }
                        </div>

                        @* Coordinate Inputs *@
                        <span class="toolbar-label ms-2">X:</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="_newPlan.X1" placeholder="Left" title="X-Left (m)"/>
                        <span class="text-muted">‚Üí</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="_newPlan.X2" placeholder="Right" title="X-Right (m)"/>

                        <span class="toolbar-label ms-2">Y:</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="_newPlan.Y1" placeholder="Bot" title="Y-Bottom (m)"/>
                        <span class="text-muted">‚Üí</span>
                        <InputNumber class="form-control form-control-sm toolbar-input"
                                     @bind-Value="_newPlan.Y2" placeholder="Top" title="Y-Top (m)"/>

                        <span class="badge bg-info ms-2">@_placedPins.Count(p => _scalePinTags.Contains(p.Tag))/4 pins</span>
                    </div>

                    @* Pin Placement Instructions *@
                    @if (_isPinPlacementActive)
                    {
                        <div class="pin-instructions mt-2">
                            <span class="text-warning">
                                <strong>üìç Placing: @_pinService_CurrentTag</strong> -
                                Hold <kbd>SHIFT</kbd> and click on the plot plan
                            </span>
                        </div>
                    }

                    <div class="toolbar-section toolbar-actions">
                        @if (!_isPinPlacementActive)
                        {
                            <button type="button" class="btn btn-sm btn-warning" @onclick="StartScalePinPlacement">
                                üìç Place Pins
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-sm btn-secondary" @onclick="StopPinPlacement">
                                ‚èπ Stop
                            </button>
                        }
                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                @onclick="ResetScalePins" disabled="@(_placedPins.Count == 0)">
                            üîÑ Reset
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" @onclick="TryApplyScale"
                                disabled="@(!CanApplyScale)">
                            Apply Scale ‚Üí
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="ConfirmAndDiscard">
                            ‚úï
                        </button>
                    </div>
                }

                @* ================================================================
               STEP D: Position (Centre)
               ================================================================ *@
                @if (_currentStep == ImportStep.Position)
                {
                    <div class="toolbar-section">
                        <span class="step-badge step-d">Step D: Position</span>
                    </div>

                    <div class="toolbar-section toolbar-main">
                        @if (IsKeyPlan)
                        {
                            @* Key Plan: Single Origin Pin + Reference E/N *@
                            <div class="pin-status">
                                @{
                                    var originPin = _placedPins.FirstOrDefault(p => p.Tag == "Origin");
                                    var isOriginPlaced = originPin != null;
                                }
                                <span class="pin-chip @(isOriginPlaced ? "placed" : "") @(_pinService_CurrentTag == "Origin" ? "current" : "")">
                                    Origin (0,0) @(isOriginPlaced ? "‚úì" : "")
                                </span>
                            </div>

                            <span class="toolbar-label ms-2">Reference E:</span>
                            <InputNumber class="form-control form-control-sm toolbar-input"
                                         @bind-Value="_newPlan.LocalE" placeholder="E1" title="Reference Easting"/>
                            <span class="toolbar-label ms-1">N:</span>
                            <InputNumber class="form-control form-control-sm toolbar-input"
                                         @bind-Value="_newPlan.LocalN" placeholder="N1" title="Reference Northing"/>

                            <span class="toolbar-label ms-2">Z:</span>
                            <InputNumber class="form-control form-control-sm" style="width:60px"
                                         @bind-Value="_newPlan.Z" title="Elevation (m)"/>
                        }
                        else
                        {
                            @* Subsequent Plans: Two Reference Pins *@
                            <div class="pin-status">
                                @foreach (var pinTag in _positionPinTags)
                                {
                                    var pin = _placedPins.FirstOrDefault(p => p.Tag == pinTag);
                                    var isPlaced = pin != null;
                                    <span class="pin-chip @(isPlaced ? "placed" : "") @(_pinService_CurrentTag == pinTag ? "current" : "")">
                                        @pinTag @(isPlaced ? "‚úì" : "")
                                    </span>
                                }
                            </div>
                            <span class="text-muted small ms-2">
                                Pin matching points on new plan ‚Üí key plan
                            </span>

                            <span class="toolbar-label ms-2">Z:</span>
                            <InputNumber class="form-control form-control-sm" style="width:60px"
                                         @bind-Value="_newPlan.Z" title="Elevation (m)"/>
                        }

                        <span class="badge bg-info ms-2">
                            @_placedPins.Count(p => (IsKeyPlan ? new[] { "Origin" } : _positionPinTags).Contains(p.Tag))/@(IsKeyPlan ? 1 : 2) pins
                        </span>
                    </div>

                    @* Pin Placement Instructions *@
                    @if (_isPinPlacementActive)
                    {
                        <div class="pin-instructions mt-2">
                            <span class="text-warning">
                                <strong>üìç Placing: @_pinService_CurrentTag</strong> -
                                Hold <kbd>SHIFT</kbd> and click on the @(IsKeyPlan ? "plot plan" : (_pinService_CurrentTag == "Ref-New" ? "NEW plan" : "KEY plan"))
                            </span>
                        </div>
                    }

                    <div class="toolbar-section toolbar-actions">
                        @if (!_isPinPlacementActive)
                        {
                            <button type="button" class="btn btn-sm btn-warning" @onclick="StartPositionPinPlacement">
                                üìç Place Pin@(IsKeyPlan ? "" : "s")
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-sm btn-secondary" @onclick="StopPinPlacement">
                                ‚èπ Stop
                            </button>
                        }
                        <button type="button" class="btn btn-sm btn-primary" @onclick="TryApplyPosition"
                                disabled="@(!CanApplyPosition)">
                            Apply Position ‚Üí
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="ConfirmAndDiscard">
                            ‚úï
                        </button>
                    </div>
                }

                @* ================================================================
               STEP E: Save
               ================================================================ *@
                @if (_currentStep == ImportStep.Save)
                {
                    <div class="toolbar-section">
                        <span class="step-badge step-e">Step E: Save</span>
                        @if (IsKeyPlan)
                        {
                            <span class="badge bg-warning text-dark ms-1">‚≠ê Key Plan</span>
                        }
                    </div>

                    <div class="toolbar-section toolbar-main">
                        <span class="toolbar-label">Name:</span>
                        <InputText class="form-control form-control-sm" style="width:140px"
                                   @bind-Value="_newPlan.Tag" placeholder="Required"/>
                        <ValidationMessage For="@(() => _newPlan.Tag)" class="validation-inline"/>

                        <span class="toolbar-label ms-2">Description:</span>
                        <InputText class="form-control form-control-sm" style="width:180px"
                                   @bind-Value="_newPlan.TagDesc" placeholder="Optional"/>

                        <span class="toolbar-label ms-2">Remark:</span>
                        <InputText class="form-control form-control-sm" style="width:100px"
                                   @bind-Value="_newPlan.Remark"/>
                    </div>

                    <div class="toolbar-section toolbar-actions">
                        <button type="submit" class="btn btn-sm btn-success" disabled="@_isSaving">
                            @if (_isSaving)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                            }
                            else
                            {
                                <span>üíæ Save Plot Plan</span>
                            }
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="ConfirmAndDiscard"
                                disabled="@_isSaving">
                            ‚úï
                        </button>
                    </div>
                }
            </div>

            <ValidationSummary class="validation-summary"/>
        </EditForm>

 
    @* ============================================================================
       SECTION: Coordinate Systems Management
       ============================================================================ *@
    if (_plotPlans.Any(p => p.KeyPlan))
    {
        <div class="coordinate-systems-section mt-4">
            <h5 class="section-title">
                üåê Coordinate Systems
                <button type="button" class="btn btn-sm btn-outline-primary ms-2" 
                        @onclick="ToggleCoordinateSystemForm">
                    @(_showCoordSystemForm ? "Cancel" : "+ Add System")
                </button>
            </h5>

            @* Existing Coordinate Systems List *@
            @if (_coordinateSystems.Count > 0)
            {
                <div class="table-responsive mb-3">
    <table class="table table-sm table-bordered">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Unit</th>
                <th>X-Axis</th>
                <th>Ref E</th>
                <th>Ref N</th>
                <th>Scale E</th>
                <th>Scale N</th>
                <th>Rotation¬∞</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var cs in _coordinateSystems)
            {
                <tr class="@(string.IsNullOrEmpty(cs.Name) ? "table-warning" : "")">
                    <td>
                        @(string.IsNullOrEmpty(cs.Name) ? "(Default)" : cs.Name)
                        @if (string.IsNullOrEmpty(cs.Name))
                        {
                            <span class="badge bg-secondary ms-1">Auto</span>
                        }
                    </td>
                    <td>@cs.Description</td>
                    <td>@cs.Unit</td>
                    <td>
                        <span class="badge @(cs.XEW ? "bg-primary" : "bg-info")">
                            @(cs.XEW ? "E-W" : "N-S")
                        </span>
                    </td>
                    <td>@cs.ReferenceE.ToString("F2")</td>
                    <td>@cs.ReferenceN.ToString("F2")</td>
                    <td>
                        <span class="badge @(cs.ScaleE > 0 ? "bg-success" : "bg-danger")">
                            @(cs.ScaleE > 0 ? "+1" : "-1")
                        </span>
                    </td>
                    <td>
                        <span class="badge @(cs.ScaleN > 0 ? "bg-success" : "bg-danger")">
                            @(cs.ScaleN > 0 ? "+1" : "-1")
                        </span>
                    </td>
                    <td>@cs.RotationDegrees.ToString("F2")</td>
                    <td>
                        @if (!string.IsNullOrEmpty(cs.Name))
                        {
                            <button class="btn btn-danger btn-sm" 
                                    @onclick="() => DeleteCoordinateSystem(cs.Name)">
                                üóëÔ∏è
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
            }
            else
            {
                <p class="text-muted small">No coordinate systems defined yet. The default system will be created with the Key Plan.</p>
            }

            
            @* Add New Coordinate System Form *@
@if (_showCoordSystemForm)
{
    <div class="coord-system-form card card-body bg-light">
        <h6>Add New Coordinate System</h6>
        
        @* Row 1: Name, Description, Unit *@
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label small">Name</label>
                <input type="text" class="form-control form-control-sm" 
                       @bind="_newCoordSystem.Name" placeholder="e.g., UTM, Global"/>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Description</label>
                <input type="text" class="form-control form-control-sm" 
                       @bind="_newCoordSystem.Description" placeholder="Optional"/>
            </div>
            <div class="col-md-2">
                <label class="form-label small">Unit</label>
                <select class="form-select form-select-sm" @bind="_newCoordSystem.Unit">
                    <option value="m">m</option>
                    <option value="km">km</option>
                    <option value="mm">mm</option>
                    <option value="ft">ft</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Rotation (CW¬∞)</label>
                <input type="number" step="0.1" class="form-control form-control-sm" 
                       @bind="_newCoordSystem.RotationDegrees" placeholder="0"/>
            </div>
        </div>

        @* Row 2: Reference Coordinates *@
        <div class="row g-2 mt-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label small">Reference Easting</label>
                <input type="number" step="0.01" class="form-control form-control-sm" 
                       @bind="_newCoordSystem.ReferenceE" placeholder="Easting at pin"/>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Reference Northing</label>
                <input type="number" step="0.01" class="form-control form-control-sm" 
                       @bind="_newCoordSystem.ReferenceN" placeholder="Northing at pin"/>
            </div>
            <div class="col-md-6">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">
                        üìç Pin location: 
                        @if (_coordSystemPin != null)
                        {
                            <span class="badge bg-success">
                                X: @_coordSystemPin.Value.X.ToString("F2"), Y: @_coordSystemPin.Value.Y.ToString("F2")
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Not set</span>
                        }
                    </span>
                    <button type="button" class="btn btn-sm btn-warning" 
                            @onclick="StartCoordSystemPinPlacement"
                            disabled="@_isPinPlacementActive">
                        üìç Pin Reference Point
                    </button>
                </div>
            </div>
        </div>

        @* Row 3: Axis Orientation and Scale Factors *@
        <div class="row g-2 mt-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label small d-block">Scene X-Axis Direction</label>
                <div class="btn-group btn-group-sm w-100" role="group">
                    <input type="radio" class="btn-check" name="xewRadio" id="xewTrue" 
                           checked="@_newCoordSystem.XEW"
                           @onchange="@(() => _newCoordSystem.XEW = true)">
                    <label class="btn btn-outline-primary" for="xewTrue">
                        ‚ÜîÔ∏è East-West
                    </label>
                    <input type="radio" class="btn-check" name="xewRadio" id="xewFalse"
                           checked="@(!_newCoordSystem.XEW)"
                           @onchange="@(() => _newCoordSystem.XEW = false)">
                    <label class="btn btn-outline-primary" for="xewFalse">
                        ‚ÜïÔ∏è North-South
                    </label>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label small d-block">Easting Direction (Scale E)</label>
                <div class="btn-group btn-group-sm w-100" role="group">
                    <input type="radio" class="btn-check" name="scaleERadio" id="scaleEPos" 
                           checked="@(_newCoordSystem.ScaleE > 0)"
                           @onchange="@(() => _newCoordSystem.ScaleE = 1.0)">
                    <label class="btn btn-outline-success" for="scaleEPos">
                        ‚ûï Increasing (+1)
                    </label>
                    <input type="radio" class="btn-check" name="scaleERadio" id="scaleENeg"
                           checked="@(_newCoordSystem.ScaleE < 0)"
                           @onchange="@(() => _newCoordSystem.ScaleE = -1.0)">
                    <label class="btn btn-outline-danger" for="scaleENeg">
                        ‚ûñ Decreasing (-1)
                    </label>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label small d-block">Northing Direction (Scale N)</label>
                <div class="btn-group btn-group-sm w-100" role="group">
                    <input type="radio" class="btn-check" name="scaleNRadio" id="scaleNPos" 
                           checked="@(_newCoordSystem.ScaleN > 0)"
                           @onchange="@(() => _newCoordSystem.ScaleN = 1.0)">
                    <label class="btn btn-outline-success" for="scaleNPos">
                        ‚ûï Increasing (+1)
                    </label>
                    <input type="radio" class="btn-check" name="scaleNRadio" id="scaleNNeg"
                           checked="@(_newCoordSystem.ScaleN < 0)"
                           @onchange="@(() => _newCoordSystem.ScaleN = -1.0)">
                    <label class="btn btn-outline-danger" for="scaleNNeg">
                        ‚ûñ Decreasing (-1)
                    </label>
                </div>
            </div>
        </div>

        @* Row 4: Visual Helper *@
        <div class="row mt-2">
            <div class="col-12">
                <div class="alert alert-info small py-2 mb-0">
                    <strong>Current Setup:</strong>
                    Scene X-axis is <strong>@(_newCoordSystem.XEW ? "East-West" : "North-South")</strong>.
                    Moving right (+X) will @(_newCoordSystem.XEW ? (_newCoordSystem.ScaleE > 0 ? "increase" : "decrease") : (_newCoordSystem.ScaleN > 0 ? "increase" : "decrease")) 
                    <strong>@(_newCoordSystem.XEW ? "Easting" : "Northing")</strong>.
                    Moving up (+Y) will @(_newCoordSystem.XEW ? (_newCoordSystem.ScaleN > 0 ? "increase" : "decrease") : (_newCoordSystem.ScaleE > 0 ? "increase" : "decrease")) 
                    <strong>@(_newCoordSystem.XEW ? "Northing" : "Easting")</strong>.
                </div>
            </div>
        </div>

        @* Row 5: Action Buttons *@
        <div class="mt-3">
            <button type="button" class="btn btn-sm btn-success" 
                    @onclick="SaveCoordinateSystem"
                    disabled="@(!CanSaveCoordinateSystem)">
                üíæ Save Coordinate System
            </button>
            <button type="button" class="btn btn-sm btn-secondary ms-2" 
                    @onclick="ToggleCoordinateSystemForm">
                Cancel
            </button>
        </div>
    </div>
}
            
            
        </div>
    }
    
    
    
    
}

@* ============================================================================
   CODE-BEHIND
   ============================================================================ *@
@code {
    #region Enums & Constants

    /// <summary>
    /// Represents the current step in the plot plan import workflow
    /// </summary>
    private enum ImportStep
    {
        None = 0,      // Initial state / file selection
        Orientation,   // Step B: Align/rotate
        Scale,         // Step C: Pin 4 points and enter coordinates
        Position,      // Step D: Set origin/position
        Save           // Step E: Enter metadata and save
    }

    // Pin tags for each step
    private readonly string[] _scalePinTags = { "X-Left", "X-Right", "Y-Bottom", "Y-Top" };
    private readonly string[] _positionPinTags = { "Ref-New", "Ref-Key" };

    #endregion

    #region Parameters

    [Parameter]
    public Plot? PlotComponent { get; set; }

    #endregion

    #region State Fields

    // Display fields
    private readonly List<string> displayFields = new()
    {
        "Tag", "TagDesc", "ImgThumbString", "X1", "X2", "Y1", "Y2", "Z", "Opacity",
        "Width", "Height", "ScaleX", "ScaleY", "CentreX", "CentreY",
        "GlobalE", "GlobalN", "KeyPlan"
    };
    
    // Data
    private PlotPlan _newPlan = new();
    private List<PlotPlan> _plotPlans = new();
    private List<CoordinateSystem> _coordinateSystems = new();
    private CoordinateSystem _newCoordSystem = new() { Unit = "m" };

    // Workflow State
    private ImportStep _currentStep = ImportStep.None;
    private bool _showPreview;
    private string? _uploadedFileName;
    private float _customRotationAngle;

    // Pin Placement State
    private List<PlacedPin> _placedPins = new();
    private bool _isPinPlacementActive;
    private string _pinService_CurrentTag = "";
    private Vector3? _coordSystemPin;

    // UI State
    private bool _isLoadingPlans = true;
    private bool _isProcessingFile;
    private bool _isSaving;
    private bool _isDeleting;
    private string? _deletingTag;
    private bool _showCoordSystemForm;

    // Messages
    private string? _errorMessage;
    private string? _successMessage;

    // Validation
    private CustomValidation? _customValidation;

    #endregion

    #region Computed Properties

    /// <summary>
    /// Returns true if this is the first plot plan (will become Key Plan)
    /// </summary>
    private bool IsKeyPlan => _plotPlans.Count == 0;

    /// <summary>
    /// Returns true if all 4 scale pins are placed and coordinates are valid
    /// </summary>
    private bool CanApplyScale =>
        _placedPins.Count(p => _scalePinTags.Contains(p.Tag)) == 4 &&
        Math.Abs(_newPlan.X2 - _newPlan.X1) >= 0.01f &&
        Math.Abs(_newPlan.Y2 - _newPlan.Y1) >= 0.01f;

    /// <summary>
    /// Returns true if position pins are placed and (for key plan) reference coordinates are set
    /// </summary>
    private bool CanApplyPosition
    {
        get
        {
            if (IsKeyPlan)
            {
                return _placedPins.Any(p => p.Tag == "Origin") &&
                       (_newPlan.LocalE != 0 || _newPlan.LocalN != 0);
            }
            return _placedPins.Count(p => _positionPinTags.Contains(p.Tag)) == 2;
        }
    }

    /// <summary>
    /// Returns true if coordinate system form is valid
    /// </summary>
    private bool CanSaveCoordinateSystem =>
        !string.IsNullOrWhiteSpace(_newCoordSystem.Name) &&
        _coordSystemPin.HasValue;

    #endregion

    #region Lifecycle Methods

    protected override void OnInitialized()
    {
        // Subscribe to pin service events
        PinService.OnStateChanged += OnPinServiceStateChanged;
        PinService.OnPinPlaced += OnPinPlaced;
        PinService.OnAllPinsPlaced += OnAllPinsPlaced;
    }

    protected override async Task OnInitializedAsync()
    {
        _isLoadingPlans = true;

        try
        {
            _plotPlans = await PlotPlanService.GetAllAsync() ?? new List<PlotPlan>();
            await LoadCoordinateSystems();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load plot plans: {ex.Message}";
            Debug.WriteLine($"OnInitializedAsync error: {ex}");
        }
        finally
        {
            _isLoadingPlans = false;
        }

        await base.OnInitializedAsync();
    }

    public void Dispose()
    {
        PinService.OnStateChanged -= OnPinServiceStateChanged;
        PinService.OnPinPlaced -= OnPinPlaced;
        PinService.OnAllPinsPlaced -= OnAllPinsPlaced;
    }

    #endregion

    #region Step A: File Upload

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        _isProcessingFile = true;
        _showPreview = false;
        _currentStep = ImportStep.None;
        ClearMessages();
        _uploadedFileName = e.File.Name;
        StateHasChanged();

        try
        {
            bool isPdf = e.File.ContentType.ToLower() == "application/pdf";

            if (isPdf)
            {
                _newPlan = await PlotPlanService.LoadPdfAsync(e, 0, 150);
            }
            else
            {
                _newPlan = await PlotPlanService.LoadImageAsync(e);
            }

            // Initialize default values
            _newPlan.ProjectId = GlobalData.SelectedProject?.Tag ?? "";
            _newPlan.OptionId = "base";
            _newPlan.Opacity = 1;
            _newPlan.UpdatedOn = DateTime.Now;
            _newPlan.Remark = "";
            _newPlan.XEW = true;
            _newPlan.Z = 0; // Default elevation
            _newPlan.Rotation = 0;

            _showPreview = true;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to process file: {ex.Message}";
            Debug.WriteLine($"HandleFileUpload error: {ex}");
        }
        finally
        {
            _isProcessingFile = false;
            StateHasChanged();
        }
    }

    private void CancelUpload()
    {
        _showPreview = false;
        _newPlan = new PlotPlan();
        _uploadedFileName = null;
        _currentStep = ImportStep.None;
    }

    private async Task AcceptUploadAndProceed()
    {
        // Generate temporary tag
        _newPlan.Tag = $"plotplan_{DateTime.Now:yyyyMMdd_HHmmss}";

        // Initialize transform values
        _newPlan.X1 = 0;
        _newPlan.X2 = 0;
        _newPlan.Y1 = 0;
        _newPlan.Y2 = 0;
        _newPlan.Width = 0;
        _newPlan.Height = 0;
        _newPlan.ScaleX = 1;
        _newPlan.ScaleY = 1;
        _newPlan.CentreX = 0;
        _newPlan.CentreY = 0;

        // Set Z slightly above existing plans to avoid z-fighting
        if (_plotPlans.Count > 0)
        {
            var keyPlan = _plotPlans.Find(p => p.KeyPlan);
            _newPlan.Z = (keyPlan?.Z ?? 0) + 0.01f;
        }

        // Draw the plan in the 3D scene
        await DrawPlanInScene(_newPlan);

        // Hide Plot component if needed
        if (PlotComponent != null)
        {
            await PlotComponent.HidePlotPlan();
        }

        _showPreview = false;
        _currentStep = ImportStep.Orientation;
        StateHasChanged();
    }

    #endregion

    #region Step B: Orientation

    private void SetXAxisDirection(bool eastWest)
    {
        _newPlan.XEW = eastWest;

        // Update project settings if this is the key plan
        if (IsKeyPlan && GlobalData.SelectedProject != null)
        {
            GlobalData.SelectedProject.XEW = eastWest;
        }

        Debug.WriteLine($"X-Axis direction set to: {(eastWest ? "East-West" : "North-South")}");
    }

    private async Task RotatePlotPlan90()
    {
        _newPlan.Rotation += (float)(Math.PI / 2);

        // Normalize to -œÄ to œÄ range
        while (_newPlan.Rotation > Math.PI) _newPlan.Rotation -= (float)(2 * Math.PI);

        await SafeJsInvoke("rotatePlane", (float)(Math.PI / 2));
        Debug.WriteLine($"Rotated plot plan by 90¬∞. Total rotation: {_newPlan.Rotation * 180 / Math.PI:F1}¬∞");
    }

    private async Task ApplyCustomRotation()
    {
        if (_customRotationAngle < -180 || _customRotationAngle > 180)
        {
            _errorMessage = "Rotation angle must be between -180¬∞ and +180¬∞";
            return;
        }

        float angleRad = (float)(_customRotationAngle * Math.PI / 180);
        float deltaAngle = angleRad - _newPlan.Rotation;

        _newPlan.Rotation = angleRad;
        await SafeJsInvoke("rotatePlane", deltaAngle);

        Debug.WriteLine($"Applied custom rotation: {_customRotationAngle}¬∞");
    }

    private async Task CompleteOrientationStep()
    {
        // Clear any pins from previous attempts
        await ClearAllPins();

        _currentStep = ImportStep.Scale;
        StateHasChanged();
    }

    #endregion

    #region Step C: Scale

    private void StartScalePinPlacement()
    {
        _placedPins.RemoveAll(p => _scalePinTags.Contains(p.Tag));
        PinService.StartPlacement(_scalePinTags.ToList());
        _isPinPlacementActive = true;
        _pinService_CurrentTag = PinService.CurrentTag ?? "";
        UpdateRefPointTextsInScene(_scalePinTags.ToList());
    }

    private async Task TryApplyScale()
    {
        _customValidation?.ClearErrors();
        var errors = new Dictionary<string, List<string>>();

        // Validate pins
        var xLeftPin = _placedPins.FirstOrDefault(p => p.Tag == "X-Left");
        var xRightPin = _placedPins.FirstOrDefault(p => p.Tag == "X-Right");
        var yBottomPin = _placedPins.FirstOrDefault(p => p.Tag == "Y-Bottom");
        var yTopPin = _placedPins.FirstOrDefault(p => p.Tag == "Y-Top");

        if (xLeftPin == null || xRightPin == null || yBottomPin == null || yTopPin == null)
        {
            errors.Add("Pins", new List<string> { "Please place all 4 reference pins (X-Left, X-Right, Y-Bottom, Y-Top)." });
        }

        // Validate coordinates
        if (Math.Abs(_newPlan.X2 - _newPlan.X1) < 0.01f)
        {
            errors.Add("X1", new List<string> { "X1 and X2 must have a meaningful difference (at least 0.01m)." });
        }

        if (Math.Abs(_newPlan.Y2 - _newPlan.Y1) < 0.01f)
        {
            errors.Add("Y1", new List<string> { "Y1 and Y2 must have a meaningful difference (at least 0.01m)." });
        }

        if (errors.Any())
        {
            _customValidation?.DisplayErrors(errors);
            return;
        }

        // Calculate scale factors
        // dx = X value of X-Right - X value of X-Left (in scene coordinates)
        // dy = Y value of Y-Top - Y value of Y-Bottom (in scene coordinates)
        float dx = xRightPin!.X - xLeftPin!.X;
        float dy = yTopPin!.Y - yBottomPin!.Y;

        if (Math.Abs(dx) < 1 || Math.Abs(dy) < 1)
        {
            _errorMessage = "Pin positions are too close together. Please place pins further apart.";
            return;
        }

        float scaleX = (_newPlan.X2 - _newPlan.X1) / dx;
        float scaleY = (_newPlan.Y2 - _newPlan.Y1) / dy;

        // Store polarity for coordinate system (before taking absolute value)
        if (IsKeyPlan && GlobalData.SelectedProject != null)
        {
            GlobalData.SelectedProject.PositiveScaleX = scaleX > 0;
            GlobalData.SelectedProject.PositiveScaleY = scaleY > 0;
        }

        // Image scale must be positive for proper rendering
        _newPlan.ScaleX = Math.Abs(scaleX);
        _newPlan.ScaleY = Math.Abs(scaleY);

        // Store renderer dimensions
        if (GlobalData.sceneDataCurrent != null)
        {
            _newPlan.RendererWidth = GlobalData.sceneDataCurrent.RendererWidth;
            _newPlan.RendererHeight = GlobalData.sceneDataCurrent.RendererHeight;
        }

        // Apply scale in 3D scene
        await SafeJsInvoke("scalePlane", _newPlan.ScaleX, _newPlan.ScaleY);

        Debug.WriteLine($"Applied scale: X={_newPlan.ScaleX:F4}, Y={_newPlan.ScaleY:F4}");

        // IMPORTANT: Stop pin placement mode and clear all pins before moving to next step
        StopPinPlacement();
        await ClearAllPins();
        
        _currentStep = ImportStep.Position;
        StateHasChanged();
    }

    private async Task ResetScalePins()
    {
        _placedPins.RemoveAll(p => _scalePinTags.Contains(p.Tag));
        await ClearAllPins();
        StopPinPlacement();
    }

    #endregion

    #region Step D: Position

    private void StartPositionPinPlacement()
    {
        StopPinPlacement();  // Ensure any previous pin placement is stopped

        if (IsKeyPlan)
        {
            _placedPins.RemoveAll(p => p.Tag == "Origin");
            PinService.StartPlacement(new List<string> { "Origin" });
            UpdateRefPointTextsInScene(new List<string> { "Origin" });
        }
        else
        {
            _placedPins.RemoveAll(p => _positionPinTags.Contains(p.Tag));
            PinService.StartPlacement(_positionPinTags.ToList());
            UpdateRefPointTextsInScene(_positionPinTags.ToList());
        }

        _isPinPlacementActive = true;
        _pinService_CurrentTag = PinService.CurrentTag ?? "";
    }

    private async Task TryApplyPosition()
    {
        _customValidation?.ClearErrors();
        var errors = new Dictionary<string, List<string>>();

        float centreX = 0, centreY = 0;

        if (IsKeyPlan)
        {
            // For key plan, centre the scene origin on the pinned point
            
            var originPin = _placedPins.FirstOrDefault(p => p.Tag == "Origin");
            if (originPin == null)
            {
                errors.Add("Origin", new List<string> { "Please place the Origin pin on the plot plan." });
            }

            if (_newPlan.LocalE == 0 && _newPlan.LocalN == 0)
            {
                errors.Add("LocalE", new List<string> { "Reference E and N coordinates are required." });
            }

            if (errors.Any())
            {
                _customValidation?.DisplayErrors(errors);
                return;
            }

            // For key plan, centre the scene origin on the pinned point
            centreX = originPin!.X;
            centreY = originPin.Y;
            _newPlan.KeyPlan = true;
        }
        else
        {
            // For subsequent plans, Move new plan so that Ref. point on New plan aligns with the Ref. point on Key Plan
            
            var refNewPin = _placedPins.FirstOrDefault(p => p.Tag == "Ref-New");
            var refKeyPin = _placedPins.FirstOrDefault(p => p.Tag == "Ref-Key");

            if (refNewPin == null || refKeyPin == null)
            {
                errors.Add("Pins", ["Please place both reference pins (Ref-New on new plan, Ref-Key on key plan)."]);
                _customValidation?.DisplayErrors(errors);
                return;
            }

            // Move new plan so Ref-New aligns with Ref-Key
            centreX = refNewPin.X - refKeyPin.X;
            centreY = refNewPin.Y - refKeyPin.Y;
            _newPlan.KeyPlan = false;
        }

        _newPlan.CentreX = centreX;
        _newPlan.CentreY = centreY;

        // Apply position in 3D scene
        await SafeJsInvoke("centrePlane", centreX, centreY, _newPlan.Z);

        Debug.WriteLine($"Applied position: CentreX={centreX:F2}, CentreY={centreY:F2}, Z={_newPlan.Z:F2}");

        // Clear pins and proceed
        await ClearAllPins();
        _placedPins.Clear();
        _currentStep = ImportStep.Save;
        StateHasChanged();
    }

    #endregion

    #region Step E: Save

    private async Task HandleSaveSubmit()
    {
        if (_currentStep != ImportStep.Save) return;

        _customValidation?.ClearErrors();
        var errors = new Dictionary<string, List<string>>();

        if (string.IsNullOrWhiteSpace(_newPlan.Tag))
        {
            errors.Add("Tag", new List<string> { "Name is required." });
        }
        else if (_plotPlans.Any(p => p.Tag?.Equals(_newPlan.Tag, StringComparison.OrdinalIgnoreCase) == true))
        {
            errors.Add("Tag", new List<string> { "A plot plan with this name already exists." });
        }

        if (errors.Any())
        {
            _customValidation?.DisplayErrors(errors);
            return;
        }

        await SavePlotPlan();
    }

    private async Task SavePlotPlan()
    {
        _isSaving = true;
        ClearMessages();
        StateHasChanged();

        try
        {
            // Determine if this is the key plan BEFORE clearing
            bool isKeyPlan = _newPlan.KeyPlan;

            await PlotPlanService.SavePlotPlanAsync(_newPlan);

            // Create default coordinate system for key plan
            if (isKeyPlan)
            {
                await CreateDefaultCoordinateSystem();
            }

            _successMessage = $"Plot plan '{_newPlan.Tag}' saved successfully.";
            
            // Refresh list
            _plotPlans = await PlotPlanService.GetAllAsync();
            await LoadCoordinateSystems();

            // Reset for next import
            ResetImportState();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to save plot plan: {ex.Message}";
            Debug.WriteLine($"SavePlotPlan error: {ex}");
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task CreateDefaultCoordinateSystem()
    {
        var scaleX = _newPlan.X2 > _newPlan.X1 ? 1 : -1;
        var scaleY = _newPlan.Y2 > _newPlan.Y1 ? 1 : -1;
        var defaultCs = new CoordinateSystem
        {
            Name = "Default",
            Description = "Default for Key Plan",
            XEW = _newPlan.XEW,
            Unit = "m",
            ReferenceSceneX = 0,
            ReferenceSceneY = 0,
            ReferenceE = _newPlan.LocalE,
            ReferenceN = _newPlan.LocalN,
            RotationDegrees = 0,
            ScaleE = _newPlan.XEW ? scaleX :scaleY,
            ScaleN = _newPlan.XEW ? scaleY :scaleX
        };
 
        if (GlobalData.SelectedProject != null)
        {
            GlobalData.SelectedProject.CoordinateSystems = [];
            GlobalData.SelectedProject.CoordinateSystems?.Add(defaultCs);
            GlobalData.SelectedProject.CoordinateSystemJson =
                JsonSerializer.Serialize(GlobalData.SelectedProject.CoordinateSystems);

            await Table.UpdateAsync(GlobalData.SelectedProject);
        }

        Debug.WriteLine($"Created default coordinate system: E={defaultCs.ReferenceE}, N={defaultCs.ReferenceN}");
    }

    #endregion

    #region Coordinate System Management

    private async Task LoadCoordinateSystems()
    {
        _coordinateSystems.Clear();
        
        // read coordinate system of the project afresh from DB:
       
        var (_projects, _, _, _) = await DataService.ReadFromCacheOrDb<Project>();

        var project = _projects.Find(p => GlobalData.SelectedProject != null && p.UID == GlobalData.SelectedProject.UID);

        if (project?.CoordinateSystemJson != null)
        {
            GlobalData.SelectedProject?.CoordinateSystemJson = project?.CoordinateSystemJson;
            
            if (!string.IsNullOrEmpty(GlobalData.SelectedProject?.CoordinateSystemJson))
            {
                try
                {
                    var systems = JsonSerializer.Deserialize<List<CoordinateSystem>>(
                        GlobalData.SelectedProject.CoordinateSystemJson);
                    if (systems != null)
                    {
                        _coordinateSystems = systems;
                    }
                }
                catch (Exception ex)
                {
                    Debug.WriteLine($"Failed to deserialize coordinate systems: {ex.Message}");
                }
            }
        }
    }

    private void ToggleCoordinateSystemForm()
    {
        _showCoordSystemForm = !_showCoordSystemForm;
        if (_showCoordSystemForm)
        {
            _newCoordSystem = new CoordinateSystem { Unit = "m" };
            _coordSystemPin = null;
        }
        else
        {
            StopPinPlacement();
        }
    }

    private void StartCoordSystemPinPlacement()
    {
        PinService.StartPlacement(new List<string> { "CoordRef" });
        _isPinPlacementActive = true;
        _pinService_CurrentTag = "CoordRef";
    }

    private async Task SaveCoordinateSystem()
    {
        if (string.IsNullOrWhiteSpace(_newCoordSystem.Name))
        {
            _errorMessage = "Coordinate system name is required.";
            return;
        }

        if (_coordinateSystems.Any(cs => cs.Name.Equals(_newCoordSystem.Name, StringComparison.OrdinalIgnoreCase)))
        {
            _errorMessage = "A coordinate system with this name already exists.";
            return;
        }

        if (!_coordSystemPin.HasValue)
        {
            _errorMessage = "Please pin a reference point on the map.";
            return;
        }

        _newCoordSystem.ReferenceSceneX = _coordSystemPin.Value.X;
        _newCoordSystem.ReferenceSceneY = _coordSystemPin.Value.Y;

        _coordinateSystems.Add(_newCoordSystem);

        // Save to project
        if (GlobalData.SelectedProject != null)
        {
            GlobalData.SelectedProject.CoordinateSystems = _coordinateSystems;
            GlobalData.SelectedProject.CoordinateSystemJson = JsonSerializer.Serialize(_coordinateSystems);

            try
            {
                await Table.UpdateAsync(GlobalData.SelectedProject);
                _successMessage = $"Coordinate system '{_newCoordSystem.Name}' saved successfully.";
                await SafeJsInvoke("clearAllPins");
            }
            catch (Exception ex)
            {
                _errorMessage = $"Failed to save coordinate system: {ex.Message}";
                return;
            }
        }

        _showCoordSystemForm = false;
        _newCoordSystem = new CoordinateSystem { Unit = "m" };
        _coordSystemPin = null;
        StateHasChanged();
    }

    private async Task DeleteCoordinateSystem(string name)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm",
            $"Delete coordinate system '{name}'?");

        if (!confirmed) return;

        _coordinateSystems.RemoveAll(cs => cs.Name == name);

        if (GlobalData.SelectedProject != null)
        {
            GlobalData.SelectedProject.CoordinateSystems = _coordinateSystems;
            GlobalData.SelectedProject.CoordinateSystemJson = JsonSerializer.Serialize(_coordinateSystems);

            try
            {
                await Table.UpdateAsync(GlobalData.SelectedProject);
                _successMessage = $"Coordinate system '{name}' deleted.";
            }
            catch (Exception ex)
            {
                _errorMessage = $"Failed to delete coordinate system: {ex.Message}";
            }
        }

        StateHasChanged();
    }

    #endregion

    #region Delete Plot Plan

    private async Task ConfirmAndDeletePlotPlan(string tag)
    {
        var plan = _plotPlans.FirstOrDefault(p => p.Tag == tag);
        if (plan == null) return;

        string message = plan.KeyPlan
            ? "‚ö†Ô∏è This is the KEY PLAN.\n\nDeleting it will affect all other plans. Continue?"
            : $"Delete plot plan '{tag}'?";

        if (!await JsRuntime.InvokeAsync<bool>("confirm", message)) return;

        _isDeleting = true;
        _deletingTag = tag;
        ClearMessages();
        StateHasChanged();

        try
        {
            if (plan.KeyPlan && _plotPlans.Count > 1)
            {
                // Promote another plan to key plan
                var newKeyPlan = _plotPlans.FirstOrDefault(p => p.Tag != tag);
                if (newKeyPlan != null)
                {
                    float deltaE = plan.GlobalE - newKeyPlan.GlobalE;
                    float deltaN = plan.GlobalN - newKeyPlan.GlobalN;

                    await PlotPlanService.PromoteToKeyPlanAsync(newKeyPlan, plan);
                    await SafeJsInvoke("repositionAllPlanes", deltaE, deltaN);
                }
            }

            await SafeJsInvoke("removePlane", plan.Tag);
            await PlotPlanService.DeletePlotPlanAsync(plan);
            _plotPlans = await PlotPlanService.GetAllAsync();

            _successMessage = $"Plot plan '{tag}' deleted successfully.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to delete plot plan: {ex.Message}";
        }
        finally
        {
            _isDeleting = false;
            _deletingTag = null;
            StateHasChanged();
        }
    }

    #endregion

    #region Pin Placement Event Handlers

    private void OnPinServiceStateChanged()
    {
        _pinService_CurrentTag = PinService.CurrentTag ?? "";
        _isPinPlacementActive = PinService.IsActive;
        InvokeAsync(StateHasChanged);
    }

    private void OnPinPlaced(string tag, double x, double y, double z)
    {
        Debug.WriteLine($"Pin placed: {tag} at ({x:F2}, {y:F2}, {z:F2})");

        // Handle coordinate system pin separately
        if (tag == "CoordRef")
        {
            _coordSystemPin = new Vector3((float)x, (float)y, (float)z);
            StopPinPlacement();
            InvokeAsync(StateHasChanged);
            return;
        }

        // Remove existing pin with same tag
        _placedPins.RemoveAll(p => p.Tag == tag);

        _placedPins.Add(new PlacedPin
        {
            Tag = tag,
            X = (float)x,
            Y = (float)y,
            Z = (float)z
        });

        _pinService_CurrentTag = PinService.CurrentTag ?? "";
        InvokeAsync(StateHasChanged);
    }

    private void OnAllPinsPlaced()
    {
        // PinPlacementService now auto-stops, but we update local state too
        _isPinPlacementActive = false;
        _pinService_CurrentTag = "";
        
        Console.WriteLine("PlotEdit: All pins placed - pin mode deactivated");
        InvokeAsync(StateHasChanged);
    }

    private void StopPinPlacement()
    {
        PinService.StopPlacement();
        _isPinPlacementActive = false;
        _pinService_CurrentTag = "";
    }

    #endregion

    #region Helper Methods
    
    private string GetPropertyValue(PlotPlan plotPlan, string propertyName)
    {
        var property = typeof(PlotPlan).GetProperty(propertyName);
        if (property == null) return string.Empty;

        var value = property.GetValue(plotPlan);

        // Format numbers nicely
        if (value is float f) return f.ToString("F2");
        if (value is double d) return d.ToString("F2");
        if (value is bool b) return b ? "Yes" : "No";

        return value?.ToString() ?? string.Empty;
    }

    private async Task DrawPlanInScene(PlotPlan plan)
    {
        if (!await SafeJsInvoke("drawPlane", plan.Tag, plan.TagDesc, _newPlan.ImgString,_newPlan.Rotation,
                plan.ScaleX, plan.ScaleY, plan.CentreX, plan.CentreY, plan.Z, plan.Opacity))
        {
            _errorMessage = "Failed to draw plot plan in 3D view.";
        }
    }

    private async Task ClearAllPins()
    {
        StopPinPlacement();
        await SafeJsInvoke("clearAllPins");
        _placedPins.Clear();
    }

    private async void UpdateRefPointTextsInScene(List<string> tags)
    {
        await SafeJsInvoke("updateRefPointTexts", tags);
    }

    private async Task<bool> SafeJsInvoke(string identifier, params object[] args)
    {
        try
        {
            await JsRuntime.InvokeVoidAsync(identifier, args);
            return true;
        }
        catch (JSException ex)
        {
            Debug.WriteLine($"JS Interop failed for {identifier}: {ex.Message}");
            return false;
        }
    }

    private void ResetImportState()
    {
        _newPlan = new PlotPlan();
        _currentStep = ImportStep.None;
        _showPreview = false;
        _uploadedFileName = null;
        _customRotationAngle = 0;
        _placedPins.Clear();
        _isPinPlacementActive = false;
        _pinService_CurrentTag = "";
        _customValidation?.ClearErrors();
    }

    private async Task ConfirmAndDiscard()
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm",
            "‚ö†Ô∏è Discard this plot plan?\n\nAll changes will be lost.\n\nContinue?");

        if (confirmed)
        {
            await DiscardAndReset();
        }
    }

    private async Task DiscardAndReset()
    {
        if (!string.IsNullOrEmpty(_newPlan.Tag))
        {
            await SafeJsInvoke("removePlane", _newPlan.Tag);
        }

        await ClearAllPins();
        StopPinPlacement();
        ResetImportState();

        if (PlotComponent != null)
        {
            await PlotComponent.HidePlotPlan();
        }

        _successMessage = "Plot plan discarded.";
        StateHasChanged();
    }

    private void ClearMessages()
    {
        _errorMessage = null;
        _successMessage = null;
    }

    private string GetStepName(ImportStep step) => step switch
    {
        ImportStep.Orientation => "Orient",
        ImportStep.Scale => "Scale",
        ImportStep.Position => "Position",
        ImportStep.Save => "Save",
        _ => ""
    };

    #endregion

    #region Inner Classes

    private class PlacedPin
    {
        public string Tag { get; set; } = "";
        public float X { get; set; }
        public float Y { get; set; }
        public float Z { get; set; }
    }

    #endregion
    
}
