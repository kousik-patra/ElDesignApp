@* ProjectSelector.razor - Component for selecting current project *@
@using ElDesignApp.Models
@using ElDesignApp.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject IProjectContextService ProjectContext
@inject AuthenticationStateProvider AuthState
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="project-selector-container">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-folder2-open me-2"></i>
                Select Project
            </h5>
        </div>
        <div class="card-body">
            @if (_isLoading)
            {
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading your projects...</p>
                </div>
            }
            else if (!_projects.Any())
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    You are not assigned to any projects yet. Please contact your administrator.
                </div>
            }
            else
            {
                <div class="mb-3">
                    <label class="form-label fw-bold">Available Projects:</label>
                    <p class="text-muted small">Select a project to access its pages and features</p>
                </div>
                
                <div class="list-group">
                    @foreach (var project in _projects)
                    {
                        var isSelected = _selectedProjectId == project.UID;
                        var isCurrent = ProjectContext.CurrentProjectId == project.UID;
                        
                        <button type="button" 
                                class="list-group-item list-group-item-action @(isSelected ? "active" : "")"
                                @onclick="() => SelectProject(project.UID)">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="bi bi-diagram-3 me-2"></i>
                                        @project.Tag
                                    </h6>
                                    <p class="mb-1 small">@project.TagDescription</p>
                                    <div class="small">
                                        <span class="badge bg-secondary me-1">
                                            <i class="bi bi-geo-alt"></i> @project.ProjLocation
                                        </span>
                                        @if (IsUserAdmin(project.UID))
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-shield-check"></i> Admin
                                            </span>
                                        }
                                    </div>
                                </div>
                                <div>
                                    @if (isCurrent)
                                    {
                                        <span class="badge bg-success rounded-pill">
                                            <i class="bi bi-check-circle"></i> Current
                                        </span>
                                    }
                                    else if (isSelected)
                                    {
                                        <i class="bi bi-arrow-right-circle fs-4"></i>
                                    }
                                </div>
                            </div>
                        </button>
                    }
                </div>

                @if (_selectedProjectId.HasValue && _selectedProjectId != ProjectContext.CurrentProjectId)
                {
                    <div class="mt-3 d-grid">
                        <button class="btn btn-primary btn-lg" @onclick="ConfirmSelection">
                            <i class="bi bi-check-circle me-2"></i>
                            Activate Selected Project
                        </button>
                    </div>
                }
                else if (ProjectContext.CurrentProjectId.HasValue)
                {
                    <div class="mt-3">
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Current Project:</strong> @_currentProject?.Tag
                            <br/>
                            <small>Navigate using the menu to access project pages</small>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private List<Project> _projects = new();
    private Guid? _selectedProjectId;
    private Project? _currentProject;
    private bool _isLoading = true;
    private string? _userId;
    private Dictionary<Guid, bool> _adminProjects = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthState.GetAuthenticationStateAsync();
            _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(_userId))
            {
                _isLoading = false;
                return;
            }

            await LoadProjectsAsync();
            
            _currentProject = await ProjectContext.GetCurrentProjectAsync();
            _selectedProjectId = ProjectContext.CurrentProjectId;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading projects: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadProjectsAsync()
    {
        if (string.IsNullOrEmpty(_userId))
            return;

        _projects = await ProjectContext.GetUserProjectsAsync(_userId);
        
        // Pre-load admin status for each project
        foreach (var project in _projects)
        {
            _adminProjects[project.UID] = await ProjectContext.IsUserAdminInProjectAsync(_userId, project.UID);
        }
    }

    private void SelectProject(Guid projectId)
    {
        _selectedProjectId = projectId;
    }

    private async Task ConfirmSelection()
    {
        if (!_selectedProjectId.HasValue)
            return;

        try
        {
            await ProjectContext.SetCurrentProjectAsync(_selectedProjectId.Value);
            _currentProject = await ProjectContext.GetCurrentProjectAsync();
            
            // Force page refresh to update navigation and access
            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error setting project: {ex.Message}");
        }
    }

    private bool IsUserAdmin(Guid projectId)
    {
        return _adminProjects.TryGetValue(projectId, out var isAdmin) && isAdmin;
    }
}
