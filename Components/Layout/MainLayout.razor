@using Microsoft.AspNetCore.Authorization
@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager NavigationManager
@inject IGlobalDataService GlobalData
@inject NavigationManager MyNavigationManager


<div class="page">
    <div class="sidebar">
        <NavMenu/>
    </div>

    <main>
        <div class="top-row px-4">
            <div class="d-flex justify-content-between align-items-center w-100">
                <h5 class="mb-0 text-start">
                    @GlobalData.selectedPage
                </h5>

                <h5 class="mb-0 text-end">
                    @GlobalData.SelectedProject?.Tag (@GlobalData.SelectedProject?.TagDescription)
                </h5>
            </div>
        </div>

        <article class="content px-4">
            @Body
            
            <!-- Shared 3D Scene - below page content -->
            <SharedSceneHost @rendermode="InteractiveServer" 
                             CurrentPage="@_currentPage" 
                             ProjectId="@_currentProjectId"
                             Visible="@_show3D" />
        </article>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>
<div class="row float-left">
    <footer class="bg-light text-center text-lg-start">
        <div class="text-center p-1" style="background-color: rgba(0, 0, 0, 0.2);">
            © 2023 Copyright: Encompass Electrical
            <a class="text-dark" href="https://encompasselectrical.com/">Encompass - Electrical</a>
        </div>
    </footer>
</div>
@code {
    private string _currentPage = "";
    private string? _currentProjectId => GlobalData.SelectedProject?.UID.ToString();
    private bool _show3D = false;

    protected override void OnInitialized()
    {
        _currentPage = GetPageName(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
        
        // Subscribe to project changes
        GlobalData.OnProjectChanged += OnProjectChanged;
        
        // Subscribe to the Page Title change
        GlobalData.OnHeaderChanged += OnPageTitleChange;
        
        GlobalData.Show3D = false;
        
        Debug.WriteLine($"Page {MyNavigationManager.Uri} :: Selected Project : {GlobalData.SelectedProject?.Tag}");
    }
    
    protected override void OnParametersSet()
    {
        Console.WriteLine($"MainLayout.OnParametersSet - ProjectId: {_currentProjectId}");
    }
    
    
    private void OnProjectChanged()
    {
        Console.WriteLine($"MainLayout: Project changed to {_currentProjectId}");
        InvokeAsync(StateHasChanged);  // Must use InvokeAsync for thread safety
    }
    

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        _currentPage = GetPageName(e.Location);
        StateHasChanged();
    }
    
    private void OnPageTitleChange()
    {
        // This forces MainLayout to re-render
        
        Task.Delay(10); // Allow UI to update
        _show3D = GlobalData.Show3D;
        
        InvokeAsync(StateHasChanged);
    }

    private string GetPageName(string uri)
    {
        var path = new Uri(uri).AbsolutePath.ToLower();
        return path switch
        {
            "/loadlist" => "LoadList",
            "/segment" => "Segment",
            "/cable" => "Cable",
            _ => "Default"
        };
    }

    public void Dispose()
    {
        // Unsubscribe to prevent memory leaks
        NavigationManager.LocationChanged -= OnLocationChanged;
        GlobalData.OnProjectChanged -= OnProjectChanged;
        GlobalData.OnHeaderChanged -= OnPageTitleChange;
        
    }
}