@using System.Diagnostics
@using System.Globalization
@using System.Reflection
@using System.Text.Json
@using ElDesignApp.Models
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Rendering

@typeparam T

@inject NavigationManager MyNavigationManager
@inject IJSRuntime JSRuntime
@inject IDataRetrievalService DataService
@inject ITableService Table
@inject IGlobalDataService GlobalData
@inject IMyFunctionService MyFunction

@implements IAsyncDisposable

<h3>@Title</h3>
<div class="modal fade show" id="myModal" style="display:block; background-color: rgba(10,10,10,.8);" aria-modal="true"
     role="dialog" @onkeydown="@HandleModalKeyDown" tabindex="-1">
    <div class="modal-dialog my-custom-modal-dialog" @ref="_modalDialogElementRef">
        <div class="modal-content">
            <div class="modal-header" @onmousedown="@HandleHeaderMouseDown">
                <h5 class="modal-title">@Title</h5>
                <button type="button" class="close" @onclick="@ModalCancel" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                @if (_isLoading)
                {
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                }
                else if (Item is null)
                {
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> Properties for @typeof(T).Name : Item not available
                    </div>
                }
                else
                {
                    <p class="mb-3">
                        <strong>@typeof(T).Name</strong> 
                        @if (!string.IsNullOrEmpty(_tag))
                        {
                            <span class="badge bg-primary">@_tag</span>
                        }
                    </p>

                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-striped table-hover">
                            <thead class="sticky-top bg-light">
                            <tr>
                                <th style="width: 40%;">Property</th>
                                <th style="width: 60%;">Value</th>
                            </tr>
                            </thead>
                            <tbody>
                            @for (var i = 0; i < _tableProperties.Count; i++)
                            {
                                var property = _tableProperties[i];
                                if (_hideFieldList.Contains(property?.Name)) continue;

                                var field = _dbMaster.Find(list => list.FieldName == property?.Name);
                                var fieldDisplay = field?.DisplayFieldName ?? property?.Name ?? "Unknown";
                                var val = GetPropertyValueSafe(property, Item);
                                
                                <tr class="my-0">
                                    <td>
                                        <label for="input_@i" class="form-label mb-0">
                                            @fieldDisplay
                                            @if (IsPropertyRequired(property))
                                            {
                                                <span class="text-danger">*</span>
                                            }
                                        </label>
                                    </td>
                                    <td>
                                        @RenderInputField(property, val, i)
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                }

                @* Validation Messages *@
                <div class="row mt-3">
                    <div class="col">
                        @if (!string.IsNullOrEmpty(_errorMessage))
                        {
                            <div class="alert alert-danger" role="alert">
                                <strong>@_propertyDescription:</strong> @_errorMessage
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(_warningMessage))
                        {
                            <div class="alert alert-warning" role="alert">
                                <strong>@_propertyDescription:</strong> @_warningMessage
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(_infoMessage))
                        {
                            <div class="alert alert-info" role="alert">
                                <strong>@_propertyDescription:</strong> @_infoMessage
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(_successMessage))
                        {
                            <div class="alert alert-success" role="alert">
                                <strong>@_propertyDescription:</strong> @_successMessage
                            </div>
                        }
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="@ModalCancel">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button @ref="_okButton" type="button" class="btn btn-primary" @onclick="@ModalOk" disabled="@_hasValidationErrors">
                    <i class="bi bi-check-circle"></i> OK
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    #region Parameters
    
    [Parameter] public string? Title { get; set; } = "Edit Properties";
    [Parameter] public string? Text { get; set; }
    [Parameter] public T? Item { get; set; }
    [Parameter] public string[]? Fields { get; set; }
    [Parameter] public EventCallback<(string ItemJson, string Type, string OriginalTag, string CurrentTag, string Action)> OnClose { get; set; }
    
    #endregion

    #region Private Fields
    
    private ElementReference _modalDialogElementRef;
    private ElementReference _okButton;
    private string _type = string.Empty;
    private string? _itemJson;
    private T? _iterateItem;
    private T? _existingItem;
    private List<PropertyInfo> _tableProperties = new();
    private PropertyInfo? _tagProperty;
    private List<DBMaster> _dbMaster = new();
    private PropertyInfo? _currentProperty;
    private List<string> _sqlFieldsNames = new();
    
    private readonly string[] _disabledFieldList = 
    {
        "BfT", "BtT", "CblDesc", "CblDescA", "VdRA", "VdSA", "VdRM", "VdSM", 
        "UpdatedBy", "UpdatedOn", "CreatedBy", "CreatedOn", "UID", "RecordId"
    };
    
    private readonly string[] _hideFieldList = { "RecordId", "CellCSS" };
    
    private string _propertyDescription = string.Empty;
    private string _infoMessage = string.Empty;
    private string _successMessage = string.Empty;
    private string _warningMessage = string.Empty;
    private string _errorMessage = string.Empty;
    private bool _hasValidationErrors = false;
    private bool _isLoading = true;
    
    private string _tag = string.Empty;
    private readonly string _inputClass = "form-control";
    private readonly List<string> _inputClasses = new();
    
    // Editing state
    private PropertyInfo? _editingPropertyInfo;
    
    // Dragging state
    private DotNetObjectReference<ElementPropertyModal<T>> _dotNetHelper;
    private bool _isDragging = false;
    private int _offsetX, _offsetY;
    
    #endregion

    #region Lifecycle Methods
    
    protected override void OnInitialized()
    {
        try
        {
            InitializeProperties();
            InitializeItem();
            _isLoading = false;
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"OnInitialized Error: {ex.Message}");
            _errorMessage = $"Failed to initialize modal: {ex.Message}";
            _isLoading = false;
        }
        
        base.OnInitialized();
    }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get SQL field names
            _sqlFieldsNames = await Table.GetColumnNamesAsync(typeof(T).Name);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"OnInitializedAsync Error: {ex.Message}");
        }
    }
    

    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _okButton.Id != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("focusElement", _okButton);
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Focus error: {ex.Message}");
            }
        }
        
        await base.OnAfterRenderAsync(firstRender);
    }
    
    public async ValueTask DisposeAsync()
    {
        await DisposeDragHelper();
    }
    
    #endregion

    #region Initialization
    
    private void InitializeProperties()
    {
        _dbMaster = GlobalData?.DBMasters?.Where(m => m.DBName == typeof(T).Name).ToList() ?? new List<DBMaster>();
        
        // Determine which properties to display
        if (Fields?.Length > 0)
        {
            var allProperties = typeof(T).GetProperties().ToList();
            _tableProperties = allProperties
                .Where(p => Fields.Contains(p.Name))
                .OrderBy(p => Array.IndexOf(Fields, p.Name))
                .ToList();
        }
        else
        {
            var allProperties = typeof(T).GetProperties().ToList();
            var propsWithMetadata = allProperties
                .Where(p => _dbMaster.Any(db => db.FieldName == p.Name && db.Display))
                .ToList();
                
            if (propsWithMetadata.Any())
            {
                _tableProperties = propsWithMetadata
                    .OrderBy(p => _dbMaster.FirstOrDefault(db => db.FieldName == p.Name)?.FieldOrder ?? int.MaxValue)
                    .ToList();
            }
            else
            {
                _tableProperties = allProperties;
            }
        }
        
        // Initialize input classes
        _inputClasses.Clear();
        _tableProperties.ForEach(_ => _inputClasses.Add(_inputClass));
        

        
        // Get type and tag property
        _type = typeof(T).Name;
        _tagProperty = typeof(T).GetProperty("Tag");
    }
    
    private void InitializeItem()
    {
        if (Item == null) return;
        
        var jsonOptions = new JsonSerializerOptions { IncludeFields = true };
        
        try
        {
            _tag = _tagProperty?.GetValue(Item)?.ToString() ?? string.Empty;
            _iterateItem = JsonSerializer.Deserialize<T>(JsonSerializer.Serialize(Item, jsonOptions), jsonOptions);
            _existingItem = JsonSerializer.Deserialize<T>(JsonSerializer.Serialize(Item, jsonOptions), jsonOptions);
            _itemJson = JsonSerializer.Serialize(Item, jsonOptions);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"InitializeItem Error: {ex.Message}");
            throw new InvalidOperationException("Failed to initialize item copies", ex);
        }
    }
    
    #endregion

    #region Modal Actions
    
    private async Task ModalCancel()
    {
        try
        {
            ResetMessages();
            
            if (Item == null || _tagProperty == null)
            {
                await OnClose.InvokeAsync((string.Empty, string.Empty, string.Empty, string.Empty, "Cancel"));
                return;
            }
            
            var originalTag = _tag;
            var currentTag = _tagProperty.GetValue(Item)?.ToString() ?? string.Empty;
            await OnClose.InvokeAsync((_itemJson ?? string.Empty, _type, originalTag, currentTag, "Cancel"));
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"ModalCancel Error: {ex.Message}");
            _errorMessage = $"Error closing modal: {ex.Message}";
        }
    }
    
    private async Task ModalOk()
    {
        try
        {
            // Final validation before accepting
            if (!ValidateAllFields())
            {
                _errorMessage = "Please fix validation errors before saving.";
                return;
            }
            
            var jsonOptions = new JsonSerializerOptions { IncludeFields = true };
            
            if (Item == null || _tagProperty == null)
            {
                await OnClose.InvokeAsync((string.Empty, string.Empty, string.Empty, string.Empty, "Ok"));
                return;
            }
            
            var updatedJson = JsonSerializer.Serialize(Item, jsonOptions);
            var originalTag = _tag;
            var currentTag = _tagProperty.GetValue(Item)?.ToString() ?? string.Empty;
            
            await OnClose.InvokeAsync((updatedJson, _type, originalTag, currentTag, "Ok"));
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"ModalOk Error: {ex.Message}");
            _errorMessage = $"Error saving changes: {ex.Message}";
        }
    }
    
    #endregion

    #region Input Rendering
    
    private RenderFragment RenderInputField(PropertyInfo property, object? val, int index)
    {
        return builder =>
        {
            if (_disabledFieldList.Contains(property.Name))
            {
                // Read-only display
                builder.OpenElement(0, "span");
                builder.AddAttribute(1, "class", "form-control-plaintext");
                builder.AddContent(2, val?.ToString() ?? string.Empty);
                builder.CloseElement();
            }
            else
            {
                var propertyType = Nullable.GetUnderlyingType(property.PropertyType) ?? property.PropertyType;
                
                if (propertyType == typeof(string))
                {
                    RenderStringInput(builder, property, val, index);
                }
                else if (propertyType == typeof(float))
                {
                    RenderNumberInput<float>(builder, property, val, index, "number", "0.01");
                }
                else if (propertyType == typeof(double))
                {
                    RenderNumberInput<double>(builder, property, val, index, "number", "0.01");
                }
                else if (propertyType == typeof(int) || propertyType == typeof(long) || propertyType == typeof(short))
                {
                    RenderNumberInput<int>(builder, property, val, index, "number", "1", "0");
                }
                else if (propertyType == typeof(bool))
                {
                    RenderBooleanSelect(builder, property, val, index);
                }
                else if (propertyType == typeof(DateTime))
                {
                    RenderDateTimeInput(builder, property, val, index);
                }
                else
                {
                    // Unsupported type - display as text
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", "form-control-plaintext");
                    builder.AddContent(2, val?.ToString() ?? string.Empty);
                    builder.CloseElement();
                }
            }
        };
    }
    
    private void RenderStringInput(RenderTreeBuilder builder, PropertyInfo property, object? val, int index)
    {
        builder.OpenElement(0, "input");
        builder.AddAttribute(1, "type", "text");
        builder.AddAttribute(2, "class", _inputClasses[index]);
        builder.AddAttribute(3, "value", val?.ToString() ?? string.Empty);
        builder.AddAttribute(4, "id", $"input_{index}");
        builder.AddAttribute(5, "onselect", EventCallback.Factory.Create(this, () => PropertyUpdate(property)));
        builder.AddAttribute(6, "onclick", EventCallback.Factory.Create(this, () => PropertyUpdate(property)));
        builder.AddAttribute(7, "oninput", EventCallback.Factory.Create<ChangeEventArgs>(this, e => ValueAndValidationUpdate(e, property, val)));
        builder.AddAttribute(8, "onblur", EventCallback.Factory.Create(this, OnBlur));
        builder.AddAttribute(9, "onkeydown", EventCallback.Factory.Create<KeyboardEventArgs>(this, e => HandleInputKeyDown(e, property)));
        builder.CloseElement();
    }
    
    private void RenderNumberInput<TNumber>(RenderTreeBuilder builder, PropertyInfo property, object? val, int index, string inputType, string step, string? min = null)
    {
        builder.OpenElement(0, "input");
        builder.AddAttribute(1, "type", inputType);
        builder.AddAttribute(2, "class", "form-control");
        builder.AddAttribute(3, "value", val?.ToString() ?? "0");
        builder.AddAttribute(4, "step", step);
        if (min != null) builder.AddAttribute(5, "min", min);
        builder.AddAttribute(6, "id", $"input_{index}");
        builder.AddAttribute(7, "onclick", EventCallback.Factory.Create(this, () => PropertyUpdate(property)));
        builder.AddAttribute(8, "oninput", EventCallback.Factory.Create<ChangeEventArgs>(this, e => ValueAndValidationUpdate(e, property, val)));
        builder.AddAttribute(9, "onblur", EventCallback.Factory.Create(this, OnBlur));
        builder.AddAttribute(10, "onkeydown", EventCallback.Factory.Create<KeyboardEventArgs>(this, e => HandleInputKeyDown(e, property)));
        builder.CloseElement();
    }
    
    private void RenderBooleanSelect(RenderTreeBuilder builder, PropertyInfo property, object? val, int index)
    {
        var isNullable = Nullable.GetUnderlyingType(property.PropertyType) != null;
        var boolValue = val as bool?;
        
        builder.OpenElement(0, "select");
        builder.AddAttribute(1, "class", "form-select");
        builder.AddAttribute(2, "id", $"input_{index}");
        builder.AddAttribute(3, "onclick", EventCallback.Factory.Create(this, () => PropertyUpdate(property)));
        builder.AddAttribute(4, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e => ValueAndValidationUpdate(e, property, val)));
        builder.AddAttribute(5, "onblur", EventCallback.Factory.Create(this, OnBlur));
        
        // Yes option
        builder.OpenElement(6, "option");
        builder.AddAttribute(7, "value", "true");
        if (boolValue == true) builder.AddAttribute(8, "selected", "selected");
        builder.AddContent(9, "Yes");
        builder.CloseElement();
        
        // No option
        builder.OpenElement(10, "option");
        builder.AddAttribute(11, "value", "false");
        if (boolValue == false) builder.AddAttribute(12, "selected", "selected");
        builder.AddContent(13, "No");
        builder.CloseElement();
        
        // Nullable option
        if (isNullable)
        {
            builder.OpenElement(14, "option");
            builder.AddAttribute(15, "value", "null");
            if (boolValue == null) builder.AddAttribute(16, "selected", "selected");
            builder.AddContent(17, "Not Applicable");
            builder.CloseElement();
        }
        
        builder.CloseElement();
    }
    
    private void RenderDateTimeInput(RenderTreeBuilder builder, PropertyInfo property, object? val, int index)
    {
        var dateValue = val as DateTime?;
        var dateString = dateValue?.ToString("yyyy-MM-ddTHH:mm") ?? string.Empty;
        
        builder.OpenElement(0, "input");
        builder.AddAttribute(1, "type", "datetime-local");
        builder.AddAttribute(2, "class", "form-control");
        builder.AddAttribute(3, "value", dateString);
        builder.AddAttribute(4, "id", $"input_{index}");
        builder.AddAttribute(5, "onclick", EventCallback.Factory.Create(this, () => PropertyUpdate(property)));
        builder.AddAttribute(6, "oninput", EventCallback.Factory.Create<ChangeEventArgs>(this, e => ValueAndValidationUpdate(e, property, val)));
        builder.AddAttribute(7, "onblur", EventCallback.Factory.Create(this, OnBlur));
        builder.CloseElement();
    }
    
    #endregion

    #region Property Updates and Validation
    
    private void PropertyUpdate(PropertyInfo? property)
    {
        if (property == null) return;
        
        try
        {
            _editingPropertyInfo = property;
            var field = _dbMaster.Find(m => m.FieldName == property.Name);
            _propertyDescription = field?.DisplayFieldName ?? property.Name;
            
            if (_tableProperties.Contains(property))
            {
                var index = _tableProperties.IndexOf(property);
                _inputClasses[index] = GetInputClass(Item, property);
            }
            
            Debug.WriteLine($"Property '{property.Name}' ({_propertyDescription}) selected for editing");
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"PropertyUpdate Error: {ex.Message}");
        }
    }
    
    private void ValueAndValidationUpdate(ChangeEventArgs e, PropertyInfo? property, object? originalValue)
    {
        if (property == null || Item == null) return;
        
        try
        {
            var propertyType = Nullable.GetUnderlyingType(property.PropertyType) ?? property.PropertyType;
            var newValue = e?.Value?.ToString();
            
            object? convertedValue = ConvertValue(newValue, propertyType, originalValue);
            
            if (convertedValue != null || Nullable.GetUnderlyingType(property.PropertyType) != null)
            {
                property.SetValue(Item, convertedValue);
            }
            
            // UpdateParentCallback CSS class based on validation
            if (_tableProperties.Contains(property))
            {
                var index = _tableProperties.IndexOf(property);
                _inputClasses[index] = GetInputClass(Item, property);
            }
            
            // Check if there are any validation errors
            UpdateValidationState();
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"ValueAndValidationUpdate Error: {ex.Message}");
            _errorMessage = $"Error updating value: {ex.Message}";
        }
    }
    
    private object? ConvertValue(string? input, Type targetType, object? fallbackValue)
    {
        if (string.IsNullOrWhiteSpace(input))
        {
            return Nullable.GetUnderlyingType(targetType) != null ? null : fallbackValue;
        }
        
        try
        {
            if (targetType == typeof(string))
                return input;
            if (targetType == typeof(int))
                return int.TryParse(input, out var i) ? i : fallbackValue;
            if (targetType == typeof(float))
                return float.TryParse(input, NumberStyles.Float, CultureInfo.InvariantCulture, out var f) ? f : fallbackValue;
            if (targetType == typeof(double))
                return double.TryParse(input, NumberStyles.Float, CultureInfo.InvariantCulture, out var d) ? d : fallbackValue;
            if (targetType == typeof(long))
                return long.TryParse(input, out var l) ? l : fallbackValue;
            if (targetType == typeof(short))
                return short.TryParse(input, out var s) ? s : fallbackValue;
            if (targetType == typeof(bool))
            {
                if (input.Equals("null", StringComparison.OrdinalIgnoreCase)) return null;
                return bool.TryParse(input, out var b) ? b : fallbackValue;
            }
            if (targetType == typeof(DateTime))
                return DateTime.TryParse(input, CultureInfo.InvariantCulture, DateTimeStyles.None, out var dt) ? dt : fallbackValue;
            
            return Convert.ChangeType(input, targetType, CultureInfo.InvariantCulture);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"ConvertValue Error: {ex.Message}");
            return fallbackValue;
        }
    }
    
    private string GetInputClass(T? item, PropertyInfo? property)
    {
        var baseClass = "form-control ";
        
        if (property == null || item == null)
            return baseClass;
        
        try
        {
            var validatedInput = MyFunction.ValidateGeneralInput(item, property, new List<T> { item }, new List<T> { item });
            
            _infoMessage = validatedInput.Item2[0];
            _successMessage = validatedInput.Item2[1];
            _warningMessage = validatedInput.Item2[2];
            _errorMessage = validatedInput.Item2[3];
            
            if (!string.IsNullOrEmpty(_errorMessage))
                return baseClass + "border-danger is-invalid";
            if (!string.IsNullOrEmpty(_warningMessage))
                return baseClass + "border-warning";
            if (!string.IsNullOrEmpty(_successMessage))
                return baseClass + "border-success is-valid";
            
            return baseClass + "border-info";
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"GetInputClass Error: {ex.Message}");
            return baseClass;
        }
    }
    
    private bool ValidateAllFields()
    {
        if (Item == null) return false;
        
        try
        {
            var hasErrors = false;
            
            foreach (var property in _tableProperties)
            {
                if (_disabledFieldList.Contains(property.Name))
                    continue;
                
                var validatedInput = MyFunction.ValidateGeneralInput(Item, property, new List<T> { Item }, new List<T> { Item });
                
                if (!string.IsNullOrEmpty(validatedInput.Item2[3])) // Error message
                {
                    hasErrors = true;
                    Debug.WriteLine($"Validation error on {property.Name}: {validatedInput.Item2[3]}");
                }
            }
            
            return !hasErrors;
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"ValidateAllFields Error: {ex.Message}");
            return false;
        }
    }
    
    private void UpdateValidationState()
    {
        _hasValidationErrors = !string.IsNullOrEmpty(_errorMessage);
    }
    
    #endregion

    #region Keyboard Handling
    
    private async Task HandleModalKeyDown(KeyboardEventArgs e)
    {
        try
        {
            if (e.Key == "Enter" && !_hasValidationErrors)
            {
                Debug.WriteLine("Modal: Enter key pressed - triggering OK");
                await ModalOk();
            }
            else if (e.Key == "Escape")
            {
                Debug.WriteLine("Modal: Escape key pressed - triggering Cancel");
                
                // Reset current editing field if any
                if (_editingPropertyInfo != null && Item != null && _existingItem != null)
                {
                    var originalValue = _editingPropertyInfo.GetValue(_existingItem);
                    _editingPropertyInfo.SetValue(Item, originalValue);
                    
                    if (_tableProperties.Contains(_editingPropertyInfo))
                    {
                        var index = _tableProperties.IndexOf(_editingPropertyInfo);
                        _inputClasses[index] = GetInputClass(Item, _editingPropertyInfo);
                    }
                }
                
                await ModalCancel();
            }
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"HandleModalKeyDown Error: {ex.Message}");
        }
    }
    
    private async Task HandleInputKeyDown(KeyboardEventArgs e, PropertyInfo property)
    {
        try
        {
            if (e.Key == "Enter")
            {
                Debug.WriteLine($"Enter pressed on {property.Name}");
                await JSRuntime.InvokeVoidAsync("blurActiveElement");
            }
            else if (e.Key == "Escape")
            {
                Debug.WriteLine($"Escape pressed on {property.Name} - resetting to original value");
                
                if (Item != null && _existingItem != null)
                {
                    var originalValue = property.GetValue(_existingItem);
                    property.SetValue(Item, originalValue);
                    
                    if (_tableProperties.Contains(property))
                    {
                        var index = _tableProperties.IndexOf(property);
                        _inputClasses[index] = GetInputClass(Item, property);
                    }
                    
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"HandleInputKeyDown Error: {ex.Message}");
        }
    }
    
    private void OnBlur()
    {
        if (_editingPropertyInfo == null || Item == null || _existingItem == null)
            return;
        
        try
        {
            var currentValue = _editingPropertyInfo.GetValue(Item);
            var originalValue = _editingPropertyInfo.GetValue(_existingItem);
            
            Debug.WriteLine($"OnBlur: Property '{_propertyDescription} [{_editingPropertyInfo.Name}]' " +
                          $"changed from '{originalValue}' to '{currentValue}'");
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"OnBlur Error: {ex.Message}");
        }
    }
    
    #endregion

    #region Modal Dragging
    
    private async Task HandleHeaderMouseDown(MouseEventArgs e)
    {
        try
        {
            Debug.WriteLine($"HandleHeaderMouseDown triggered at {DateTime.Now}");
            
            _isDragging = true;
            
            var modalDialogRect = await JSRuntime.InvokeAsync<BoundingClientRect>("getModalDialogRect", _modalDialogElementRef);
            
            if (modalDialogRect != null)
            {
                _offsetX = (int)e.ClientX - (int)modalDialogRect.left;
                _offsetY = (int)e.ClientY - (int)modalDialogRect.top;
            }
            
            _dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("startModalDrag", _dotNetHelper, _modalDialogElementRef);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"HandleHeaderMouseDown Error: {ex.Message}");
        }
    }
    
    [JSInvokable]
    public async Task HandleMouseMove(int clientX, int clientY)
    {
        if (!_isDragging) return;
        
        try
        {
            int newX = clientX - _offsetX;
            int newY = clientY - _offsetY;
            
            await JSRuntime.InvokeVoidAsync("setModalPosition", newX, newY);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"HandleMouseMove Error: {ex.Message}");
        }
    }
    
    [JSInvokable]
    public async Task HandleMouseUp()
    {
        _isDragging = false;
        await DisposeDragHelper();
    }
    
    private async Task DisposeDragHelper()
    {
        if (_dotNetHelper != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("stopModalDrag");
                _dotNetHelper.Dispose();
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"DisposeDragHelper Error: {ex.Message}");
            }
            finally
            {
                _dotNetHelper = null;
            }
        }
    }
    
    #endregion

    #region Helper Methods
    
    private object? GetPropertyValueSafe(PropertyInfo? property, T? item)
    {
        if (property == null || item == null)
            return null;
        
        try
        {
            return property.GetValue(item) ?? string.Empty;
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"GetPropertyValueSafe Error for {property.Name}: {ex.Message}");
            return string.Empty;
        }
    }
    
    private bool IsPropertyRequired(PropertyInfo? property)
    {
        if (property == null) return false;
        
        try
        {
            return property.GetCustomAttribute<RequiredAttribute>() != null;
        }
        catch
        {
            return false;
        }
    }
    
    private void ResetMessages()
    {
        _infoMessage = string.Empty;
        _successMessage = string.Empty;
        _warningMessage = string.Empty;
        _errorMessage = string.Empty;
        _hasValidationErrors = false;
    }
    
    #endregion

    #region Helper Classes
    
    public class BoundingClientRect
    {
        public double x { get; set; }
        public double y { get; set; }
        public double width { get; set; }
        public double height { get; set; }
        public double top { get; set; }
        public double right { get; set; }
        public double bottom { get; set; }
        public double left { get; set; }
    }
    
    #endregion
}
