@* UserRoleAssignmentModal.razor - FULLY CORRECTED *@
@using System.Text.Json
@using Microsoft.AspNetCore.Identity
@inject ITableService Table
@inject IJSRuntime JS
@inject UserManager<ApplicationUser> UserManager
@inject IDataRetrievalService DataRetrievalService
@inject AuthenticationStateProvider AuthenticationStateProvider

@rendermode InteractiveServer

<div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.6);" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-check-fill"></i> User Role Assignment - @ProjectName
                </h5>
                <button type="button" class="btn-close" @onclick="@(() => Close())"></button>
            </div>
            
            <div class="modal-body">
                @if (_isLoading)
                {
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Assignment Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Assign Role to User</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Select User <span class="text-danger">*</span></label>
                                    <select class="form-select" @bind="_selectedUserId" disabled="@_isEditing">
                                        <option value="">-- Choose User --</option>
                                        @foreach (var user in _projectUsers)
                                        {
                                            <option value="@user.UserId">@GetUserDisplayName(user)</option>
                                        }
                                    </select>
                                    @if (_isEditing && _editingAssignment != null)
                                    {
                                        <small class="text-muted">Editing: @GetUserNameById(_editingAssignment.UserId)</small>
                                    }
                                </div>
    
                                <div class="col-md-4">
                                    <label class="form-label">Select Role <span class="text-danger">*</span></label>
                                    <select class="form-select" @bind="_selectedRoleId" disabled="@(string.IsNullOrEmpty(_selectedUserId) && !_isEditing)">
                                        <option value="">-- Choose Role --</option>
                                        @foreach (var role in _availableRoles)
                                        {
                                            <option value="@role.UID.ToString()">@role.CustomRoleName</option>
                                        }
                                    </select>
                                </div>
    
                                <div class="col-md-4 d-flex align-items-end gap-2">
                                    @if (_isEditing)
                                    {
                                        <button class="btn btn-success flex-fill" 
                                                @onclick="@(() => SaveEdit())">
                                                <i class="bi bi-check-circle"></i> Update
                                        </button>
                                        <button class="btn btn-secondary flex-fill"
                                                @onclick="@(() => CancelEdit())">
                                            <i class="bi bi-x-circle"></i> Cancel
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-success w-100" 
                                                @onclick="@(() => AssignRole())"
                                                disabled="@(string.IsNullOrEmpty(_selectedUserId) || string.IsNullOrEmpty(_selectedRoleId))">
                                            <i class="bi bi-check-circle"></i> Assign Role
                                        </button>
                                    }
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(_assignmentMessage))
                            {
                                <div class="alert @(_assignmentSuccess ? "alert-success" : "alert-danger") mt-3 mb-0">
                                    @_assignmentMessage
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Current Assignments Section -->
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="bi bi-list-check"></i> Current Role Assignments</h6>
                        </div>
                        <div class="card-body">
                            @if (!_userRoleAssignments.Any())
                            {
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i> No role assignments found for this project.
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover table-striped">
                                        <thead class="table-light">
                                            <tr>
                                                <th>User Name</th>
                                                <th>Custom Role</th>
                                                <th>Hard Roles</th>
                                                <th>Assigned On</th>
                                                <th>Assigned By</th>
                                                <th style="width: 150px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (ProjectUserRole assignment in _userRoleAssignments.OrderBy(a => GetUserNameById(a.UserId)))
                                            {
                                                var roleMapping = _availableRoles.FirstOrDefault(r => r.CustomRoleName == assignment.CustomRoleName);
        
                                                <tr>
                                                    <td>
                                                        <strong>@GetUserNameById(assignment.UserId)</strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">@assignment.CustomRoleName</span>
                                                    </td>
                                                    <td>
                                                        @if (roleMapping != null)
                                                        {
                                                            var hardRoles = GetHardRoles(roleMapping);
                                                            @foreach (var hardRole in hardRoles)
                                                            {
                                                                var badgeClass = hardRole switch
                                                                {
                                                                    "SuperAdmin" => "bg-danger",
                                                                    "Admin" => "bg-warning text-dark",
                                                                    "User" => "bg-info",
                                                                    "Report" => "bg-secondary",
                                                                    "Guest" => "bg-light text-dark",
                                                                    _ => "bg-secondary"
                                                                };
                                                                <span class="badge @badgeClass me-1">@hardRole</span>
                                                            }
                                                        }
                                                    </td>
                                                    <td>
                                                        @assignment.AssignedOn.ToString("dd-MMM-yyyy HH:mm")
                                                    </td>
                                                    <td>@GetUserNameById(assignment.AssignedBy)</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                                @onclick="@(() => EditAssignment(assignment))">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" 
                                                                @onclick="@(() => RemoveAssignment(assignment))">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="@(() => Close())">
                    <i class="bi bi-x-circle"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string ProjectId { get; set; } = string.Empty;
    [Parameter] public string ProjectName { get; set; } = string.Empty;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnAssignmentChanged { get; set; }

    private bool _isLoading = true;
    private bool _isEditing = false;
    private ProjectUserRole? _editingAssignment = null;
    
    private string _currentUserId = string.Empty;
    private string _selectedUserId = string.Empty;
    private string _selectedRoleId = string.Empty;
    private string _assignmentMessage = string.Empty;
    private bool _assignmentSuccess = false;

    private List<ProjectUserAssignment> _projectUsers = new();
    private List<RoleMapping> _availableRoles = new();
    private List<ProjectUserRole> _userRoleAssignments = new();
    private Dictionary<string, string> _userNames = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get current user ID
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            _currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
            
            await LoadData();
        }
        finally
        {
            _isLoading = false;
        }
    }

private async Task LoadData()
{
    try
    {
        Console.WriteLine($"=== LoadData START for ProjectId: {ProjectId} ===");
        
        Guid projectGuid = Guid.Parse(ProjectId);
        
        // Load users assigned to this project
        var allUsers = await Table.GetListAsync<ProjectUserAssignment>(ProjectId) ?? new();
        var projectUserAssignments = allUsers
            .Where(u => u.ProjectId == projectGuid && u.IsActive)
            .ToList();
        
        Console.WriteLine($"Found {projectUserAssignments.Count} user assignments in project");

        // Collect users to exclude
        var excludedUserIds = new HashSet<string>();
        
        // 1. Exclude current user (can't assign roles to themselves)
        if (!string.IsNullOrEmpty(_currentUserId))
        {
            excludedUserIds.Add(_currentUserId);
            Console.WriteLine($"Excluding current user: {_currentUserId}");
        }
        
        // 2. Exclude users who are ProjectAdmin in this project
        var projectAdminUserIds = projectUserAssignments
            .Where(pa => pa.IsProjectAdmin)
            .Select(pa => pa.UserId)
            .ToList();
        
        foreach (var adminUserId in projectAdminUserIds)
        {
            excludedUserIds.Add(adminUserId);
            Console.WriteLine($"Excluding ProjectAdmin: {adminUserId}");
        }
        
        // Load user details and filter SuperAdmins + excluded users
        var userIdsInProject = projectUserAssignments.Select(u => u.UserId).Distinct().ToList();
        _userNames.Clear();
        
        foreach (var userId in userIdsInProject)
        {
            if (excludedUserIds.Contains(userId))
            {
                // Skip this user, but still load their name for display in "Assigned By" column
                var excludedUser = await UserManager.FindByIdAsync(userId);
                if (excludedUser != null)
                {
                    _userNames[userId] = excludedUser.UserName ?? excludedUser.Email ?? "Unknown";
                }
                continue;
            }
            
            var user = await UserManager.FindByIdAsync(userId);
            if (user != null)
            {
                var roles = await UserManager.GetRolesAsync(user);
                
                // 3. Exclude SuperAdmin (identity role)
                if (roles.Contains("SuperAdmin", StringComparer.OrdinalIgnoreCase))
                {
                    excludedUserIds.Add(userId);
                    _userNames[userId] = user.UserName ?? user.Email ?? "Unknown"; // Keep name for display
                    Console.WriteLine($"Excluding SuperAdmin: {user.UserName}");
                }
                else
                {
                    // This user is eligible for role assignment
                    _userNames[userId] = user.UserName ?? user.Email ?? "Unknown";
                }
            }
        }
        
        // Filter out all excluded users from project users list
        _projectUsers = projectUserAssignments
            .Where(u => !excludedUserIds.Contains(u.UserId))
            .ToList();
        
        Console.WriteLine($"After exclusions: {_projectUsers.Count} users available for assignment");

        // Load role mappings
        var allRoleMappings = await Table.GetListAsync<RoleMapping>(ProjectId) ?? new();
        _availableRoles = allRoleMappings
            .Where(r => r.IsActive && r.ProjectId == projectGuid)
            .ToList();
        
        Console.WriteLine($"Found {_availableRoles.Count} roles for project");

        // Load role assignments (excluding all excluded users)
        var allAssignments = await Table.GetListAsync<ProjectUserRole>(ProjectId) ?? new();
        _userRoleAssignments = allAssignments
            .Where(a => a.ProjectId == projectGuid && 
                       a.IsActive && 
                       !excludedUserIds.Contains(a.UserId))
            .ToList();
        
        Console.WriteLine($"Found {_userRoleAssignments.Count} role assignments (excluding admins)");

        // Load names for users in AssignedBy column (if not already loaded)
        var additionalUserIds = _userRoleAssignments
            .Select(a => a.AssignedBy)
            .Distinct()
            .Where(id => !_userNames.ContainsKey(id))
            .ToList();
        
        foreach (var userId in additionalUserIds)
        {
            var user = await UserManager.FindByIdAsync(userId);
            if (user != null)
            {
                _userNames[userId] = user.UserName ?? user.Email ?? "Unknown";
            }
        }

        // Filter out users who already have role assignments
        var assignedUserIds = _userRoleAssignments.Select(a => a.UserId).Distinct().ToList();
        _projectUsers = _projectUsers
            .Where(u => !assignedUserIds.Contains(u.UserId))
            .ToList();
        
        Console.WriteLine($"Final available users for assignment: {_projectUsers.Count}");
        Console.WriteLine("=== LoadData END ===");
    }
    catch (Exception ex)
    {
        await JS.InvokeVoidAsync("alert", $"Error loading data: {ex.Message}");
        Console.WriteLine($"LoadData Error: {ex}");
    }
}

    private async Task LoadUserNamesFromIdentity()
    {
        _userNames.Clear();
        
        var allUserIds = _projectUsers.Select(u => u.UserId)
            .Concat(_userRoleAssignments.Select(a => a.UserId))
            .Concat(_userRoleAssignments.Select(a => a.AssignedBy))
            .Distinct()
            .ToList();

        foreach (var userId in allUserIds)
        {
            if (!string.IsNullOrEmpty(userId))
            {
                var user = await UserManager.FindByIdAsync(userId);
                if (user != null)
                {
                    _userNames[userId] = user.UserName ?? user.Email ?? "Unknown";
                }
            }
        }
    }

    private string GetUserDisplayName(ProjectUserAssignment userAssignment)
    {
        return GetUserNameById(userAssignment.UserId);
    }

    private string GetUserNameById(string userId)
    {
        return _userNames.TryGetValue(userId, out var name) ? name : "Unknown User";
    }

    private List<string> GetHardRoles(RoleMapping roleMapping)
    {
        try
        {
            if (string.IsNullOrEmpty(roleMapping.MappedHardRoles))
                return new List<string>();
                
            var roles = System.Text.Json.JsonSerializer.Deserialize<List<string>>(roleMapping.MappedHardRoles);
            return roles ?? new List<string>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deserializing hard roles: {ex.Message}");
            return new List<string>();
        }
    }

    private async Task AssignRole()
    {
        try
        {
            if (string.IsNullOrEmpty(_selectedUserId) || string.IsNullOrEmpty(_selectedRoleId))
            {
                await JS.InvokeVoidAsync("alert", "Please select both user and role");
                return;
            }

            var selectedRole = _availableRoles.FirstOrDefault(r => r.UID.ToString() == _selectedRoleId);
            if (selectedRole == null)
            {
                await JS.InvokeVoidAsync("alert", "Invalid role selected");
                return;
            }

            // Check for duplicates
            var exists = _userRoleAssignments.Any(a => 
                a.UserId == _selectedUserId && 
                a.CustomRoleName == selectedRole.CustomRoleName &&
                a.IsActive);
            
            if (exists)
            {
                await JS.InvokeVoidAsync("alert", "User already has this role!");
                return;
            }

            // CREATE THE ASSIGNMENT
            var newAssignment = new ProjectUserRole
            {
                UID = Guid.NewGuid(),
                ProjectId = Guid.Parse(ProjectId),
                UserId = _selectedUserId,
                CustomRoleName = selectedRole.CustomRoleName,
                AssignedBy = _currentUserId,
                AssignedOn = DateTime.Now,
                IsActive = true
            };

            Console.WriteLine($"=== SAVING ROLE ASSIGNMENT ===");
            Console.WriteLine($"UserId: {newAssignment.UserId}");
            Console.WriteLine($"ProjectId: {newAssignment.ProjectId}");
            Console.WriteLine($"CustomRoleName: {newAssignment.CustomRoleName}");
            Console.WriteLine($"AssignedBy: {newAssignment.AssignedBy}");
            
            int rowsAffected = await Table.InsertAsync(newAssignment);
            
            Console.WriteLine($"Rows affected: {rowsAffected}");
            Console.WriteLine($"=== END SAVE ===");
            
            if (rowsAffected > 0)
            {
                _assignmentMessage = $"Role '{selectedRole.CustomRoleName}' assigned successfully!";
                _assignmentSuccess = true;
                
                // Clear cache
                await ClearCacheForTable("ProjectUserRole");
                
                // Reset selections
                _selectedUserId = string.Empty;
                _selectedRoleId = string.Empty;
                
                // Reload data
                await LoadData();
                
                // Notify parent
                if (OnAssignmentChanged.HasDelegate)
                {
                    await OnAssignmentChanged.InvokeAsync();
                }
                
                StateHasChanged();
                
                // Clear message after 3 seconds
                await Task.Delay(3000);
                _assignmentMessage = string.Empty;
            }
            else
            {
                _assignmentMessage = "Failed to assign role - no rows affected";
                _assignmentSuccess = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"!!! ERROR assigning role !!!");
            Console.WriteLine($"Message: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            _assignmentMessage = $"Error: {ex.Message}";
            _assignmentSuccess = false;
        }
    }

    private async Task RemoveAssignment(ProjectUserRole assignment)
    {
        var userName = GetUserNameById(assignment.UserId);
        
        var confirmed = await JS.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to remove role '{assignment.CustomRoleName}' from user '{userName}'?\n\n" +
            $"This will affect their access permissions.");
        
        if (!confirmed) return;

        try
        {
            // Soft delete by setting IsActive to false
            assignment.IsActive = false;
            assignment.RemovedBy = _currentUserId;
            assignment.RemovedOn = DateTime.Now;
            
            // Update with all changed fields
            await Table.UpdateFieldsAsync(
                assignment, 
                "IsActive", 
                "RemovedBy", 
                "RemovedOn");
            
            // Clear cache
            await ClearCacheForTable("ProjectUserRole");

            _assignmentMessage = $"Role '{assignment.CustomRoleName}' removed successfully from user '{userName}'";
            _assignmentSuccess = true;

            // Reload assignments
            await LoadData();
            
            // Notify parent
            if (OnAssignmentChanged.HasDelegate)
            {
                await OnAssignmentChanged.InvokeAsync();
            }
            
            await InvokeAsync(StateHasChanged);
            
            // Clear message after 3 seconds
            await Task.Delay(3000);
            _assignmentMessage = string.Empty;
        }
        catch (Exception ex)
        {
            _assignmentMessage = $"Error removing assignment: {ex.Message}";
            _assignmentSuccess = false;
            Console.WriteLine($"RemoveAssignment Error: {ex}");
        }
    }

    private void EditAssignment(ProjectUserRole assignment)
    {
        _isEditing = true;
        _editingAssignment = assignment;
        _selectedUserId = assignment.UserId;
        
        // Find the role by CustomRoleName
        var role = _availableRoles.FirstOrDefault(r => r.CustomRoleName == assignment.CustomRoleName);
        _selectedRoleId = role?.UID.ToString() ?? string.Empty;
        
        StateHasChanged();
    }

    private void CancelEdit()
    {
        _isEditing = false;
        _editingAssignment = null;
        _selectedUserId = string.Empty;
        _selectedRoleId = string.Empty;
        StateHasChanged();
    }

    private async Task SaveEdit()
    {
        if (_editingAssignment == null) return;

        _assignmentMessage = string.Empty;
        _assignmentSuccess = false;

        if (string.IsNullOrEmpty(_selectedRoleId))
        {
            _assignmentMessage = "Please select a role";
            return;
        }

        try
        {
            var selectedRole = _availableRoles.FirstOrDefault(r => r.UID.ToString() == _selectedRoleId);
            if (selectedRole == null)
            {
                _assignmentMessage = "Invalid role selection";
                return;
            }

            // Check if role changed
            if (_editingAssignment.CustomRoleName == selectedRole.CustomRoleName)
            {
                _assignmentMessage = "No changes detected";
                CancelEdit();
                return;
            }

            // Update the assignment
            _editingAssignment.CustomRoleName = selectedRole.CustomRoleName;

            await Table.UpdateFieldsAsync(_editingAssignment, "CustomRoleName");

            _assignmentMessage = $"Role updated successfully to '{selectedRole.CustomRoleName}'";
            _assignmentSuccess = true;

            // Clear cache to ensure fresh data
            await ClearCacheForTable("ProjectUserRole");

            CancelEdit();
            await LoadData();
            
            if (OnAssignmentChanged.HasDelegate)
            {
                await OnAssignmentChanged.InvokeAsync();
            }
            
            await InvokeAsync(StateHasChanged);
            
            // Clear message after 3 seconds
            await Task.Delay(3000);
            _assignmentMessage = string.Empty;
        }
        catch (Exception ex)
        {
            _assignmentMessage = $"Error updating role: {ex.Message}";
            _assignmentSuccess = false;
        }
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
    
    private async Task ClearCacheForTable(string tableName)
    {
        try
        {
            // Force cache invalidation
            await DataRetrievalService.InvalidateCacheAsync(tableName);
            Console.WriteLine($"Cache cleared for {tableName}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error clearing cache: {ex.Message}");
        }
    }
}
